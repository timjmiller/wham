<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ex 4: Selectivity with time- and age-varying random effects • wham</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Ex 4: Selectivity with time- and age-varying random effects">
<meta property="og:description" content="wham">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wham</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.9.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fas fa-book fa-lg"></span>
     
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/index.html">Overview</a>
    </li>
    <li>
      <a href="../articles/ex01_basics.html">Ex 1: The basics</a>
    </li>
    <li>
      <a href="../articles/ex02_CPI_recruitment.html">Ex 2: Recruitment linked to an environmental covariate (Cold Pool Index)</a>
    </li>
    <li>
      <a href="../articles/ex03_projections.html">Ex 3: Projecting / forecasting random effects</a>
    </li>
    <li>
      <a href="../articles/ex4_selectivity.html">Ex 4: Selectivity with time- and age-varying random effects</a>
    </li>
    <li>
      <a href="../articles/ex05_GSI_M.html">Ex 5: Time-varying natural mortality linked to the Gulf Stream Index</a>
    </li>
    <li>
      <a href="../articles/ex06_NAA.html">Ex 6: Numbers-at-age / survival deviations as random effects</a>
    </li>
    <li>
      <a href="../articles/ex07_debug.html">Ex 7: Debugging WHAM models</a>
    </li>
    <li>
      <a href="../articles/ex08_compare.html">Ex 8: Compare ASAP and WHAM model results</a>
    </li>
    <li>
      <a href="../articles/ex09_retro_pred.html">Ex 9: Retrospective predictions</a>
    </li>
    <li>
      <a href="../articles/ex10_simulation.html">Ex 10: Simulations</a>
    </li>
    <li>
      <a href="../articles/ex11_catchability.html">Ex 11: Catchability configurations</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="far fa-file-code fa-lg"></span>
     
    Functions
  </a>
</li>
<li>
  <a href="https://github.com/timjmiller/wham/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
    Source code
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fas fa-bullhorn fa-lg"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/timjmiller/wham/issues/" class="external-link">
    <span class="fas fa-question-circle fa-lg"></span>
     
    Issues
  </a>
</li>
<li>
  <a href="https://www.fisheries.noaa.gov/contact/timothy-miller-phd" class="external-link">
    <span class="fas fa-paper-plane fa-lg"></span>
     
    Contact
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ex 4: Selectivity with time- and age-varying
random effects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/timjmiller/wham/blob/HEAD/vignettes/ex04_selectivity.Rmd" class="external-link"><code>vignettes/ex04_selectivity.Rmd</code></a></small>
      <div class="hidden name"><code>ex04_selectivity.Rmd</code></div>

    </div>

    
    
<p>In this vignette we walk through an example using the
<code>wham</code> (WHAM = Woods Hole Assessment Model) package to run a
state-space age-structured stock assessment model. WHAM is a
generalization of code written for <a href="https://doi.org/10.1139/cjfas-2015-0339" class="external-link">Miller et al. (2016)</a>
and <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/fog.12236" class="external-link">Xu et
al. (2018)</a>, and in this example we apply WHAM to the same stock,
Southern New England / Mid-Atlantic Yellowtail Flounder.</p>
<p>Here we assume you already have <code>wham</code> installed. If not,
see the <a href="https://timjmiller.github.io/wham/">Introduction</a>.
This is the 4th <code>wham</code> example, which builds off model
<code>m4</code> from <a href="https://timjmiller.github.io/wham/articles/ex1_basics.html">example
1</a>:</p>
<ul>
<li><p>full state-space model (numbers-at-age are random effects for all
ages, <code>NAA_re = list(sigma='rec+1',cor='iid')</code>)</p></li>
<li><p>logistic normal age compositions, treating observations of zero
as missing (<code>age_comp = "logistic-normal-miss0"</code>)</p></li>
<li><p>random-about-mean recruitment
(<code>recruit_model = 2</code>)</p></li>
<li><p>no environmental covariate (<code>ecov = NULL</code>)</p></li>
<li><p>2 indices</p></li>
<li><p>fit to 1973-2016 data</p></li>
</ul>
<p>In example 4, we demonstrate the time-varying selectivity options in
WHAM for both logistic and age-specific selectivity:</p>
<ul>
<li><p><code>none</code>: time-constant</p></li>
<li><p><code>iid</code>: parameter- and year-specific (random effect)
deviations from mean selectivity parameters</p></li>
<li><p><code>ar1</code>: as above, but estimate correlation across
logistic parameters</p></li>
<li><p><code>ar1_y</code>: as above, but estimate correlation across
years</p></li>
<li><p><code>2dar1</code>: as above, but estimate correlation across
both years and parameters</p></li>
</ul>
<p>Note that each of these options can be applied to any selectivity
block (and therefore fleet/catch or index/survey).</p>
<div class="section level2">
<h2 id="load-data">1. Load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h2>
<p>Open R and load the <code>wham</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://timjmiller.github.io/wham/">wham</a></span><span class="op">)</span></span></code></pre></div>
<p>For a clean, runnable <code>.R</code> script, look at
<code>ex4_selectivity.R</code> in the <code>example_scripts</code>
folder of the <code>wham</code> package. You can run this entire example
script with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wham.dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">find.package</a></span><span class="op">(</span><span class="st">"wham"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wham.dir</span>, <span class="st">"example_scripts"</span>, <span class="st">"ex4_selectivity.R"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let’s create a directory for this analysis:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># choose a location to save output, otherwise will be saved in working directory</span></span>
<span><span class="va">write.dir</span> <span class="op">&lt;-</span> <span class="st">"choose/where/to/save/output"</span> <span class="co"># need to change e.g., tempdir(check=TRUE)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">write.dir</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">write.dir</span><span class="op">)</span></span></code></pre></div>
<p>We need the same data files as in <a href="https://timjmiller.github.io/wham/articles/ex1_basics.html">example
1</a>. Read in <code>ex1_SNEMAYT.dat</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asap3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_asap3_dat.html">read_asap3_dat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wham.dir</span>,<span class="st">"extdata"</span>,<span class="st">"ex1_SNEMAYT.dat"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="specify-selectivity-model-options">2. Specify selectivity model options<a class="anchor" aria-label="anchor" href="#specify-selectivity-model-options"></a>
</h2>
<p>We are going to run 8 models that differ only in the selectivity
options:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># m1-m5 logistic, m6-m9 age-specific</span></span>
<span><span class="va">sel_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"logistic"</span>,<span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"age-specific"</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># time-varying options for each of 3 blocks (b1 = fleet, b2-3 = indices)</span></span>
<span><span class="va">sel_re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>,<span class="st">"none"</span>,<span class="st">"none"</span><span class="op">)</span>, <span class="co"># m1-m4 logistic</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iid"</span>,<span class="st">"none"</span>,<span class="st">"none"</span><span class="op">)</span>,</span>
<span><span class="co">#               c("ar1","none","none"), #can't get a converged model for logistic with two re and two fe for</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2dar1"</span>,<span class="st">"none"</span>,<span class="st">"none"</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>,<span class="st">"none"</span>,<span class="st">"none"</span><span class="op">)</span>, <span class="co"># m4-m8 age-specific</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iid"</span>,<span class="st">"none"</span>,<span class="st">"none"</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ar1"</span>,<span class="st">"none"</span>,<span class="st">"none"</span><span class="op">)</span>, <span class="co">#will map all age-specific (mean) parameters to one estimated value</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ar1_y"</span>,<span class="st">"none"</span>,<span class="st">"none"</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2dar1"</span>,<span class="st">"none"</span>,<span class="st">"none"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n.mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sel_re</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summary data frame</span></span>
<span><span class="va">df.mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n.mods</span><span class="op">)</span>, </span>
<span>    Selectivity<span class="op">=</span><span class="va">sel_model</span>, <span class="co"># Selectivity model (same for all blocks)</span></span>
<span>    Block_1_re<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">sel_re</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># Block 1 random effects</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">df.mods</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="va">df.mods</span></span>
<span><span class="co">#&gt;   Model  Selectivity Block_1_re</span></span>
<span><span class="co">#&gt; 1    m1     logistic       none</span></span>
<span><span class="co">#&gt; 2    m2     logistic        iid</span></span>
<span><span class="co">#&gt; 3    m3     logistic      2dar1</span></span>
<span><span class="co">#&gt; 4    m4 age-specific       none</span></span>
<span><span class="co">#&gt; 5    m5 age-specific        iid</span></span>
<span><span class="co">#&gt; 6    m6 age-specific        ar1</span></span>
<span><span class="co">#&gt; 7    m7 age-specific      ar1_y</span></span>
<span><span class="co">#&gt; 8    m8 age-specific      2dar1</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="setup-and-run-models">3. Setup and run models<a class="anchor" aria-label="anchor" href="#setup-and-run-models"></a>
</h2>
<p>The ASAP data file specifies selectivity options (model, initial
parameter values, which parameters to fix/estimate). WHAM uses these by
default in order to facilitate running ASAP models. To see the currently
specified selectivity options in <code>asap3</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asap3</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">sel_block_assign</span> <span class="co"># 1 fleet, all years assigned to block 1</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co"># by default each index gets its own selectivity block (here, blocks 2 and 3)</span></span>
<span></span>
<span><span class="va">asap3</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">sel_block_option</span> <span class="co"># fleet selectivity (1 block), 2 = logistic</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="va">asap3</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">index_sel_option</span> <span class="co"># index selectivity (2 blocks), 2 = logistic</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span></span>
<span><span class="va">asap3</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">sel_ini</span> <span class="co"># fleet sel initial values (col1), estimation phase (-1 = fix)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="va">asap3</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">index_sel_ini</span> <span class="co"># index sel initial values (col1), estimation phase (-1 = fix)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>When we specify the WHAM model with
<code><a href="../reference/prepare_wham_input.html">prepare_wham_input()</a></code>, we can overwrite the selectivity
options from the ASAP data file with the optional list argument
<code>selectivity</code>. The selectivity model is chosen via
<code>selectivity$model</code>:</p>
<table class="table">
<thead><tr class="header">
<th>Model</th>
<th><code>selectivity$model</code></th>
<th>No. Parameters</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Age-specific</td>
<td><code>"age-specific"</code></td>
<td><code>n_ages</code></td>
</tr>
<tr class="even">
<td>Logistic (increasing)</td>
<td><code>"logistic"</code></td>
<td>2</td>
</tr>
<tr class="odd">
<td>Double logistic (dome)</td>
<td><code>"double-logistic"</code></td>
<td>4</td>
</tr>
<tr class="even">
<td>Logistic (decreasing)</td>
<td><code>"decreasing-logistic"</code></td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Regardless of the selectivity model used, we incorporate time-varying
selectivity by estimating a mean for each selectivity parameter, <span class="math inline">\(\mu^{s}_a\)</span>, and (random effect) deviations
from the mean, <span class="math inline">\(\delta_{a,y}\)</span>. We
then estimate the selectivity parameters, <span class="math inline">\(s_{a,y}\)</span>, on the logit-scale with
(possibly) lower and upper limits: <span class="math display">\[s_{a,y}
= \mathrm{lower} + \frac{\mathrm{upper} - \mathrm{lower}}{1 +
e^{-(\mu^{s}_a + \delta_{a,y})}}\]</span></p>
<p>The deviations, <span class="math inline">\(\boldsymbol{\delta}\)</span>, follow a
2-dimensional AR(1) process defined by the parameters <span class="math inline">\(\sigma^2_s\)</span>, <span class="math inline">\(\rho_a\)</span>, and <span class="math inline">\(\rho_y\)</span>: <span class="math display">\[\boldsymbol{\delta} \sim
\mathrm{MVN}(0,\Sigma)\]</span> <span class="math display">\[\Sigma =
\sigma^2_s(\mathrm{R}_a \otimes \mathrm{R}_y)\]</span> <span class="math display">\[R_{a,a^*} = \rho_a^{\vert a - a^* \vert}\]</span>
<span class="math display">\[R_{y,y^*} = \rho_y^{\vert y - y^*
\vert}\]</span></p>
<p>Mean selectivity parameters can be initialized at different values
from the ASAP file with <code>selectivity$initial_pars</code>.
Parameters can be fixed at their initial values by specifying
<code>selectivity$fix_pars</code>. Finally, we specify any time-varying
(random effects) on selectivity parameters
(<code>selectivity$re</code>):</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th><code>selectivity$re</code></th>
<th>Deviations from mean</th>
<th>Estimated parameters</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>"none"</code></td>
<td>time-constant (no deviation)</td>
<td></td>
</tr>
<tr class="even">
<td><code>"iid"</code></td>
<td>independent, identically-distributed</td>
<td><span class="math inline">\(\sigma^2\)</span></td>
</tr>
<tr class="odd">
<td><code>"ar1"</code></td>
<td>autoregressive-1 (correlated across ages/parameters)</td>
<td>
<span class="math inline">\(\sigma^2\)</span>, <span class="math inline">\(\rho_a\)</span>
</td>
</tr>
<tr class="even">
<td><code>"ar1_y"</code></td>
<td>autoregressive-1 (correlated across years)</td>
<td>
<span class="math inline">\(\sigma^2\)</span>, <span class="math inline">\(\rho_y\)</span>
</td>
</tr>
<tr class="odd">
<td><code>"2dar1"</code></td>
<td>2D AR1 (correlated across both years and ages/parameters)</td>
<td>
<span class="math inline">\(\sigma^2\)</span>, <span class="math inline">\(\rho_a\)</span>, <span class="math inline">\(\rho_y\)</span>
</td>
</tr>
</tbody>
</table>
<p>We will loop over and fit each of the models, but first lets define
some initial parameter values and which will be fixed. This is needed
specifically for the age-specific selectivity models.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#initial pars for logistic or age-specfic selectivity</span></span>
<span><span class="va">initial_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.3</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.3</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#which pars to fix for age-specific selectivity</span></span>
<span><span class="va">fix_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>,<span class="cn">NULL</span>,<span class="cn">NULL</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">6</span>,<span class="fl">4</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we can run the above models in a loop:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#make a list of fits to fill in</span></span>
<span><span class="va">mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n.mods</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># overwrite initial parameter values in ASAP data file (ex1_SNEMAYT.dat)</span></span>
<span>    <span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span><span class="va">asap3</span>, model_name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Model "</span>,<span class="va">m</span><span class="op">)</span>, <span class="va">sel_model</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sel_re</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span>, collapse<span class="op">=</span><span class="st">"-"</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">": "</span><span class="op">)</span>, recruit_model<span class="op">=</span><span class="fl">2</span>,</span>
<span>                selectivity<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">sel_model</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,<span class="fl">3</span><span class="op">)</span>, re<span class="op">=</span><span class="va">sel_re</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span>, initial_pars<span class="op">=</span><span class="va">initial_pars</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span>, fix_pars <span class="op">=</span> <span class="va">fix_pars</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                NAA_re <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sigma<span class="op">=</span><span class="st">'rec+1'</span>,cor<span class="op">=</span><span class="st">'iid'</span><span class="op">)</span>,</span>
<span>                age_comp <span class="op">=</span> <span class="st">"logistic-normal-miss0"</span><span class="op">)</span> <span class="co"># logistic normal, treat 0 obs as missing</span></span>
<span></span>
<span>    <span class="co"># fit model</span></span>
<span>    <span class="va">mods</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input</span>, do.check<span class="op">=</span><span class="cn">T</span>, do.osa<span class="op">=</span><span class="cn">F</span>, do.retro<span class="op">=</span><span class="cn">F</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#save the model fits</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mods</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">mod</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m"</span>,<span class="va">m</span>,<span class="st">".rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-convergence-and-comparison">4. Model convergence and comparison<a class="anchor" aria-label="anchor" href="#model-convergence-and-comparison"></a>
</h2>
<p>Check which models converged.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vign4_conv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="fu"><a href="../reference/check_convergence.html">check_convergence</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n.mods</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Model "</span>,<span class="va">m</span>,<span class="st">":"</span><span class="op">)</span>, <span class="va">vign4_conv</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span>, <span class="st">""</span>, sep<span class="op">=</span><span class="st">'\n'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Model 1:</span></span>
<span><span class="co">#&gt; stats:nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 6.24e-11 </span></span>
<span><span class="co">#&gt; Max gradient parameter: log_NAA_sigma </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 2:</span></span>
<span><span class="co">#&gt; stats:nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 8.81e-13 </span></span>
<span><span class="co">#&gt; Max gradient parameter: logit_q </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 3:</span></span>
<span><span class="co">#&gt; stats:nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 2.84e-13 </span></span>
<span><span class="co">#&gt; Max gradient parameter: logit_q </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 4:</span></span>
<span><span class="co">#&gt; stats:nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 1.71e-10 </span></span>
<span><span class="co">#&gt; Max gradient parameter: log_NAA_sigma </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 5:</span></span>
<span><span class="co">#&gt; stats:nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 5.27e-08 </span></span>
<span><span class="co">#&gt; Max gradient parameter: catch_paa_pars </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 6:</span></span>
<span><span class="co">#&gt; stats:nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 5.61e-13 </span></span>
<span><span class="co">#&gt; Max gradient parameter: logit_q </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 7:</span></span>
<span><span class="co">#&gt; stats:nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 1.08e-09 </span></span>
<span><span class="co">#&gt; Max gradient parameter: index_paa_pars </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model 8:</span></span>
<span><span class="co">#&gt; stats:nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 3.58e-09 </span></span>
<span><span class="co">#&gt; Max gradient parameter: F_pars </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span></code></pre>
<p>Plot output for models that converged (in a subfolder for each
model):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Is Hessian positive definite?</span></span>
<span><span class="va">ok_sdrep</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">if</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">na_sdrep</span><span class="op">==</span><span class="cn">FALSE</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">na_sdrep</span><span class="op">)</span><span class="op">)</span> <span class="fl">1</span> <span class="kw">else</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">pdHess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">ok_sdrep</span><span class="op">)</span></span>
<span><span class="co"># did stats::nlminb converge?</span></span>
<span><span class="va">conv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">convergence</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># 0 means opt converged</span></span>
<span><span class="va">conv_mods</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n.mods</span><span class="op">)</span><span class="op">[</span><span class="va">pdHess</span><span class="op">]</span> </span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="va">conv_mods</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">#html and png files by default</span></span>
<span>    <span class="fu"><a href="../reference/plot_wham_output.html">plot_wham_output</a></span><span class="op">(</span>mod<span class="op">=</span><span class="va">mods</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span>, dir.main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">write.dir</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m"</span>,<span class="va">m</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Compare the models using AIC:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df.aic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="../reference/compare_wham_models.html">compare_wham_models</a></span><span class="op">(</span><span class="va">mods</span>, table.opts<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sort<span class="op">=</span><span class="cn">FALSE</span>, calc.rho<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">tab</span><span class="op">)</span></span>
<span><span class="va">df.aic</span><span class="op">[</span><span class="op">!</span><span class="va">pdHess</span>,<span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">minAIC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">df.aic</span><span class="op">$</span><span class="va">AIC</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">df.aic</span><span class="op">$</span><span class="va">dAIC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">df.aic</span><span class="op">$</span><span class="va">AIC</span> <span class="op">-</span> <span class="va">minAIC</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">df.mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n.mods</span><span class="op">)</span>, Selectivity<span class="op">=</span><span class="va">sel_model</span>,</span>
<span>                            <span class="st">"Block1_re"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">sel_re</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                            <span class="st">"opt_converged"</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">conv</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span><span class="op">)</span>,</span>
<span>                            <span class="st">"pd_hessian"</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">pdHess</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span><span class="op">)</span>,</span>
<span>                            <span class="st">"NLL"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">objective</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                            <span class="st">"Runtime"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">runtime</span><span class="op">)</span><span class="op">)</span>, <span class="va">df.aic</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">df.mods</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">df.mods</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;   Model  Selectivity Block1_re opt_converged pd_hessian      NLL Runtime dAIC</span></span>
<span><span class="co">#&gt; 1    m1     logistic      none           Yes        Yes -788.748    0.73 54.5</span></span>
<span><span class="co">#&gt; 2    m2     logistic       iid           Yes        Yes -811.603    0.87 10.8</span></span>
<span><span class="co">#&gt; 3    m3     logistic     2dar1           Yes        Yes -818.980    0.89  0.0</span></span>
<span><span class="co">#&gt; 4    m4 age-specific      none           Yes        Yes -793.497    0.67 51.0</span></span>
<span><span class="co">#&gt; 5    m5 age-specific       iid           Yes        Yes -793.497    0.84 53.0</span></span>
<span><span class="co">#&gt; 6    m6 age-specific       ar1           Yes        Yes -785.042    0.85 67.9</span></span>
<span><span class="co">#&gt; 7    m7 age-specific     ar1_y           Yes        Yes -818.610    0.68  4.8</span></span>
<span><span class="co">#&gt; 8    m8 age-specific     2dar1           Yes        Yes -820.487    0.84  3.0</span></span>
<span><span class="co">#&gt;       AIC</span></span>
<span><span class="co">#&gt; 1 -1449.5</span></span>
<span><span class="co">#&gt; 2 -1493.2</span></span>
<span><span class="co">#&gt; 3 -1504.0</span></span>
<span><span class="co">#&gt; 4 -1453.0</span></span>
<span><span class="co">#&gt; 5 -1451.0</span></span>
<span><span class="co">#&gt; 6 -1436.1</span></span>
<span><span class="co">#&gt; 7 -1499.2</span></span>
<span><span class="co">#&gt; 8 -1501.0</span></span></code></pre>
<p>Prepare to plot selectivity-at-age for block 1 (fleet).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">selAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">selAA</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sel_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Age-specific"</span>,<span class="st">"Logistic"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">selblock_models</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">]</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Logistic"</span>,<span class="st">"Age-specific"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sel_cor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"None"</span>,<span class="st">"IID"</span>,<span class="st">"AR1"</span>,<span class="st">"AR1_y"</span>,<span class="st">"2D AR1"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">selblock_models_re</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">]</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"None"</span>,<span class="st">"IID"</span>,<span class="st">"AR1"</span>,<span class="st">"AR1_y"</span>,<span class="st">"2D AR1"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df.selAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="fl">0</span>, ncol<span class="op">=</span><span class="fl">11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df.selAA</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Age_"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>,<span class="st">"Year"</span>,<span class="st">"Model"</span>,<span class="st">"conv"</span>,<span class="st">"sel_mod"</span>,<span class="st">"sel_cor"</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n.mods</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">selAA</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">Year</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">years</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Age_"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>,<span class="st">"Year"</span><span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">Model</span> <span class="op">&lt;-</span> <span class="va">m</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">conv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">df.mods</span><span class="op">$</span><span class="va">pd_hessian</span><span class="op">[</span><span class="va">m</span><span class="op">]</span><span class="op">==</span><span class="st">"Yes"</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">sel_mod</span> <span class="op">=</span> <span class="va">sel_mod</span><span class="op">[</span><span class="va">m</span><span class="op">]</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">sel_cor</span> <span class="op">=</span> <span class="va">sel_cor</span><span class="op">[</span><span class="va">m</span><span class="op">]</span></span>
<span>    <span class="va">df.selAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">df.selAA</span>, <span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df.selAA</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Year</span>,<span class="va">Model</span>,<span class="va">conv</span>,<span class="va">sel_mod</span>,<span class="va">sel_cor</span><span class="op">)</span>,</span>
<span>                names_to <span class="op">=</span> <span class="st">"Age"</span>,</span>
<span>                names_prefix <span class="op">=</span> <span class="st">"Age_"</span>,</span>
<span>                names_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Age <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span>,</span>
<span>                values_to <span class="op">=</span> <span class="st">"Selectivity"</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">Age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Age</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">sel_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">sel_mod</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Logistic"</span>,<span class="st">"Age-specific"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">sel_cor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">sel_cor</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"None"</span>,<span class="st">"IID"</span>,<span class="st">"AR1"</span>,<span class="st">"AR1_y"</span>,<span class="st">"2D AR1"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">conv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">conv</span><span class="op">)</span></span></code></pre></div>
<p>Now plot selectivity-at-age for block 1 (fleet) in all models.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>, y<span class="op">=</span><span class="va">Age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">Selectivity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_label</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>, y<span class="op">=</span><span class="va">Age</span>, label<span class="op">=</span><span class="va">lab</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">5</span>, alpha<span class="op">=</span><span class="fl">1</span>, <span class="co">#fontface = "bold",</span></span>
<span>      data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Year<span class="op">=</span><span class="fl">1975.5</span>, Age<span class="op">=</span><span class="fl">5.8</span>, lab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m"</span>,<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mods</span><span class="op">)</span><span class="op">)</span>, sel_mod<span class="op">=</span><span class="va">sel_mod</span>, sel_cor<span class="op">=</span><span class="va">sel_cor</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>    </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>rows<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sel_cor</span><span class="op">)</span>, cols<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sel_mod</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_fill_viridis</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex4_plots/selAA.png" style="width:90.0%"></p>
<div class="section level4">
<h4 id="a-note-on-convergence">A note on convergence<a class="anchor" aria-label="anchor" href="#a-note-on-convergence"></a>
</h4>
<p>When fitting age-specific selectivity, oftentimes some of the (mean,
<span class="math inline">\(\mu^s_a\)</span>) selectivity parameters
need to be fixed for the model to converge. The specifications used here
follow this procedure:</p>
<ol style="list-style-type: decimal">
<li>Fit the model without fixing any selectivity parameters.</li>
<li>If the model fails to converge or the hessian is not invertible
(i.e. not positive definite), look for mean selectivity parameters that
are very close to 0 or 1 (&gt; 5 or &lt; -5 on the logit scale) and/or
have <code>NaN</code> estimates of their standard error:</li>
</ol>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span><span class="op">$</span><span class="va">parList</span><span class="op">$</span><span class="va">logit_selpars</span> <span class="co"># mean sel pars</span></span>
<span><span class="va">mod</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">sel_repars</span> <span class="co"># if time-varying selectivity turned on</span></span>
<span><span class="va">mod</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">selAA</span> <span class="co"># list of annual selectivity-at-age by block</span></span>
<span><span class="va">mod</span><span class="op">$</span><span class="va">sdrep</span> <span class="co"># look for sel pars with NaN standard errors</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Re-run the model fixing the worst selectivity-at-age parameter for
each block at 0 or 1 as appropriate. In the above age-specific models,
we initially just fixed age 4 in block 2. The logit scale selectivity
for age 5 for that block was around 20 for at least one model,
indicating that they too should be fixed at 1. Sometimes just
initializing the worst parameter is enough, without fixing it.</li>
<li>The goal is to find a set of selectivity parameter initial/fixed
values that allow all nested models to converge. Fixing parameters
should not affect the NLL much, and any model that is a superset of
another should not have a greater NLL (indicates not converged to global
minimum). The following commands may be helpful:</li>
</ol>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n.mods</span>,<span class="st">".rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod.list</span>, <span class="va">readRDS</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/check_convergence.html">check_convergence</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">obj</span><span class="op">)</span> <span class="co"># get NLL </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">parList</span><span class="op">$</span><span class="va">logit_selpars</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">sel_repars</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Tim Miller, Brian Stock.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
