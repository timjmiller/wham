<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ex 7: Debugging WHAM models • wham</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Ex 7: Debugging WHAM models">
<meta property="og:description" content="wham">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wham</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.1.0.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fas fa-book fa-lg"></span>
     
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/index.html">Overview</a>
    </li>
    <li>
      <a href="../articles/ex01_basics.html">Ex 1: The basics</a>
    </li>
    <li>
      <a href="../articles/ex02_CPI_recruitment.html">Ex 2: Recruitment linked to an environmental covariate (Cold Pool Index)</a>
    </li>
    <li>
      <a href="../articles/ex03_projections.html">Ex 3: Projecting / forecasting random effects</a>
    </li>
    <li>
      <a href="../articles/ex4_selectivity.html">Ex 4: Selectivity with time- and age-varying random effects</a>
    </li>
    <li>
      <a href="../articles/ex05_GSI_M.html">Ex 5: Time-varying natural mortality linked to the Gulf Stream Index</a>
    </li>
    <li>
      <a href="../articles/ex06_NAA.html">Ex 6: Numbers-at-age / survival deviations as random effects</a>
    </li>
    <li>
      <a href="../articles/ex07_debug.html">Ex 7: Debugging WHAM models</a>
    </li>
    <li>
      <a href="../articles/ex08_compare.html">Ex 8: Compare ASAP and WHAM model results</a>
    </li>
    <li>
      <a href="../articles/ex09_retro_pred.html">Ex 9: Retrospective predictions</a>
    </li>
    <li>
      <a href="../articles/ex10_simulation.html">Ex 10: Simulations</a>
    </li>
    <li>
      <a href="../articles/ex11_catchability.html">Ex 11: Catchability configurations</a>
    </li>
    <li>
      <a href="../articles/ex12_multistock.html">Ex 12: Multiple stocks, regions</a>
    </li>
    <li>
      <a href="../articles/ex13_no_ASAP.html">Ex 13: WHAM without ASAP</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="far fa-file-code fa-lg"></span>
     
    Functions
  </a>
</li>
<li>
  <a href="https://github.com/timjmiller/wham/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
    Source code
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fas fa-bullhorn fa-lg"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/timjmiller/wham/issues/" class="external-link">
    <span class="fas fa-question-circle fa-lg"></span>
     
    Issues
  </a>
</li>
<li>
  <a href="https://www.fisheries.noaa.gov/contact/timothy-miller-phd" class="external-link">
    <span class="fas fa-paper-plane fa-lg"></span>
     
    Contact
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ex 7: Debugging WHAM models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/timjmiller/wham/blob/HEAD/vignettes/ex07_debug.Rmd" class="external-link"><code>vignettes/ex07_debug.Rmd</code></a></small>
      <div class="hidden name"><code>ex07_debug.Rmd</code></div>

    </div>

    
    
<p>In this vignette we show how to use the <code>do.fit = FALSE</code>
flag to debug a WHAM model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("timjmiller/wham", dependencies=TRUE)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://timjmiller.github.io/wham/">wham</a></span><span class="op">)</span></span></code></pre></div>
<p>Load the ASAP3 data file.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wham.dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">find.package</a></span><span class="op">(</span><span class="st">"wham"</span><span class="op">)</span></span>
<span><span class="va">asap3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_asap3_dat.html">read_asap3_dat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wham.dir</span>,<span class="st">"extdata"</span>,<span class="st">"ex7_SNEMAYT.dat"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Prepare the WHAM model (<code>m3</code> from <a href="https://timjmiller.github.io/wham/articles/ex1_SNEMA_yellowtail_flounder.html">example
1</a>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span><span class="va">asap3</span>, recruit_model<span class="op">=</span><span class="fl">2</span>, model_name<span class="op">=</span><span class="st">"Ex 1: SNEMA Yellowtail Flounder"</span>,</span>
<span>                              NAA_re <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sigma<span class="op">=</span><span class="st">"rec+1"</span>, cor<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --Creating input---------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; basic_info done</span></span>
<span><span class="co">#&gt; catch done</span></span>
<span><span class="co">#&gt; indices done</span></span>
<span><span class="co">#&gt; WAA done</span></span>
<span><span class="co">#&gt; NAA done</span></span>
<span><span class="co">#&gt; q done</span></span>
<span><span class="co">#&gt; selectivity done</span></span>
<span><span class="co">#&gt; age_comp done</span></span>
<span><span class="co">#&gt; F done</span></span>
<span><span class="co">#&gt; M done</span></span>
<span><span class="co">#&gt; move done</span></span>
<span><span class="co">#&gt; osa_obs done</span></span>
<span><span class="co">#&gt; --Input Complete--------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; WHAM version 2.0.0 and forward: </span></span>
<span><span class="co">#&gt; 1) makes major changes to the structure of some data, parameters, and reported objects.</span></span>
<span><span class="co">#&gt; 2) decouples random effects for recruitment and random effects for older ages by default. To obtain results from previous versions set NAA_re$decouple_recruitment = FALSE.</span></span>
<span><span class="co">#&gt; 3) does not bias correct any log-normal process or observation errors. To configure these, set basic_info$bias_correct_process = TRUE and/or basic_info$bias_correct_observation = TRUE.</span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --USING ASAP3 Inputs-----------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; 1 asap3 dat file was processed. A single stock and region will be assumed. </span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --Catch------------------------------------------------------------------------------------------------------------------------------ </span></span>
<span><span class="co">#&gt; waa_pointer_fleets determined from ASAP file(s). </span></span>
<span><span class="co">#&gt; Selectivity blocks for each fleet:</span></span>
<span><span class="co">#&gt; fleet_1: 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --Indices----------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; waa_pointer_indices determined from ASAP file(s). </span></span>
<span><span class="co">#&gt; Selectivity blocks for each index:</span></span>
<span><span class="co">#&gt; index_1: 2</span></span>
<span><span class="co">#&gt; index_2: 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --WAA--------------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; basic_info$waa_pointer_M was not provided, so waa_pointer_ssb will be used. </span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --NAA--------------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Same NAA_re$sigma being used for all stocks (rec+1).</span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --Selectivity------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; (Mean) selectivity block models are:</span></span>
<span><span class="co">#&gt; Block 1: logistic</span></span>
<span><span class="co">#&gt; Block 2: logistic</span></span>
<span><span class="co">#&gt; Block 3: logistic</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects options for each selectivity block are:</span></span>
<span><span class="co">#&gt; Block 1: none</span></span>
<span><span class="co">#&gt; Block 2: none</span></span>
<span><span class="co">#&gt; Block 3: none</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --Reference points-------------------------------------------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; For annual SPR-based reference points, corresponding annual conditionally expected recruitments are used. </span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------------------------------------------------------------</span></span></code></pre></div>
<p>Try to fit the model… uh oh.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input</span>, do.osa <span class="op">=</span> <span class="cn">F</span>, do.retro <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="co">#&gt; Order of parameters:</span></span>
<span><span class="co">#&gt;  [1] "log_catch_sig_scale"  "log_index_sig_scale"  "log_N1"              </span></span>
<span><span class="co">#&gt;  [4] "N1_repars"            "log_NAA_sigma"        "trans_NAA_rho"       </span></span>
<span><span class="co">#&gt;  [7] "log_NAA"              "mean_rec_pars"        "logit_q"             </span></span>
<span><span class="co">#&gt; [10] "q_re"                 "q_repars"             "q_prior_re"          </span></span>
<span><span class="co">#&gt; [13] "logit_selpars"        "selpars_re"           "sel_repars"          </span></span>
<span><span class="co">#&gt; [16] "catch_paa_pars"       "index_paa_pars"       "F_pars"              </span></span>
<span><span class="co">#&gt; [19] "Mpars"                "M_re"                 "M_repars"            </span></span>
<span><span class="co">#&gt; [22] "log_b"                "logR_proj"            "mu_prior_re"         </span></span>
<span><span class="co">#&gt; [25] "trans_mu"             "mu_re"                "mu_repars"           </span></span>
<span><span class="co">#&gt; [28] "L_re"                 "L_repars"             "Ecov_obs_logsigma"   </span></span>
<span><span class="co">#&gt; [31] "Ecov_obs_logsigma_re" "Ecov_obs_sigma_par"   "Ecov_process_pars"   </span></span>
<span><span class="co">#&gt; [34] "Ecov_re"              "Ecov_beta_R"          "Ecov_beta_q"         </span></span>
<span><span class="co">#&gt; [37] "Ecov_beta_M"          "Ecov_beta_mu"        </span></span>
<span><span class="co">#&gt; Not matching template order:</span></span>
<span><span class="co">#&gt;  [1] "mean_rec_pars"        "logit_q"              "q_prior_re"          </span></span>
<span><span class="co">#&gt;  [4] "q_re"                 "q_repars"             "F_pars"              </span></span>
<span><span class="co">#&gt;  [7] "mu_prior_re"          "trans_mu"             "mu_re"               </span></span>
<span><span class="co">#&gt; [10] "mu_repars"            "N1_repars"            "log_N1"              </span></span>
<span><span class="co">#&gt; [13] "log_NAA_sigma"        "trans_NAA_rho"        "log_NAA"             </span></span>
<span><span class="co">#&gt; [16] "logR_proj"            "logit_selpars"        "selpars_re"          </span></span>
<span><span class="co">#&gt; [19] "sel_repars"           "catch_paa_pars"       "index_paa_pars"      </span></span>
<span><span class="co">#&gt; [22] "log_catch_sig_scale"  "log_index_sig_scale"  "Mpars"               </span></span>
<span><span class="co">#&gt; [25] "M_re"                 "M_repars"             "log_b"               </span></span>
<span><span class="co">#&gt; [28] "L_re"                 "L_repars"             "Ecov_re"             </span></span>
<span><span class="co">#&gt; [31] "Ecov_beta_R"          "Ecov_beta_M"          "Ecov_beta_mu"        </span></span>
<span><span class="co">#&gt; [34] "Ecov_beta_q"          "Ecov_process_pars"    "Ecov_obs_logsigma"   </span></span>
<span><span class="co">#&gt; [37] "Ecov_obs_logsigma_re" "Ecov_obs_sigma_par"  </span></span>
<span><span class="co">#&gt; Your parameter list has been re-ordered.</span></span>
<span><span class="co">#&gt; (Disable this warning with checkParameterOrder=FALSE)</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span>
<span><span class="co">#&gt; Using stats::nlminb for optimization with these control parameters:</span></span>
<span><span class="co">#&gt; iter.max: 1000</span></span>
<span><span class="co">#&gt; eval.max: 1000</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span>
<span><span class="co">#&gt; Warning in stats::nlminb(model$par, model$fn, model$gr, control = opt.control):</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span>
<span><span class="co">#&gt; Error in ff(x, order = 1) : </span></span>
<span><span class="co">#&gt;   inner newton optimization failed during gradient calculation</span></span>
<span><span class="co">#&gt; outer mgc:  NaN</span></span>
<span><span class="co">#&gt; Error in mod$opt$par: $ operator is invalid for atomic vectors</span></span></code></pre></div>
<p>What’s wrong? It looks like the likelihood function is returning
<code>NaN</code>. It is often easier to diagnose problems like this
using the <em>unoptimized</em> model, i.e. look at everything using the
initial parameter values. WHAM includes a <code>do.fit = F</code> flag
in <code>fit_wham</code> to return the unoptimized model object returned
by <code><a href="https://rdrr.io/pkg/TMB/man/MakeADFun.html" class="external-link">TMB::MakeADFun</a></code>. Let’s see how it works.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input</span>, do.fit <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="co">#&gt; Order of parameters:</span></span>
<span><span class="co">#&gt;  [1] "log_catch_sig_scale"  "log_index_sig_scale"  "log_N1"              </span></span>
<span><span class="co">#&gt;  [4] "N1_repars"            "log_NAA_sigma"        "trans_NAA_rho"       </span></span>
<span><span class="co">#&gt;  [7] "log_NAA"              "mean_rec_pars"        "logit_q"             </span></span>
<span><span class="co">#&gt; [10] "q_re"                 "q_repars"             "q_prior_re"          </span></span>
<span><span class="co">#&gt; [13] "logit_selpars"        "selpars_re"           "sel_repars"          </span></span>
<span><span class="co">#&gt; [16] "catch_paa_pars"       "index_paa_pars"       "F_pars"              </span></span>
<span><span class="co">#&gt; [19] "Mpars"                "M_re"                 "M_repars"            </span></span>
<span><span class="co">#&gt; [22] "log_b"                "logR_proj"            "mu_prior_re"         </span></span>
<span><span class="co">#&gt; [25] "trans_mu"             "mu_re"                "mu_repars"           </span></span>
<span><span class="co">#&gt; [28] "L_re"                 "L_repars"             "Ecov_obs_logsigma"   </span></span>
<span><span class="co">#&gt; [31] "Ecov_obs_logsigma_re" "Ecov_obs_sigma_par"   "Ecov_process_pars"   </span></span>
<span><span class="co">#&gt; [34] "Ecov_re"              "Ecov_beta_R"          "Ecov_beta_q"         </span></span>
<span><span class="co">#&gt; [37] "Ecov_beta_M"          "Ecov_beta_mu"        </span></span>
<span><span class="co">#&gt; Not matching template order:</span></span>
<span><span class="co">#&gt;  [1] "mean_rec_pars"        "logit_q"              "q_prior_re"          </span></span>
<span><span class="co">#&gt;  [4] "q_re"                 "q_repars"             "F_pars"              </span></span>
<span><span class="co">#&gt;  [7] "mu_prior_re"          "trans_mu"             "mu_re"               </span></span>
<span><span class="co">#&gt; [10] "mu_repars"            "N1_repars"            "log_N1"              </span></span>
<span><span class="co">#&gt; [13] "log_NAA_sigma"        "trans_NAA_rho"        "log_NAA"             </span></span>
<span><span class="co">#&gt; [16] "logR_proj"            "logit_selpars"        "selpars_re"          </span></span>
<span><span class="co">#&gt; [19] "sel_repars"           "catch_paa_pars"       "index_paa_pars"      </span></span>
<span><span class="co">#&gt; [22] "log_catch_sig_scale"  "log_index_sig_scale"  "Mpars"               </span></span>
<span><span class="co">#&gt; [25] "M_re"                 "M_repars"             "log_b"               </span></span>
<span><span class="co">#&gt; [28] "L_re"                 "L_repars"             "Ecov_re"             </span></span>
<span><span class="co">#&gt; [31] "Ecov_beta_R"          "Ecov_beta_M"          "Ecov_beta_mu"        </span></span>
<span><span class="co">#&gt; [34] "Ecov_beta_q"          "Ecov_process_pars"    "Ecov_obs_logsigma"   </span></span>
<span><span class="co">#&gt; [37] "Ecov_obs_logsigma_re" "Ecov_obs_sigma_par"  </span></span>
<span><span class="co">#&gt; Your parameter list has been re-ordered.</span></span>
<span><span class="co">#&gt; (Disable this warning with checkParameterOrder=FALSE)</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span>
<span><span class="co">#&gt; iter: 1  Error in iterate(par) : </span></span>
<span><span class="co">#&gt;   Newton dropout because inner gradient had non-finite components.</span></span></code></pre></div>
<p>This runs without a fatal error. The optimization failed because the
likelihood was <code>NaN</code>, and now we can see which of the
likelihood components was responsible. To do so, we need to look at the
<code>REPORT</code>ed objects with <code>"nll"</code> in their name. We
can use the <code>$report()</code> function from TMB.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">therep</span> <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>See all of the <code>REPORT</code>ed objects.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">therep</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "pred_indices"              "MAA"                      </span></span>
<span><span class="co">#&gt;  [3] "N1"                        "mu_static"                </span></span>
<span><span class="co">#&gt;  [5] "Fbar"                      "waa_catch"                </span></span>
<span><span class="co">#&gt;  [7] "NAA_spawn"                 "log_FAA_by_region"        </span></span>
<span><span class="co">#&gt;  [9] "FAA_by_region"             "YPR_srf_FXSPR_static"     </span></span>
<span><span class="co">#&gt; [11] "log_FXSPR_static"          "NAA"                      </span></span>
<span><span class="co">#&gt; [13] "log_FXSPR"                 "pred_CAA"                 </span></span>
<span><span class="co">#&gt; [15] "Ecov_x"                    "Ecov_obs_sigma"           </span></span>
<span><span class="co">#&gt; [17] "log_SSB_FXSPR_static"      "marg_NAA_sigma"           </span></span>
<span><span class="co">#&gt; [19] "fracyr_SSB_all"            "selAA"                    </span></span>
<span><span class="co">#&gt; [21] "pred_log_indices"          "pred_catch_paa"           </span></span>
<span><span class="co">#&gt; [23] "annual_SAA_spawn"          "seasonal_Ps_terminal_year"</span></span>
<span><span class="co">#&gt; [25] "mature_static"             "log_YPR_FXSPR_static"     </span></span>
<span><span class="co">#&gt; [27] "log_SPR0_static"           "nll_sel"                  </span></span>
<span><span class="co">#&gt; [29] "nll"                       "pred_stock_CAA"           </span></span>
<span><span class="co">#&gt; [31] "log_Fbar_XSPR_static"      "log_M_static"             </span></span>
<span><span class="co">#&gt; [33] "log_FAA_XSPR"              "pred_log_catch"           </span></span>
<span><span class="co">#&gt; [35] "log_FAA_XSPR_static"       "q"                        </span></span>
<span><span class="co">#&gt; [37] "pred_N1"                   "logit_q_mat"              </span></span>
<span><span class="co">#&gt; [39] "annual_Ps"                 "nll_index_acomp"          </span></span>
<span><span class="co">#&gt; [41] "selpars"                   "pred_stock_catch"         </span></span>
<span><span class="co">#&gt; [43] "log_FXSPR_iter"            "NAAPR_FXSPR_static"       </span></span>
<span><span class="co">#&gt; [45] "all_NAA"                   "nll_Ecov_obs_sig"         </span></span>
<span><span class="co">#&gt; [47] "SSB"                       "pred_index_paa"           </span></span>
<span><span class="co">#&gt; [49] "log_FAA_tot"               "pred_NAA"                 </span></span>
<span><span class="co">#&gt; [51] "log_Y_FXSPR_static"        "log_SSB_FXSPR"            </span></span>
<span><span class="co">#&gt; [53] "log_index_resid"           "nll_agg_indices"          </span></span>
<span><span class="co">#&gt; [55] "log_F_tot"                 "log_M"                    </span></span>
<span><span class="co">#&gt; [57] "log_Y_FXSPR"               "nll_agg_catch"            </span></span>
<span><span class="co">#&gt; [59] "QAA"                       "mature_all"               </span></span>
<span><span class="co">#&gt; [61] "waa_ssb"                   "pred_catch"               </span></span>
<span><span class="co">#&gt; [63] "log_catch_resid"           "trans_mu_base"            </span></span>
<span><span class="co">#&gt; [65] "R_XSPR"                    "log_FXSPR_iter_static"    </span></span>
<span><span class="co">#&gt; [67] "nll_Ecov_obs"              "waa_ssb_static"           </span></span>
<span><span class="co">#&gt; [69] "selpars_re_mats"           "index_Neff_out"           </span></span>
<span><span class="co">#&gt; [71] "pred_IAA"                  "sel_static"               </span></span>
<span><span class="co">#&gt; [73] "NAA_devs"                  "NAAPR0_static"            </span></span>
<span><span class="co">#&gt; [75] "log_Fbar_XSPR"             "FAA"                      </span></span>
<span><span class="co">#&gt; [77] "log_SPR_FXSPR_static"      "nll_M"                    </span></span>
<span><span class="co">#&gt; [79] "NAA_index"                 "annual_SPR0AA"            </span></span>
<span><span class="co">#&gt; [81] "log_YPR_FXSPR"             "nll_catch_acomp"          </span></span>
<span><span class="co">#&gt; [83] "FAA_static"                "waa_catch_static"         </span></span>
<span><span class="co">#&gt; [85] "L"                         "nll_NAA"                  </span></span>
<span><span class="co">#&gt; [87] "log_SPR_FXSPR"             "mu"                       </span></span>
<span><span class="co">#&gt; [89] "log_SPR0"                  "catch_Neff_out"</span></span></code></pre></div>
<p>Now just get the objects with <code>"nll"</code> in their name, and
sum over all individual values.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"nll"</span>,<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">therep</span><span class="op">)</span>,value<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">therep</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;          nll_sel              nll  nll_index_acomp nll_Ecov_obs_sig </span></span>
<span><span class="co">#&gt;           0.0000              NaN        3921.8316           0.0000 </span></span>
<span><span class="co">#&gt;  nll_agg_indices    nll_agg_catch     nll_Ecov_obs            nll_M </span></span>
<span><span class="co">#&gt;        1565.7938              NaN           0.0000           0.0000 </span></span>
<span><span class="co">#&gt;  nll_catch_acomp          nll_NAA </span></span>
<span><span class="co">#&gt;        2844.2380         325.8628</span></span></code></pre></div>
<p>The likelihood components that are equal to 0 are not used in the
model (no random effects on <code>M</code>, <code>Ecov</code>,
<code>selectivity</code>, etc.). <code>nll</code> is the total
likelihood and is <code>NaN</code>. The one troublesome component is
<code>nll_agg_catch</code>. This is the total (aggregate) catch from the
fishery in each year. It could be an issue with the catch data, the
model-predicted catch, or the input CVs for the annual catches, since
they all are used in the likelihood calculation. Let’s take a closer
look at all of the annual values in <code>nll_agg_catch</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">therep</span><span class="op">$</span><span class="va">nll_agg_catch</span></span>
<span><span class="co">#&gt;              [,1]</span></span>
<span><span class="co">#&gt;  [1,] 103.3840617</span></span>
<span><span class="co">#&gt;  [2,] 122.5550305</span></span>
<span><span class="co">#&gt;  [3,]   8.4553933</span></span>
<span><span class="co">#&gt;  [4,]   0.3642440</span></span>
<span><span class="co">#&gt;  [5,]   1.7656695</span></span>
<span><span class="co">#&gt;  [6,]  14.0697924</span></span>
<span><span class="co">#&gt;  [7,]  32.3760427</span></span>
<span><span class="co">#&gt;  [8,]   9.0788070</span></span>
<span><span class="co">#&gt;  [9,]   8.8434262</span></span>
<span><span class="co">#&gt; [10,]  69.4381045</span></span>
<span><span class="co">#&gt; [11,] 119.1118361</span></span>
<span><span class="co">#&gt; [12,]  57.8351840</span></span>
<span><span class="co">#&gt; [13,]   0.7705734</span></span>
<span><span class="co">#&gt; [14,]  -0.9505520</span></span>
<span><span class="co">#&gt; [15,]   7.4019297</span></span>
<span><span class="co">#&gt; [16,]  13.9873964</span></span>
<span><span class="co">#&gt; [17,]  13.7551021</span></span>
<span><span class="co">#&gt; [18,]  96.2002607</span></span>
<span><span class="co">#&gt; [19,]   7.2293432</span></span>
<span><span class="co">#&gt; [20,]  15.4822178</span></span>
<span><span class="co">#&gt; [21,] 179.5247068</span></span>
<span><span class="co">#&gt; [22,] 128.8416770</span></span>
<span><span class="co">#&gt; [23,] 307.9921432</span></span>
<span><span class="co">#&gt; [24,] 156.5912411</span></span>
<span><span class="co">#&gt; [25,]  83.0194806</span></span>
<span><span class="co">#&gt; [26,]  97.6718012</span></span>
<span><span class="co">#&gt; [27,] 117.3983487</span></span>
<span><span class="co">#&gt; [28,]  79.6474016</span></span>
<span><span class="co">#&gt; [29,]  78.8584557</span></span>
<span><span class="co">#&gt; [30,] 143.3232225</span></span>
<span><span class="co">#&gt; [31,] 215.3673272</span></span>
<span><span class="co">#&gt; [32,] 208.3245273</span></span>
<span><span class="co">#&gt; [33,] 343.2713739</span></span>
<span><span class="co">#&gt; [34,] 294.8287577</span></span>
<span><span class="co">#&gt; [35,] 246.4181361</span></span>
<span><span class="co">#&gt; [36,] 232.2362516</span></span>
<span><span class="co">#&gt; [37,] 263.3032268</span></span>
<span><span class="co">#&gt; [38,] 367.0891293</span></span>
<span><span class="co">#&gt; [39,] 296.4944154</span></span>
<span><span class="co">#&gt; [40,] 203.8510507</span></span>
<span><span class="co">#&gt; [41,] 174.3395764</span></span>
<span><span class="co">#&gt; [42,]         NaN</span></span>
<span><span class="co">#&gt; [43,] 318.8528146</span></span>
<span><span class="co">#&gt; [44,] 524.1093361</span></span></code></pre></div>
<p>We see that the problem is in year 42. The user will not necessarily
know what names are used in WHAM to denote the different inputs to
<code>nll_agg_catch</code>, so we can search the <a href="https://github.com/timjmiller/wham/blob/d3370a0f82d0f2012a1a19afdfb4b2c29da73720/src/multi_wham.cpp#L915" class="external-link">WHAM
.cpp file</a> for “nll_agg_catch”. We find that it depends on
<code>agg_catch</code> (the catch data), <code>pred_log_catch</code>
(model-predicted log catch), <code>agg_catch_sigma</code>, and
<code>log_catch_sig_scale</code>. The aggregate catch CVs from ASAP are
transformed to standard deviations for the log-normal assumption on
aggregate catch and supplied to WHAM as
<code>input$data$agg_catch_sigma</code>. It is possible to attempt to
estimate a scalar multiple of the annual SDs via
<code>log_catch_sig_scale</code>, but it is not used by default.</p>
<p>The catch data looks ok.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">agg_catch</span></span>
<span><span class="co">#&gt;             [,1]</span></span>
<span><span class="co">#&gt;  [1,] 14549.0000</span></span>
<span><span class="co">#&gt;  [2,] 17088.0000</span></span>
<span><span class="co">#&gt;  [3,]  5732.0000</span></span>
<span><span class="co">#&gt;  [4,]  3436.0000</span></span>
<span><span class="co">#&gt;  [5,]  5223.0000</span></span>
<span><span class="co">#&gt;  [6,]  8085.0000</span></span>
<span><span class="co">#&gt;  [7,]  9883.0000</span></span>
<span><span class="co">#&gt;  [8,]  8021.0000</span></span>
<span><span class="co">#&gt;  [9,]  6607.0000</span></span>
<span><span class="co">#&gt; [10,] 15764.0000</span></span>
<span><span class="co">#&gt; [11,] 22211.0000</span></span>
<span><span class="co">#&gt; [12,] 11225.0000</span></span>
<span><span class="co">#&gt; [13,]  4817.0000</span></span>
<span><span class="co">#&gt; [14,]  4620.0000</span></span>
<span><span class="co">#&gt; [15,]  2652.0000</span></span>
<span><span class="co">#&gt; [16,]  2782.0000</span></span>
<span><span class="co">#&gt; [17,]  8349.0000</span></span>
<span><span class="co">#&gt; [18,] 17916.0000</span></span>
<span><span class="co">#&gt; [19,]  6430.0000</span></span>
<span><span class="co">#&gt; [20,]  2695.0000</span></span>
<span><span class="co">#&gt; [21,]   771.0008</span></span>
<span><span class="co">#&gt; [22,]   735.0004</span></span>
<span><span class="co">#&gt; [23,]   343.0004</span></span>
<span><span class="co">#&gt; [24,]   759.0001</span></span>
<span><span class="co">#&gt; [25,]  1222.0000</span></span>
<span><span class="co">#&gt; [26,]  1087.0000</span></span>
<span><span class="co">#&gt; [27,]  1403.0000</span></span>
<span><span class="co">#&gt; [28,]  1397.0000</span></span>
<span><span class="co">#&gt; [29,]  1449.0000</span></span>
<span><span class="co">#&gt; [30,]   945.0005</span></span>
<span><span class="co">#&gt; [31,]   666.0005</span></span>
<span><span class="co">#&gt; [32,]   619.0002</span></span>
<span><span class="co">#&gt; [33,]   346.0002</span></span>
<span><span class="co">#&gt; [34,]   396.0000</span></span>
<span><span class="co">#&gt; [35,]   502.0004</span></span>
<span><span class="co">#&gt; [36,]   583.0006</span></span>
<span><span class="co">#&gt; [37,]   453.0006</span></span>
<span><span class="co">#&gt; [38,]   290.9995</span></span>
<span><span class="co">#&gt; [39,]   390.0002</span></span>
<span><span class="co">#&gt; [40,]   563.0002</span></span>
<span><span class="co">#&gt; [41,]   645.9999</span></span>
<span><span class="co">#&gt; [42,]   625.0000</span></span>
<span><span class="co">#&gt; [43,]   337.0005</span></span>
<span><span class="co">#&gt; [44,]   151.9999</span></span></code></pre></div>
<p>The catch SDs looks ok.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">agg_catch_sigma</span></span>
<span><span class="co">#&gt;             [,1]</span></span>
<span><span class="co">#&gt;  [1,] 0.09975135</span></span>
<span><span class="co">#&gt;  [2,] 0.09975135</span></span>
<span><span class="co">#&gt;  [3,] 0.09975135</span></span>
<span><span class="co">#&gt;  [4,] 0.09975135</span></span>
<span><span class="co">#&gt;  [5,] 0.09975135</span></span>
<span><span class="co">#&gt;  [6,] 0.09975135</span></span>
<span><span class="co">#&gt;  [7,] 0.09975135</span></span>
<span><span class="co">#&gt;  [8,] 0.09975135</span></span>
<span><span class="co">#&gt;  [9,] 0.09975135</span></span>
<span><span class="co">#&gt; [10,] 0.09975135</span></span>
<span><span class="co">#&gt; [11,] 0.09975135</span></span>
<span><span class="co">#&gt; [12,] 0.09975135</span></span>
<span><span class="co">#&gt; [13,] 0.09975135</span></span>
<span><span class="co">#&gt; [14,] 0.09975135</span></span>
<span><span class="co">#&gt; [15,] 0.09975135</span></span>
<span><span class="co">#&gt; [16,] 0.09975135</span></span>
<span><span class="co">#&gt; [17,] 0.09975135</span></span>
<span><span class="co">#&gt; [18,] 0.09975135</span></span>
<span><span class="co">#&gt; [19,] 0.09975135</span></span>
<span><span class="co">#&gt; [20,] 0.09975135</span></span>
<span><span class="co">#&gt; [21,] 0.09975135</span></span>
<span><span class="co">#&gt; [22,] 0.09975135</span></span>
<span><span class="co">#&gt; [23,] 0.09975135</span></span>
<span><span class="co">#&gt; [24,] 0.09975135</span></span>
<span><span class="co">#&gt; [25,] 0.09975135</span></span>
<span><span class="co">#&gt; [26,] 0.09975135</span></span>
<span><span class="co">#&gt; [27,] 0.09975135</span></span>
<span><span class="co">#&gt; [28,] 0.09975135</span></span>
<span><span class="co">#&gt; [29,] 0.09975135</span></span>
<span><span class="co">#&gt; [30,] 0.09975135</span></span>
<span><span class="co">#&gt; [31,] 0.09975135</span></span>
<span><span class="co">#&gt; [32,] 0.09975135</span></span>
<span><span class="co">#&gt; [33,] 0.09975135</span></span>
<span><span class="co">#&gt; [34,] 0.09975135</span></span>
<span><span class="co">#&gt; [35,] 0.09975135</span></span>
<span><span class="co">#&gt; [36,] 0.09975135</span></span>
<span><span class="co">#&gt; [37,] 0.09975135</span></span>
<span><span class="co">#&gt; [38,] 0.09975135</span></span>
<span><span class="co">#&gt; [39,] 0.09975135</span></span>
<span><span class="co">#&gt; [40,] 0.09975135</span></span>
<span><span class="co">#&gt; [41,] 0.09975135</span></span>
<span><span class="co">#&gt; [42,] 0.09975135</span></span>
<span><span class="co">#&gt; [43,] 0.09975135</span></span>
<span><span class="co">#&gt; [44,] 0.09975135</span></span></code></pre></div>
<p>The predicted log catch in year 42 is the issue.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">therep</span><span class="op">$</span><span class="va">pred_log_catch</span></span>
<span><span class="co">#&gt;           [,1]</span></span>
<span><span class="co">#&gt;  [1,] 8.141326</span></span>
<span><span class="co">#&gt;  [2,] 8.175619</span></span>
<span><span class="co">#&gt;  [3,] 8.211267</span></span>
<span><span class="co">#&gt;  [4,] 8.328701</span></span>
<span><span class="co">#&gt;  [5,] 8.310382</span></span>
<span><span class="co">#&gt;  [6,] 8.443164</span></span>
<span><span class="co">#&gt;  [7,] 8.378883</span></span>
<span><span class="co">#&gt;  [8,] 8.533464</span></span>
<span><span class="co">#&gt;  [9,] 8.344692</span></span>
<span><span class="co">#&gt; [10,] 8.478282</span></span>
<span><span class="co">#&gt; [11,] 8.459799</span></span>
<span><span class="co">#&gt; [12,] 8.240291</span></span>
<span><span class="co">#&gt; [13,] 8.272735</span></span>
<span><span class="co">#&gt; [14,] 8.345046</span></span>
<span><span class="co">#&gt; [15,] 8.301266</span></span>
<span><span class="co">#&gt; [16,] 8.484047</span></span>
<span><span class="co">#&gt; [17,] 8.480970</span></span>
<span><span class="co">#&gt; [18,] 8.399881</span></span>
<span><span class="co">#&gt; [19,] 8.354660</span></span>
<span><span class="co">#&gt; [20,] 8.478542</span></span>
<span><span class="co">#&gt; [21,] 8.545121</span></span>
<span><span class="co">#&gt; [22,] 8.209722</span></span>
<span><span class="co">#&gt; [23,] 8.319028</span></span>
<span><span class="co">#&gt; [24,] 8.405094</span></span>
<span><span class="co">#&gt; [25,] 8.404287</span></span>
<span><span class="co">#&gt; [26,] 8.395213</span></span>
<span><span class="co">#&gt; [27,] 8.783863</span></span>
<span><span class="co">#&gt; [28,] 8.511973</span></span>
<span><span class="co">#&gt; [29,] 8.542322</span></span>
<span><span class="co">#&gt; [30,] 8.548186</span></span>
<span><span class="co">#&gt; [31,] 8.578196</span></span>
<span><span class="co">#&gt; [32,] 8.470991</span></span>
<span><span class="co">#&gt; [33,] 8.465392</span></span>
<span><span class="co">#&gt; [34,] 8.409350</span></span>
<span><span class="co">#&gt; [35,] 8.439292</span></span>
<span><span class="co">#&gt; [36,] 8.524398</span></span>
<span><span class="co">#&gt; [37,] 8.410996</span></span>
<span><span class="co">#&gt; [38,] 8.381255</span></span>
<span><span class="co">#&gt; [39,] 8.400900</span></span>
<span><span class="co">#&gt; [40,] 8.354259</span></span>
<span><span class="co">#&gt; [41,] 8.340842</span></span>
<span><span class="co">#&gt; [42,]      NaN</span></span>
<span><span class="co">#&gt; [43,] 8.344558</span></span>
<span><span class="co">#&gt; [44,] 8.257718</span></span></code></pre></div>
<p>The predicted log catch is just a <a href="https://github.com/timjmiller/wham/blob/d3370a0f82d0f2012a1a19afdfb4b2c29da73720/src/multi_wham.cpp#L912" class="external-link">log-transformation</a>
of <code>pred_catch</code> which <a href="https://github.com/timjmiller/wham/blob/d3370a0f82d0f2012a1a19afdfb4b2c29da73720/src/multi_wham.cpp#L910" class="external-link">aggregates
over stock-specific catches</a> (if more than 1). The stock-specific
catches are a <a href="https://github.com/timjmiller/wham/blob/d3370a0f82d0f2012a1a19afdfb4b2c29da73720/src/multi_wham.cpp#L908" class="external-link">function</a>
of stock-specific catch-at-age and weight-at-age for each fleet. These
objects are reported out by wham, so first let’s look at
<code>pred_stock_CAA</code> which is an array (n_fleetx x n_stocks x
n_years x n_ages). There is only 1 fleet and 1 stock so:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">therep</span><span class="op">$</span><span class="va">pred_stock_CAA</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,,<span class="op">]</span></span>
<span><span class="co">#&gt;            [,1]     [,2]     [,3]     [,4]     [,5]     [,6]</span></span>
<span><span class="co">#&gt;  [1,] 5435.8017  725.069 1948.968 1417.205  958.388 1175.115</span></span>
<span><span class="co">#&gt;  [2,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt;  [3,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt;  [4,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt;  [5,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt;  [6,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt;  [7,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt;  [8,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt;  [9,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [10,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [11,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [12,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [13,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [14,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [15,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [16,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [17,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [18,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [19,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [20,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [21,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [22,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [23,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [24,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [25,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [26,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [27,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [28,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [29,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [30,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [31,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [32,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [33,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [34,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [35,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [36,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [37,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [38,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [39,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [40,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [41,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [42,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [43,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span>
<span><span class="co">#&gt; [44,]  888.1566 1363.739 1654.605 1782.931 1839.482 1875.122</span></span></code></pre></div>
<p>The catch in numbers at age looks ok. So, lets look at
<code>waa_catch</code> which is an array (n_fleet x n_years x
n_ages):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">therep</span><span class="op">$</span><span class="va">waa_catch</span><span class="op">[</span><span class="fl">1</span>,,<span class="op">]</span> </span>
<span><span class="co">#&gt;          [,1]  [,2]  [,3]  [,4]  [,5]  [,6]</span></span>
<span><span class="co">#&gt;  [1,]   0.210 0.296 0.348 0.374 0.382 0.428</span></span>
<span><span class="co">#&gt;  [2,]   0.203 0.308 0.352 0.396 0.439 0.457</span></span>
<span><span class="co">#&gt;  [3,]   0.218 0.289 0.376 0.432 0.435 0.481</span></span>
<span><span class="co">#&gt;  [4,]   0.228 0.303 0.408 0.498 0.499 0.557</span></span>
<span><span class="co">#&gt;  [5,]   0.215 0.283 0.381 0.504 0.513 0.542</span></span>
<span><span class="co">#&gt;  [6,]   0.234 0.292 0.383 0.536 0.662 0.656</span></span>
<span><span class="co">#&gt;  [7,]   0.189 0.301 0.364 0.475 0.590 0.662</span></span>
<span><span class="co">#&gt;  [8,]   0.206 0.281 0.384 0.500 0.682 0.925</span></span>
<span><span class="co">#&gt;  [9,]   0.140 0.262 0.342 0.474 0.596 0.650</span></span>
<span><span class="co">#&gt; [10,]   0.226 0.263 0.353 0.499 0.660 0.833</span></span>
<span><span class="co">#&gt; [11,]   0.175 0.261 0.339 0.496 0.668 0.819</span></span>
<span><span class="co">#&gt; [12,]   0.182 0.237 0.295 0.388 0.487 0.656</span></span>
<span><span class="co">#&gt; [13,]   0.183 0.260 0.365 0.408 0.504 0.608</span></span>
<span><span class="co">#&gt; [14,]   0.186 0.284 0.331 0.463 0.587 0.642</span></span>
<span><span class="co">#&gt; [15,]   0.247 0.268 0.353 0.404 0.520 0.631</span></span>
<span><span class="co">#&gt; [16,]   0.270 0.293 0.396 0.493 0.611 0.821</span></span>
<span><span class="co">#&gt; [17,]   0.061 0.216 0.275 0.489 0.735 0.957</span></span>
<span><span class="co">#&gt; [18,]   0.204 0.255 0.290 0.366 0.613 0.884</span></span>
<span><span class="co">#&gt; [19,]   0.090 0.214 0.294 0.378 0.664 0.798</span></span>
<span><span class="co">#&gt; [20,]   0.110 0.303 0.375 0.447 0.631 0.918</span></span>
<span><span class="co">#&gt; [21,]   0.122 0.314 0.420 0.439 0.640 1.040</span></span>
<span><span class="co">#&gt; [22,]   0.078 0.247 0.321 0.387 0.480 0.622</span></span>
<span><span class="co">#&gt; [23,]   0.076 0.216 0.325 0.401 0.579 0.758</span></span>
<span><span class="co">#&gt; [24,]   0.102 0.335 0.368 0.457 0.604 0.740</span></span>
<span><span class="co">#&gt; [25,]   0.139 0.251 0.396 0.466 0.584 0.768</span></span>
<span><span class="co">#&gt; [26,]   0.160 0.287 0.367 0.494 0.567 0.726</span></span>
<span><span class="co">#&gt; [27,]   0.131 0.309 0.400 0.557 0.629 1.695</span></span>
<span><span class="co">#&gt; [28,]   0.185 0.321 0.444 0.561 0.667 0.752</span></span>
<span><span class="co">#&gt; [29,]   0.145 0.360 0.419 0.567 0.684 0.824</span></span>
<span><span class="co">#&gt; [30,]   0.164 0.330 0.438 0.574 0.764 0.751</span></span>
<span><span class="co">#&gt; [31,]   0.095 0.313 0.413 0.572 0.722 0.945</span></span>
<span><span class="co">#&gt; [32,]   0.136 0.295 0.436 0.540 0.581 0.799</span></span>
<span><span class="co">#&gt; [33,]   0.102 0.295 0.415 0.511 0.634 0.795</span></span>
<span><span class="co">#&gt; [34,]   0.110 0.251 0.373 0.475 0.607 0.783</span></span>
<span><span class="co">#&gt; [35,]   0.111 0.268 0.363 0.472 0.628 0.834</span></span>
<span><span class="co">#&gt; [36,]   0.151 0.266 0.388 0.461 0.574 1.077</span></span>
<span><span class="co">#&gt; [37,]   0.105 0.281 0.367 0.502 0.601 0.753</span></span>
<span><span class="co">#&gt; [38,]   0.099 0.281 0.414 0.470 0.573 0.702</span></span>
<span><span class="co">#&gt; [39,]   0.130 0.280 0.412 0.491 0.572 0.717</span></span>
<span><span class="co">#&gt; [40,]   0.120 0.251 0.365 0.475 0.554 0.709</span></span>
<span><span class="co">#&gt; [41,]   0.154 0.254 0.351 0.453 0.565 0.683</span></span>
<span><span class="co">#&gt; [42,] -99.000 0.345 0.396 0.459 0.565 0.689</span></span>
<span><span class="co">#&gt; [43,]   0.046 0.281 0.388 0.476 0.548 0.685</span></span>
<span><span class="co">#&gt; [44,]   0.000 0.270 0.349 0.434 0.521 0.629</span></span></code></pre></div>
<p>Ah, here is the problem. The weight at age data has an entry of
<code>-99</code> in year 42. This means that <code>pred_catch</code> is
negative, and we take the log of a negative number for
<code>pred_log_catch</code>.</p>
<p>If we fix this issue with the data file, the model runs fine!</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Tim Miller, Brian Stock.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
