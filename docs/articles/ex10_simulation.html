<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ex 10: Simulations â€¢ wham</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Ex 10: Simulations">
<meta property="og:description" content="wham">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wham</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.9.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fas fa-book fa-lg"></span>
     
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/index.html">Overview</a>
    </li>
    <li>
      <a href="../articles/ex01_basics.html">Ex 1: The basics</a>
    </li>
    <li>
      <a href="../articles/ex02_CPI_recruitment.html">Ex 2: Recruitment linked to an environmental covariate (Cold Pool Index)</a>
    </li>
    <li>
      <a href="../articles/ex03_projections.html">Ex 3: Projecting / forecasting random effects</a>
    </li>
    <li>
      <a href="../articles/ex4_selectivity.html">Ex 4: Selectivity with time- and age-varying random effects</a>
    </li>
    <li>
      <a href="../articles/ex05_GSI_M.html">Ex 5: Time-varying natural mortality linked to the Gulf Stream Index</a>
    </li>
    <li>
      <a href="../articles/ex06_NAA.html">Ex 6: Numbers-at-age / survival deviations as random effects</a>
    </li>
    <li>
      <a href="../articles/ex07_debug.html">Ex 7: Debugging WHAM models</a>
    </li>
    <li>
      <a href="../articles/ex08_compare.html">Ex 8: Compare ASAP and WHAM model results</a>
    </li>
    <li>
      <a href="../articles/ex09_retro_pred.html">Ex 9: Retrospective predictions</a>
    </li>
    <li>
      <a href="../articles/ex10_simulation.html">Ex 10: Simulations</a>
    </li>
    <li>
      <a href="../articles/ex11_catchability.html">Ex 11: Catchability configurations</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="far fa-file-code fa-lg"></span>
     
    Functions
  </a>
</li>
<li>
  <a href="https://github.com/timjmiller/wham/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
    Source code
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fas fa-bullhorn fa-lg"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/timjmiller/wham/issues/" class="external-link">
    <span class="fas fa-question-circle fa-lg"></span>
     
    Issues
  </a>
</li>
<li>
  <a href="https://www.fisheries.noaa.gov/contact/timothy-miller-phd" class="external-link">
    <span class="fas fa-paper-plane fa-lg"></span>
     
    Contact
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ex 10: Simulations</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/timjmiller/wham/blob/HEAD/vignettes/ex10_simulation.Rmd" class="external-link"><code>vignettes/ex10_simulation.Rmd</code></a></small>
      <div class="hidden name"><code>ex10_simulation.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="background">1. Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>In this vignette we show how to use WHAM for general simulation
studies. It updateds and replaces a previous WHAM vignette on Operating
models and MSE. We assume you already have <code>wham</code> installed
and are relatively familiar with the package. If not, read the <a href="https://timjmiller.github.io/wham/">Introduction</a> and <a href="https://timjmiller.github.io/wham/articles/">Tutorial</a>.</p>
<p>In this vignette we show how to:</p>
<ul>
<li>Simulate data from a fitted model with input derived from an ASAP3
dat file.</li>
<li>Make an operating model, simulate data, and fit models.</li>
<li>Fit models to data simulated from a different model.</li>
<li>Make a wham input file <strong>without an ASAP3 dat
file</strong>.</li>
<li>Configure different assumptions about the population for both the
operating model and the estimating model.</li>
<li>Do a closed-loop simulation with operating model, fitting an
estimating model, generating catch advice and incorporating it into the
operating model.</li>
</ul>
</div>
<div class="section level2">
<h2 id="setup-and-read-in-model-input">2. Setup and read in model input<a class="anchor" aria-label="anchor" href="#setup-and-read-in-model-input"></a>
</h2>
<p>Create a directory for this analysis:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># choose a location to save output, otherwise will be saved in working directory</span></span>
<span><span class="va">write.dir</span> <span class="op">&lt;-</span> <span class="st">"choose/where/to/save/output"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">write.dir</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">write.dir</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wham.dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">find.package</a></span><span class="op">(</span><span class="st">"wham"</span><span class="op">)</span></span>
<span><span class="va">asap3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_asap3_dat.html">read_asap3_dat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wham.dir</span>,<span class="st">"extdata"</span>,<span class="st">"ex1_SNEMAYT.dat"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Make an input and fit a model in wham. This model was also fit in the
first example vignette.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#define selectivity model</span></span>
<span><span class="va">selectivity</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"age-specific"</span>,<span class="fl">3</span><span class="op">)</span>, <span class="co">#define selectivity model</span></span>
<span>  re<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"none"</span>,<span class="fl">3</span><span class="op">)</span>, <span class="co">#define selectivity random effects model</span></span>
<span>  <span class="co">#define initial/fixed values for age-specific selectivity</span></span>
<span>  initial_pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  fix_pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">4</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="co">#which ages to not estimate age-specfic selectivity parameters</span></span>
<span></span>
<span><span class="va">NAA_re</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  sigma<span class="op">=</span><span class="st">"rec"</span>, <span class="co">#random effects for recruitment only</span></span>
<span>  cor<span class="op">=</span><span class="st">"iid"</span>, <span class="co">#random effects are independent</span></span>
<span>  recruit_model <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co">#mean recruitment is the only fixed effect parameter</span></span>
<span></span>
<span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>  <span class="va">asap3</span>, </span>
<span>  selectivity <span class="op">=</span> <span class="va">selectivity</span>,</span>
<span>  NAA_re <span class="op">=</span> <span class="va">NAA_re</span>,</span>
<span>  model_name<span class="op">=</span><span class="st">"Ex 1: SNEMA Yellowtail Flounder"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">mod_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro<span class="op">=</span><span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># don't do retro peels and OSA residuals, don't show output during optimization</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "par"            "fn"             "gr"             "he"            </span></span>
<span><span class="co">#&gt;  [5] "hessian"        "method"         "retape"         "env"           </span></span>
<span><span class="co">#&gt;  [9] "report"         "simulate"       "years"          "years_full"    </span></span>
<span><span class="co">#&gt; [13] "ages.lab"       "model_name"     "input"          "call"          </span></span>
<span><span class="co">#&gt; [17] "rep"            "wham_commit"    "wham_version"   "opt"           </span></span>
<span><span class="co">#&gt; [21] "date"           "dir"            "TMB_commit"     "TMB_version"   </span></span>
<span><span class="co">#&gt; [25] "parList"        "final_gradient" "is_sdrep"       "na_sdrep"      </span></span>
<span><span class="co">#&gt; [29] "runtime"        "sdrep"</span></span></code></pre></div>
<p>Several of the elements in the object returned by
<code>fit_wham</code> are those produced by <code><a href="https://rdrr.io/pkg/TMB/man/MakeADFun.html" class="external-link">TMB::MakeADFun</a></code>.
<code>mod_1$par</code> are the fixed effects or parameters over which
the marginal likelihood is optimized. <code>mod_1$fn</code> is the
function that returns the (Laplace approximation of) the negative
marginal log-likelihood. <code>mod_1$gr</code> is the function that
returns the gradient and <code>mod_1$he</code> returns the hessian.
<code>mod_1$report</code> is a function that provides a list of output
defined by REPORT() calls in the compiled cpp code and is already
evaluated and provided by <code>mod_1$rep</code>. When available,
<code>mod_1$sdrep</code> provides the hessian based standard errors for
estimates from the model which is generated by
the<code><a href="https://rdrr.io/pkg/TMB/man/sdreport.html" class="external-link">TMB::sdreport</a></code> function.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_1</span><span class="op">$</span><span class="va">sdrep</span> <span class="co">#the standard errors of the fixed effects</span></span>
<span><span class="co">#&gt;                    Estimate Std. Error</span></span>
<span><span class="co">#&gt; mean_rec_pars  9.2297317468 0.20741202</span></span>
<span><span class="co">#&gt; logit_q       -7.6658675842 0.07240548</span></span>
<span><span class="co">#&gt; logit_q       -8.3316202926 0.04787635</span></span>
<span><span class="co">#&gt; F_pars        -0.3010365597 0.10378094</span></span>
<span><span class="co">#&gt; F_pars         0.9285229416 0.13406941</span></span>
<span><span class="co">#&gt; F_pars        -0.0004773479 0.12741677</span></span>
<span><span class="co">#&gt; F_pars        -0.6333646293 0.14063536</span></span>
<span><span class="co">#&gt; F_pars         0.3545992256 0.15672409</span></span>
<span><span class="co">#&gt; F_pars         0.0007498385 0.14814836</span></span>
<span><span class="co">#&gt; F_pars        -0.1186869337 0.13952459</span></span>
<span><span class="co">#&gt; F_pars        -0.3135424185 0.13573691</span></span>
<span><span class="co">#&gt; F_pars        -0.3638492439 0.14032728</span></span>
<span><span class="co">#&gt; F_pars         0.3747984450 0.15107794</span></span>
<span><span class="co">#&gt; F_pars         0.4062432156 0.14131528</span></span>
<span><span class="co">#&gt; F_pars         0.3345658415 0.12315402</span></span>
<span><span class="co">#&gt; F_pars        -0.0926085078 0.12354231</span></span>
<span><span class="co">#&gt; F_pars        -0.0268561987 0.12975421</span></span>
<span><span class="co">#&gt; F_pars        -0.1547492535 0.13236249</span></span>
<span><span class="co">#&gt; F_pars        -0.5781912378 0.14060717</span></span>
<span><span class="co">#&gt; F_pars         0.0729322405 0.14723880</span></span>
<span><span class="co">#&gt; F_pars         0.5728244469 0.13078407</span></span>
<span><span class="co">#&gt; F_pars        -0.1306285071 0.11004614</span></span>
<span><span class="co">#&gt; F_pars        -0.2800617478 0.11369600</span></span>
<span><span class="co">#&gt; F_pars        -0.5485798871 0.12377094</span></span>
<span><span class="co">#&gt; F_pars         0.3737751961 0.13772134</span></span>
<span><span class="co">#&gt; F_pars        -0.9198984028 0.13376737</span></span>
<span><span class="co">#&gt; F_pars         0.2580256177 0.14685907</span></span>
<span><span class="co">#&gt; F_pars         0.4837561008 0.14669630</span></span>
<span><span class="co">#&gt; F_pars        -0.0965007661 0.14584155</span></span>
<span><span class="co">#&gt; F_pars         0.1868119330 0.15441950</span></span>
<span><span class="co">#&gt; F_pars        -0.0813445695 0.15144239</span></span>
<span><span class="co">#&gt; F_pars         0.1925950197 0.15297110</span></span>
<span><span class="co">#&gt; F_pars        -0.4368514619 0.14045843</span></span>
<span><span class="co">#&gt; F_pars        -0.1981206595 0.14133134</span></span>
<span><span class="co">#&gt; F_pars         0.2086433955 0.14571752</span></span>
<span><span class="co">#&gt; F_pars        -0.5430209898 0.13831609</span></span>
<span><span class="co">#&gt; F_pars        -0.2223686593 0.14787653</span></span>
<span><span class="co">#&gt; F_pars        -0.3312150849 0.14530564</span></span>
<span><span class="co">#&gt; F_pars        -0.1132458326 0.14270517</span></span>
<span><span class="co">#&gt; F_pars        -0.3259619687 0.13965183</span></span>
<span><span class="co">#&gt; F_pars        -0.3070878804 0.14247434</span></span>
<span><span class="co">#&gt; F_pars         0.4437180306 0.14646439</span></span>
<span><span class="co">#&gt; F_pars         0.4592751847 0.14826234</span></span>
<span><span class="co">#&gt; F_pars         0.3692754247 0.15160407</span></span>
<span><span class="co">#&gt; F_pars         0.2753424755 0.15409611</span></span>
<span><span class="co">#&gt; F_pars        -0.2900113211 0.14619853</span></span>
<span><span class="co">#&gt; F_pars        -0.2117818048 0.14619819</span></span>
<span><span class="co">#&gt; log_N1        10.1700660571 0.10527751</span></span>
<span><span class="co">#&gt; log_N1         9.9527951723 0.12199347</span></span>
<span><span class="co">#&gt; log_N1        10.6203396500 0.09076633</span></span>
<span><span class="co">#&gt; log_N1         9.9748140498 0.12635104</span></span>
<span><span class="co">#&gt; log_N1         9.5125996510 0.18987237</span></span>
<span><span class="co">#&gt; log_N1        10.3001982114 0.13849860</span></span>
<span><span class="co">#&gt; log_NAA_sigma  0.2984650943 0.10907366</span></span>
<span><span class="co">#&gt; logit_selpars -3.2740083810 0.07972564</span></span>
<span><span class="co">#&gt; logit_selpars -3.5663837086 0.12201301</span></span>
<span><span class="co">#&gt; logit_selpars -0.4793729495 0.08493727</span></span>
<span><span class="co">#&gt; logit_selpars -0.6123439738 0.07866043</span></span>
<span><span class="co">#&gt; logit_selpars -0.0404455537 0.13774029</span></span>
<span><span class="co">#&gt; logit_selpars  1.5214280591 0.25870728</span></span>
<span><span class="co">#&gt; logit_selpars  1.3197981151 0.32315199</span></span>
<span><span class="co">#&gt; logit_selpars  1.8480537113 0.72656177</span></span>
<span><span class="co">#&gt; logit_selpars -0.3155761732 0.27025562</span></span>
<span><span class="co">#&gt; logit_selpars -1.7055860028 0.14892970</span></span>
<span><span class="co">#&gt; logit_selpars -1.8842728586 0.17675440</span></span>
<span><span class="co">#&gt; logit_selpars -2.2054297407 0.20103797</span></span></code></pre></div>
<p>The important item for this vignette is
<code>mod_1$simulate</code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_1</span><span class="op">$</span><span class="va">simulate</span></span>
<span><span class="co">#&gt; function (par = last.par, complete = FALSE) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     f(par, order = 0, type = "double", do_simulate = TRUE)</span></span>
<span><span class="co">#&gt;     sim &lt;- as.list(reportenv)</span></span>
<span><span class="co">#&gt;     if (complete) {</span></span>
<span><span class="co">#&gt;         ans &lt;- data</span></span>
<span><span class="co">#&gt;         ans[names(sim)] &lt;- sim</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     else {</span></span>
<span><span class="co">#&gt;         ans &lt;- sim</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     ans</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x0000028f201985b8&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: 0x0000028f1ff7af88&gt;</span></span></code></pre></div>
<p>As we can see it is a function, but less apparent is that it will
report anything using the <code>REPORT</code> calls, and most
importantly, those within SIMULATE statements in the compiled cpp code.
More information about simulation using the TMB package can be found <a href="http://kaskr.github.io/adcomp/_book/Simulation.html" class="external-link">here</a>. The
WHAM cpp code is written to be able to simulate all observations and any
random effects that are specified to be part of the particular model
configuration. <code>mod_1$simulate</code> is what we use to simulate
data for simulation studies. The <code>complete</code> argument tells
the function to provide all data inputs whether they are simulated or
not. For a wham model this would include important things like weight
and maturity at age.</p>
<p>Here is a simple function that will simulate data from an operating
model. It will fit the same model configuration to that data with the
argument <code>self.fit=TRUE</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">om</span>, <span class="va">self.fit</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">do.sdrep</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">input</span> <span class="op">&lt;-</span> <span class="va">om</span><span class="op">$</span><span class="va">input</span></span>
<span>  <span class="va">input</span><span class="op">$</span><span class="va">data</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span>complete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">self.fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input</span>, do.sdrep <span class="op">=</span> <span class="va">do.sdrep</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">self_sim_fit</span> <span class="op">&lt;-</span> <span class="fu">sim_fn</span><span class="op">(</span><span class="va">mod_1</span>, self.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">self_sim_fit</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">SSB</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"SSB"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">self_sim_fit</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://github.com/timjmiller/wham/devel/vignettes/ex10_plots/self_fit_1_ssb.png" style="width:80.0%"></p>
<p>Note that we just have to over-write the data component of the input
with the values produced by <code>om$simulate(complete=TRUE)</code>. The
call of <code>sim_fn</code> will fit the same model assumed to simulate
the data. <code>fit_wham</code> saves the input used to fit the model
and <code>om$simulate(complete=TRUE)</code> will provide all model
output provided by <code>REPORT</code> calls in the cpp file. This
includes the true SSB for the simulated data which can be compared with
the values estimated from the simulated data.</p>
<p>Obviously for a simulation study many simulated data sets and model
fits are needed for a given operating model. There are many ways to
accomplish this task. It is often desirable to first simulate all the
data before fitting each of them and to update results with each fit so
that results are not lost if a catastrophic error occurs. Here is a
lo-tech approach to simulating many data inputs and save information
from fits of the same model to each of those data sets.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co">#more is better, but takes longer</span></span>
<span><span class="va">sim_inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fu">sim_fn</span><span class="op">(</span><span class="va">mod_1</span><span class="op">)</span>, simplify<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>reps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, par.est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, par.se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, adrep.est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, adrep.se <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sim_inputs</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"i: "</span>,<span class="va">i</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">tfit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">sim_inputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">$</span><span class="va">reps</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">tfit</span><span class="op">$</span><span class="va">rep</span></span>
<span>  <span class="co"># do.sdrep =TRUE to create these results</span></span>
<span>  <span class="co"># res$par.est[[i]] = as.list(tfit$sdrep, "Estimate")</span></span>
<span>  <span class="co"># res$par.se[[i]] = as.list(tfit$sdrep, "Std. Error")</span></span>
<span>  <span class="co"># res$adrep.est[[i]] = as.list(tfit$sdrep, "Estimate", report = TRUE)</span></span>
<span>  <span class="co"># res$adrep.se[[i]] = as.list(tfit$sdrep, "Std. Error", report = TRUE)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">res</span>, <span class="st">"self_test_res.RDS"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>replicate</code> function is used to generate 100 simulated
inputs. Then we loop over the simulated data sets, fit each of them and
save results for each fit. The results saved are the values provided by
<code>REPORT</code> calls in the cpp file, the fixed effects MLEs (and
PEBEs for random effects) and their standard errors, and the estimates
for values provided by <code>ADREPORT</code> calls in the cpp file and
their standard errors. See <code><a href="https://rdrr.io/pkg/TMB/man/as.list.sdreport.html" class="external-link">?TMB::as.list.sdreport</a></code> for more
information about accessing sdreport information like this. Saving these
attributes will allow one to make inferences about bias of the maximum
likelihood estimators, and corresponding standard errors, and confidence
interval coverage for the basic parameters as well as a variety of
derived model output (e.g., SSB, reference points).</p>
<p>Below is a plot of bias and 95% confidence intervals for SSB
estimation.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">true</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">sim_inputs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">SSB</span><span class="op">)</span></span>
<span><span class="va">est</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">reps</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">SSB</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">SSB_rel_resid</span> <span class="op">=</span> <span class="va">est</span><span class="op">/</span><span class="va">true</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="va">resid_cis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">SSB_rel_resid</span>,<span class="fl">1</span>,<span class="va">mean</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">SSB_rel_resid</span>,<span class="fl">1</span>,<span class="va">sd</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fl">2</span>,<span class="fl">44</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">n_sims</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">SSB_rel_resid</span>,<span class="fl">1</span>,<span class="va">mean</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span>,<span class="fl">0.05</span><span class="op">)</span>, ylab <span class="op">=</span> <span class="st">"Estimated Relative Bias SSB"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">resid_cis</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">resid_cis</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/ssb_rel_bias.png" style="width:80.0%"></p>
</div>
<div class="section level2">
<h2 id="fitting-a-model-different-from-the-operating-model">3. Fitting a model different from the operating model<a class="anchor" aria-label="anchor" href="#fitting-a-model-different-from-the-operating-model"></a>
</h2>
<p>When the fitted model is different from that used to simulate the
data, there is a bit more work involved. Some components of the input
used by <code>fit_wham</code> are important.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>  <span class="va">asap3</span>, </span>
<span>  selectivity <span class="op">=</span> <span class="va">selectivity</span>,</span>
<span>  NAA_re <span class="op">=</span> <span class="va">NAA_re</span>,</span>
<span>  model_name<span class="op">=</span><span class="st">"Ex 1: SNEMA Yellowtail Flounder"</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;  [1] "data"         "par"          "map"          "years"        "years_full"  </span></span>
<span><span class="co">#&gt;  [6] "ages.lab"     "model_name"   "asap3"        "log"          "options"     </span></span>
<span><span class="co">#&gt; [11] "stock_names"  "region_names" "fleet_names"  "index_names"  "years_Ecov"  </span></span>
<span><span class="co">#&gt; [16] "Ecov_names"   "random"       "call"</span></span></code></pre>
<p>Many of the elements of the input (e.g., <code>data</code>,
<code>par</code>, <code>map</code>, <code>random</code>) are those used
by TMB::MakeADFun to set up an objective function with derivative
information (i.e.,gradient, hessian) used by the optimizer nlminb in
fit_wham. We saw above that we could just swap the entire
<code>data</code> element of the input when the estimation model is the
same as the operating model. More generally though, components of these
4 input lists will need to be modified for the simulation studies where
the operating model and estimation model are not the same. If the
available data is the same for the operating and fitted model only a few
elements of the input$data list need to be moved.</p>
<div class="section level3">
<h3 id="a--an-alternative-age-composition-likelihood-for-the-estimating-model">3a. An alternative age composition likelihood for the estimating
model<a class="anchor" aria-label="anchor" href="#a--an-alternative-age-composition-likelihood-for-the-estimating-model"></a>
</h3>
<p>Below is an example where an alternative likelihood for the age
composition observations is assumed for the estimation model.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_em</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>  <span class="va">asap3</span>, </span>
<span>  recruit_model<span class="op">=</span><span class="fl">2</span>, </span>
<span>  model_name<span class="op">=</span><span class="st">"Ex 1: SNEMA Yellowtail Flounder"</span>,</span>
<span>  selectivity<span class="op">=</span><span class="va">selectivity</span>,</span>
<span>  NAA_re <span class="op">=</span> <span class="va">NAA_re</span>,</span>
<span>  age_comp <span class="op">=</span> <span class="st">"logistic-normal-miss0"</span><span class="op">)</span> <span class="co">#the only difference from original input</span></span>
<span></span>
<span><span class="co">#only eval the observations so that the other inputs for configuration are correct.</span></span>
<span><span class="co">#IMPORTANT TO PROVIDE obsvec!</span></span>
<span><span class="va">sim_fn</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">om</span>, <span class="va">input</span>, <span class="va">do.fit</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">obs_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_indices"</span>,<span class="st">"agg_catch"</span>,<span class="st">"catch_paa"</span>,<span class="st">"index_paa"</span>, <span class="st">"Ecov_obs"</span>, <span class="st">"obsvec"</span><span class="op">)</span></span>
<span>  <span class="va">om_data</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span>complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="va">obs_names</span><span class="op">]</span> <span class="op">=</span> <span class="va">om_data</span><span class="op">[</span><span class="va">obs_names</span><span class="op">]</span></span>
<span>  <span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_osa_obs.html">set_osa_obs</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span> <span class="co">#to transform catch and index paa appropriately</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">do.fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">om_data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">input</span>,<span class="va">om_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>By using do.fit = FALSE, we can see the difference between the age
composition observations that are fitted and those that were simulated.
The 4-9 elements correspond to the index age composition observations in
the first year:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">=</span> <span class="fu">sim_fn</span><span class="op">(</span><span class="va">mod_1</span>, <span class="va">input_em</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">obs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span> <span class="co">#data.frame of observations and identifying information</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">obsvec</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span> <span class="co">#showing obsvec that is simulated (multinomial frequencies)</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">obsvec</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span> <span class="co">#showing obsvec that is used (MVN = logistic normal)</span></span>
<span><span class="va">paa</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">index_paa</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="va">paa</span> <span class="co">#multinomial proportions : naa/sum(naa)</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">index_Neff</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">paa</span> <span class="co"># = simulated obsvec (multinomial frequencies)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">paa</span><span class="op">[</span><span class="op">-</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">paa</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span> <span class="co"># = inverse additive logistic transform for obsvec that is used</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;    year   fleet age     type        val ind cohort</span></span>
<span><span class="co">#&gt; 1     1 index_1  NA logindex 10.4147974   1     NA</span></span>
<span><span class="co">#&gt; 2     1 index_2  NA logindex  9.6452466   2     NA</span></span>
<span><span class="co">#&gt; 3     1 fleet_1  NA logcatch  9.7927340   3     NA</span></span>
<span><span class="co">#&gt; 4     1 index_1   1 indexpaa -0.6931472   4      0</span></span>
<span><span class="co">#&gt; 5     1 index_1   2 indexpaa  1.0986123   5     -1</span></span>
<span><span class="co">#&gt; 6     1 index_1   3 indexpaa  2.0149030   6     -2</span></span>
<span><span class="co">#&gt; 7     1 index_1   4 indexpaa  2.2512918   7     -3</span></span>
<span><span class="co">#&gt; 8     1 index_1   5 indexpaa  1.2527630   8     -4</span></span>
<span><span class="co">#&gt; 9     1 index_1   6 indexpaa         NA   9     -5</span></span>
<span><span class="co">#&gt; 10    1 index_2   1 indexpaa  1.3862944  10      0</span></span>
<span><span class="co">#&gt; [1]  1  6 15 19  7  2</span></span>
<span><span class="co">#&gt; [1] -0.6931472  1.0986123  2.0149030  2.2512918  1.2527630         NA</span></span>
<span><span class="co">#&gt; [1] 0.02 0.12 0.30 0.38 0.14 0.04</span></span>
<span><span class="co">#&gt; [1]  1  6 15 19  7  2</span></span>
<span><span class="co">#&gt; [1] -0.6931472  1.0986123  2.0149030  2.2512918  1.2527630</span></span></code></pre>
<p>The multinomial was used to simulate the observations and therefore
the observations are frequencies. The logistic normal expects
proportions, but there is an equivalent multivariate normal
transformation that is used to allow the OSA residuals to be calculated
efficiently so this is the form of the observations. Note that the last
age class is NA because the dimension of the MVN is one less than the
number of age classes due to the constraint of proportions summing to 1.
Similarly, the log transform of aggregate index and catch observations
(e.g., first three observations in the obs data.frame above) are
provided in the vector of observations (<code>obsvec</code>) used to fit
the model as those are treated as normal distributed observations.</p>
<p>Now go ahead and fit the simulated data.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">simfit</span> <span class="op">=</span> <span class="fu">sim_fn</span><span class="op">(</span><span class="va">mod_1</span>, <span class="va">input_em</span>, do.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">SSB</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"SSB"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/sim_fit_3a.png" style="width:80.0%"></p>
<p>It is very important that the <code>obsvec</code> component of the
simulated data is put into the input used for fitting because this holds
the values in <code>agg_catch</code>, <code>agg_indices</code>, etc. in
vector form for evaluating the likelihood. Having all observations in a
vector is necessary to allow one-step-ahead residuals to be calculated
using the TMB package. Note also because only a few elements are copied
into <code>input$data</code> we need to save all of the true values of
the simulated population as a separate component that is returned. For
this particular simulation, SSB is estimated greater than the truth when
the logistic normal is assumed but observations were generated by a
multinomial. The same sort of approach as above can be used for
simulating and fitting many data sets.</p>
</div>
<div class="section level3">
<h3 id="b--effective-sample-size-assumption">3b. Effective sample size assumption<a class="anchor" aria-label="anchor" href="#b--effective-sample-size-assumption"></a>
</h3>
<p>Suppose we wanted to see how the estimating model behaves when we
assume the multinomial age composition is more precise than it really
is. Here we assume we want to use all of the same parameter estimates
from the original model but change the necessary fixed data inputs. We
modify the input with the appropriate data and populate
<code>input$par</code> with the estimates from the original fit. Then we
create this alternative operating model by calling
<code>fit_wham(input, do.fit=F)</code> which creates the model
configuration with the dll so that data can be simulated with this
particular configuruation. Note that <code>do.fit=F</code> means that
whatever parameter values are set (normally as initial and fixed values)
in <code>input$par</code> will be used to simulate data. For the
estimating model we can use the same input as the operating model except
for changing the inputs for the effective sample size.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_fn</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">om</span>, <span class="va">Neff_om</span> <span class="op">=</span> <span class="fl">50</span>, <span class="va">Neff_em</span> <span class="op">=</span> <span class="fl">200</span>, <span class="va">do.fit</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">om_input</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="va">input</span> <span class="co">#the original input</span></span>
<span>  <span class="va">om_input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">index_Neff</span><span class="op">[</span><span class="op">]</span> <span class="op">=</span> <span class="va">Neff_om</span> <span class="co">#true effective sample size for the indices</span></span>
<span>  <span class="va">om_input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">catch_Neff</span><span class="op">[</span><span class="op">]</span> <span class="op">=</span> <span class="va">Neff_om</span> <span class="co">#true effective sample size for the indices</span></span>
<span>  <span class="va">om_input</span><span class="op">$</span><span class="va">par</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="va">parList</span> <span class="co">#as.list(om$sdrep, "Estimate") #assume parameter values estimated from original model</span></span>
<span>  <span class="va">om_alt</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">om_input</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co">#make unfitted model for simulating data</span></span>
<span>  <span class="va">om_data</span> <span class="op">=</span> <span class="va">om_alt</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span>complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">em_input</span> <span class="op">=</span> <span class="va">om_input</span> <span class="co">#the same configuration other than Neff</span></span>
<span>  <span class="va">em_input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">index_Neff</span><span class="op">[</span><span class="op">]</span> <span class="op">=</span> <span class="va">Neff_em</span> <span class="co">#assumed effective sample size for the indices</span></span>
<span>  <span class="va">em_input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">catch_Neff</span><span class="op">[</span><span class="op">]</span> <span class="op">=</span> <span class="va">Neff_em</span> <span class="co">#assumed effective sample size for the indices</span></span>
<span>  <span class="va">obs_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_indices"</span>,<span class="st">"agg_catch"</span>,<span class="st">"catch_paa"</span>,<span class="st">"index_paa"</span>, <span class="st">"Ecov_obs"</span>, <span class="st">"obsvec"</span><span class="op">)</span></span>
<span>  <span class="va">em_input</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="va">obs_names</span><span class="op">]</span> <span class="op">=</span> <span class="va">om_data</span><span class="op">[</span><span class="va">obs_names</span><span class="op">]</span></span>
<span>  <span class="va">em_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_osa_obs.html">set_osa_obs</a></span><span class="op">(</span><span class="va">em_input</span><span class="op">)</span> <span class="co">#to rescale the frequencies appropriately</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">do.fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">em_input</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">om_data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">em_input</span>,<span class="va">om_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We still need to reset the <code>obsvec</code> because the
frequencies are rescaled by the assumed multinomial sample size. Again,
we can check the observations are being used correctly by usingg do.fit
= FALSE:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">=</span> <span class="fu">sim_fn</span><span class="op">(</span><span class="va">mod_1</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">obs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span> <span class="co">#data.frame of observations and identifying information</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">obsvec</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span> <span class="co">#showing obsvec that is simulated (multinomial frequencies)</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">obsvec</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span> <span class="co">#showing obsvec that is used (MVN = logistic normal)</span></span>
<span><span class="va">paa</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">index_paa</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="op">]</span> <span class="co">#simulated paa</span></span>
<span><span class="va">paa</span> <span class="co">#multinomial proportions : naa/sum(naa)</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">index_paa</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="op">]</span> <span class="co">#paa in estimating model (the same)</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">index_Neff</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">paa</span> <span class="co"># = simulated obsvec (multinomial frequencies)</span></span>
<span><span class="va">sim</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">index_Neff</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">paa</span> <span class="co"># = em obsvec (multinomial frequencies with larger Neff)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;    year   fleet age     type        val ind cohort</span></span>
<span><span class="co">#&gt; 1     1 index_1  NA logindex 10.4147974   1     NA</span></span>
<span><span class="co">#&gt; 2     1 index_2  NA logindex  9.6452466   2     NA</span></span>
<span><span class="co">#&gt; 3     1 fleet_1  NA logcatch  9.7927340   3     NA</span></span>
<span><span class="co">#&gt; 4     1 index_1   1 indexpaa -0.6931472   4      0</span></span>
<span><span class="co">#&gt; 5     1 index_1   2 indexpaa  1.0986123   5     -1</span></span>
<span><span class="co">#&gt; 6     1 index_1   3 indexpaa  2.0149030   6     -2</span></span>
<span><span class="co">#&gt; 7     1 index_1   4 indexpaa  2.2512918   7     -3</span></span>
<span><span class="co">#&gt; 8     1 index_1   5 indexpaa  1.2527630   8     -4</span></span>
<span><span class="co">#&gt; 9     1 index_1   6 indexpaa         NA   9     -5</span></span>
<span><span class="co">#&gt; 10    1 index_2   1 indexpaa  1.3862944  10      0</span></span>
<span><span class="co">#&gt; [1]  1  6 15 19  7  2</span></span>
<span><span class="co">#&gt; [1] -0.6931472  1.0986123  2.0149030  2.2512918  1.2527630         NA</span></span>
<span><span class="co">#&gt; [1] 0.02 0.12 0.30 0.38 0.14 0.04</span></span>
<span><span class="co">#&gt; [1] 0.02 0.12 0.30 0.38 0.14 0.04</span></span>
<span><span class="co">#&gt; [1]  1  6 15 19  7  2</span></span>
<span><span class="co">#&gt; [1]  1  6 15 19  7  2</span></span></code></pre>
<p>We can see that the proportions at age are the same between the
operating and estimating model, but the frequencies in the estimating
model are 4 times those in the operating model because we are assuming
the effective sample size is 4 times the true value.</p>
<p>Now go ahead and fit the simulated data.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">simfit</span> <span class="op">=</span> <span class="fu">sim_fn</span><span class="op">(</span><span class="va">mod_1</span>, do.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">SSB</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"SSB"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/sim_fit_3b.png" style="width:80.0%"></p>
<p>The incorrect age composition precision has a large effect here! Note
that we could make the assumed effective sample size only incorrect for
some subset of the fleets and indices. Note that changing the Neff will
only affect fits to those indices and fleets where the multinomial age
comp assumption is made and where age composition observations are
available.</p>
</div>
<div class="section level3">
<h3 id="c--population-assumptions">3c. Population assumptions<a class="anchor" aria-label="anchor" href="#c--population-assumptions"></a>
</h3>
<p>Suppose we wanted to evaluate the effect of assuming a model with
just random effects on recruitment when a full state-space model was the
operating model. We will fit the full state-space model to the example
data to get a configuration for the operating model then simulate data
from it and fit the recruitment-only model to it.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">NAA_re_om</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  sigma<span class="op">=</span><span class="st">"rec+1"</span>, <span class="co">#random effects for recruitment and older age classes</span></span>
<span>  cor<span class="op">=</span><span class="st">"iid"</span>, <span class="co">#random effects are independent</span></span>
<span>  recruit_model <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co">#mean recruitment is the only fixed effect parameter</span></span>
<span></span>
<span><span class="va">NAA_re_em</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  sigma<span class="op">=</span><span class="st">"rec"</span>, <span class="co">#random effects for recruitment only</span></span>
<span>  cor<span class="op">=</span><span class="st">"iid"</span>, <span class="co">#random effects are independent</span></span>
<span>  recruit_model <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co">#mean recruitment is the only fixed effect parameter</span></span>
<span></span>
<span><span class="va">input_om</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>    <span class="va">asap3</span>, </span>
<span>    selectivity <span class="op">=</span> <span class="va">selectivity</span>,</span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_re_om</span>,</span>
<span>    model_name<span class="op">=</span><span class="st">"Ex 1: SNEMA Yellowtail Flounder"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">input_em</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>    <span class="va">asap3</span>, </span>
<span>    selectivity <span class="op">=</span> <span class="va">selectivity</span>,</span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_re_em</span>,</span>
<span>    model_name<span class="op">=</span><span class="st">"Ex 1: SNEMA Yellowtail Flounder"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">om_ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input_om</span>, do.osa <span class="op">=</span> <span class="cn">F</span>, do.retro<span class="op">=</span><span class="cn">F</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="co"># don't do retro peels and OSA residuals, don't show output during optimization</span></span>
<span></span>
<span><span class="co">#no differences in treatment of observations</span></span>
<span><span class="va">sim_fn</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">om</span>, <span class="va">input</span>, <span class="va">do.fit</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">obs_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_indices"</span>,<span class="st">"agg_catch"</span>,<span class="st">"catch_paa"</span>,<span class="st">"index_paa"</span>, <span class="st">"Ecov_obs"</span>, <span class="st">"obsvec"</span><span class="op">)</span></span>
<span>    <span class="va">om_data</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span>complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="va">obs_names</span><span class="op">]</span> <span class="op">=</span> <span class="va">om_data</span><span class="op">[</span><span class="va">obs_names</span><span class="op">]</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">do.fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">om_data</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">input</span>,<span class="va">om_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">simfit</span> <span class="op">=</span> <span class="fu">sim_fn</span><span class="op">(</span><span class="va">om_ss</span>, <span class="va">input_em</span>, do.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">om_ss</span><span class="op">$</span><span class="va">years</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">SSB</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"SSB"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">om_ss</span><span class="op">$</span><span class="va">years</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/sim_fit_3c.png" style="width:80.0%"></p>
<p>The scale of the population estimates from the recruitment-only model
is similar to the true value, but it does not have sufficient
flexibility to capture the inter-annual variability in the population
size and terminal year stock size is very different.</p>
</div>
<div class="section level3">
<h3 id="d--selectivity-assumptions">3d. Selectivity assumptions<a class="anchor" aria-label="anchor" href="#d--selectivity-assumptions"></a>
</h3>
<p>Suppose the true selectivity is that estimated from the original
model, but that we wanted to evaluate the effect of assuming logistic
selectivity. Use the same <code>NAA_re</code> defined earlier but change
the selectivity</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">selectivity_em</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fleets</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  initial_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fleets</span> <span class="op">+</span> <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span><span class="op">)</span> <span class="co">#fleet, index</span></span>
<span></span>
<span><span class="va">input_em</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>    <span class="va">asap3</span>, </span>
<span>    selectivity <span class="op">=</span> <span class="va">selectivity_em</span>,</span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_re</span>,</span>
<span>    model_name<span class="op">=</span><span class="st">"Ex 1: SNEMA Yellowtail Flounder"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">sim_fn</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">om</span>, <span class="va">input</span>, <span class="va">do.fit</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">obs_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_indices"</span>,<span class="st">"agg_catch"</span>,<span class="st">"catch_paa"</span>,<span class="st">"index_paa"</span>, <span class="st">"Ecov_obs"</span>, <span class="st">"obsvec"</span><span class="op">)</span></span>
<span>    <span class="va">om_data</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span>complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="va">obs_names</span><span class="op">]</span> <span class="op">=</span> <span class="va">om_data</span><span class="op">[</span><span class="va">obs_names</span><span class="op">]</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">do.fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">om_data</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">input</span>,<span class="va">om_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">simfit</span> <span class="op">=</span> <span class="fu">sim_fn</span><span class="op">(</span><span class="va">mod_1</span>, <span class="va">input_em</span>, do.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">SSB</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"SSB"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/sim_fit_3d_1.png" style="width:80.0%"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">SSB</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">simfit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">log_SSB_FXSPR</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"SSB/SSB(F40)"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mod_1</span><span class="op">$</span><span class="va">years</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">simfit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">log_SSB_FXSPR</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/sim_fit_3d_2.png" style="width:80.0%"></p>
<p>Lower SSB and stock status are estimated if logistic selectivity is
assumed.</p>
</div>
</div>
<div class="section level2">
<h2 id="creating-a-general-operating-model-without-an-asap3-dat-file">4. Creating a general operating model without an ASAP3 dat file<a class="anchor" aria-label="anchor" href="#creating-a-general-operating-model-without-an-asap3-dat-file"></a>
</h2>
<p>Note that the simulated data are conditioned on the fixed effects
parameter values. If a model is fitted using <code>fit_wham</code> then
the optimized values will be used by <code>mod$simulate</code> for
simulations, but these parameters can be specified without fitting the
model and simulations can be more generally configured. Here we will use
the functionality of <code>prepare_wham_input</code> to create a model
object without an asap3 dat file and, then set parameter values we want
to assume for the operating model</p>
<p>First we will read in a function <code>make_info</code> that will
make a list that can be provided to the <code>basic_info</code> ,
<code>catch_info</code>, and <code>index_info</code> arguments of
<code>prepare_wham_input</code>. The elements of the output it provides
are defined in the help file for <code>prepare_wham_input</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_info</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">base_years</span> <span class="op">=</span> <span class="fl">1982</span><span class="op">:</span><span class="fl">2021</span>, <span class="va">ages</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="va">Fhist</span> <span class="op">=</span> <span class="st">"updown"</span>, <span class="va">n_feedback_years</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span> <span class="co">#changed years</span></span>
<span>    <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">info</span><span class="op">$</span><span class="va">ages</span> <span class="op">&lt;-</span> <span class="va">ages</span></span>
<span>    <span class="va">info</span><span class="op">$</span><span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">base_years</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">base_years</span><span class="op">)</span> <span class="op">+</span> <span class="va">n_feedback_years</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">na</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span></span>
<span>    <span class="va">ny</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">info</span><span class="op">$</span><span class="va">years</span><span class="op">)</span></span>
<span>    <span class="va">info</span><span class="op">$</span><span class="va">n_regions</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span>    <span class="va">info</span><span class="op">$</span><span class="va">n_stocks</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span>    <span class="va">nby</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">base_years</span><span class="op">)</span></span>
<span>    <span class="va">mid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">nby</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="co">#up then down</span></span>
<span></span>
<span>    <span class="va">catch_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span>    <span class="va">catch_info</span><span class="op">$</span><span class="va">catch_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="va">ny</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span><span class="op">)</span></span>
<span>    <span class="va">catch_info</span><span class="op">$</span><span class="va">catch_Neff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">200</span>, <span class="va">ny</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">F_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">Fhist</span> <span class="op">==</span> <span class="st">"updown"</span><span class="op">)</span> <span class="va">F_info</span><span class="op">$</span><span class="cn">F</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span>,length.out <span class="op">=</span> <span class="va">mid</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.4</span>,<span class="fl">0</span>,length.out<span class="op">=</span><span class="va">nby</span><span class="op">-</span><span class="va">mid</span><span class="op">)</span><span class="op">)</span>,<span class="va">nby</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">#down then up</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">Fhist</span> <span class="op">==</span> <span class="st">"downup"</span><span class="op">)</span> <span class="va">F_info</span><span class="op">$</span><span class="cn">F</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.4</span>,<span class="fl">0</span>,length.out <span class="op">=</span> <span class="va">mid</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span>,length.out<span class="op">=</span><span class="va">nby</span><span class="op">-</span><span class="va">mid</span><span class="op">)</span><span class="op">)</span>,<span class="va">nby</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">n_feedback_years</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span> <span class="va">F_info</span><span class="op">$</span><span class="cn">F</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">F_info</span><span class="op">$</span><span class="cn">F</span>, <span class="va">F_info</span><span class="op">$</span><span class="cn">F</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">nby</span>, <span class="va">n_feedback_years</span><span class="op">)</span>,, drop <span class="op">=</span> <span class="cn">F</span><span class="op">]</span><span class="op">)</span> <span class="co">#same F as terminal year for feedback period</span></span>
<span></span>
<span>    <span class="va">index_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span>    <span class="va">index_info</span><span class="op">$</span><span class="va">index_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="va">ny</span>, <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span></span>
<span>    <span class="va">index_info</span><span class="op">$</span><span class="va">index_Neff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">100</span>, <span class="va">ny</span>, <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span></span>
<span>    <span class="va">index_info</span><span class="op">$</span><span class="va">fracyr_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">ny</span>, <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span></span>
<span>    <span class="va">index_info</span><span class="op">$</span><span class="va">index_units</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span><span class="op">)</span> <span class="co">#biomass</span></span>
<span>    <span class="va">index_info</span><span class="op">$</span><span class="va">index_paa_units</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span><span class="op">)</span> <span class="co">#abundance</span></span>
<span>    <span class="va">index_info</span><span class="op">$</span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">info</span><span class="op">$</span><span class="va">maturity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">na</span> <span class="op">-</span> <span class="va">na</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="va">na</span>, <span class="va">ny</span><span class="op">)</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">ny</span>, <span class="va">na</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">100</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.3</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">na</span> <span class="op">-</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">11</span><span class="op">)</span><span class="op">*</span><span class="va">L</span><span class="op">^</span><span class="fl">3</span></span>
<span>    <span class="va">nwaa</span> <span class="op">&lt;-</span> <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span> <span class="op">+</span> <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span> <span class="op">+</span> <span class="fl">2</span></span>
<span>    <span class="va">info</span><span class="op">$</span><span class="va">waa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nwaa</span>, <span class="va">ny</span>, <span class="va">na</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nwaa</span><span class="op">)</span> <span class="va">info</span><span class="op">$</span><span class="va">waa</span><span class="op">[</span><span class="va">i</span>,,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">W</span>, <span class="va">na</span>, <span class="va">ny</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">info</span><span class="op">$</span><span class="va">fracyr_SSB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="va">ny</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">catch_info</span><span class="op">$</span><span class="va">selblock_pointer_fleets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span>, <span class="va">ny</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">index_info</span><span class="op">$</span><span class="va">selblock_pointer_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span>, <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span>, <span class="va">ny</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>basic_info <span class="op">=</span> <span class="va">info</span>, catch_info <span class="op">=</span> <span class="va">catch_info</span>, index_info <span class="op">=</span> <span class="va">index_info</span>, F <span class="op">=</span> <span class="va">F_info</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Various attributes are specified in the <code>make_info</code>
function including the number of fleets and indices, the years over
which the model spans, the number of ages, precision of aggregate catch
and index observations. Maturity and weight at age are defined as well
as catchabilities for the indices, when they occur during the year and
the selectivity blocks to assign to each fleet and index. The function
creates a list of four lists that are arguments to
<code>prepare_wham_input</code>: <code>basic_info</code>,
<code>catch_info</code>, <code>index_info</code>, and <code>F</code>.
The potential elements that might be supplied to these arguments are
described in the help files for <code>prepare_wham_input</code> and
helper functions <code>set_*</code>.</p>
<p>Many other necessary attributes and initial parameters can be defined
using the arguments <code>NAA_re</code>, <code>selectivity</code>,
<code>M</code>, <code>catchability</code>, or <code>move</code> (when
there is more than 1 region) to <code>prepare_wham_input</code>. Below
we specify logistic selectivity and associated parameters (<span class="math inline">\(a_{50}\)</span> and slope), M = 0.2, initial
numbers at age, and mean recruitment all using the lists supplied to
these arguments of prepare_wham_input. We also specify a value for the
standard deviation of the (log) recruitment random effects (<span class="math inline">\(\sigma_R = 0.5\)</span>). Importantly,
<code>fit_wham</code> must be called with <code>do.fit=FALSE</code> to
set up the model to be simulated with the parameter values specified
rather than estimated.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stock_om_info</span> <span class="op">&lt;-</span> <span class="fu">make_info</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">basic_info</span> <span class="op">&lt;-</span> <span class="va">stock_om_info</span><span class="op">$</span><span class="va">basic_info</span></span>
<span><span class="va">catch_info</span> <span class="op">&lt;-</span> <span class="va">stock_om_info</span><span class="op">$</span><span class="va">catch_info</span></span>
<span><span class="va">index_info</span> <span class="op">&lt;-</span> <span class="va">stock_om_info</span><span class="op">$</span><span class="va">index_info</span></span>
<span><span class="va">F_info</span> <span class="op">&lt;-</span> <span class="va">stock_om_info</span><span class="op">$</span><span class="cn">F</span></span>
<span></span>
<span><span class="va">selectivity_om</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  initial_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span> <span class="op">+</span> <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="co">#fleet, index</span></span>
<span></span>
<span><span class="va">M_om</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial_means <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.2</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">NAA_re_om</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  N1_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="va">M_om</span><span class="op">$</span><span class="va">initial_means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  sigma <span class="op">=</span> <span class="st">"rec"</span>, <span class="co">#random about mean</span></span>
<span>  cor<span class="op">=</span><span class="st">"iid"</span>, <span class="co">#random effects are independent</span></span>
<span>  recruit_model <span class="op">=</span> <span class="fl">2</span>, <span class="co">#random effects with a constant mean</span></span>
<span>  recruit_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  sigma_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co">#sigma_R, only the value in the first age class is used.</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">stock_om_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>  basic_info <span class="op">=</span> <span class="va">basic_info</span>, </span>
<span>  selectivity <span class="op">=</span> <span class="va">selectivity_om</span>, </span>
<span>  NAA_re <span class="op">=</span> <span class="va">NAA_re_om</span>, </span>
<span>  catch_info <span class="op">=</span> <span class="va">catch_info</span>,</span>
<span>  index_info <span class="op">=</span> <span class="va">index_info</span>,</span>
<span>  M <span class="op">=</span> <span class="va">M_om</span>,</span>
<span>    F <span class="op">=</span> <span class="va">F_info</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#stock_om &lt;- fit_wham(stock_om_input, do.fit = FALSE, MakeADFun.silent = TRUE)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#n_stock x n_regions x n_ages array</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">stock_om_input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">log_NAA_sigma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="co">#Rsigma</span></span>
<span><span class="co">#&gt; [1] 0.5</span></span></code></pre></div>
<div class="section level3">
<h3 id="a--setting-naa-random-effects-variance-parameters-">4a. Setting NAA random effects variance parameters.<a class="anchor" aria-label="anchor" href="#a--setting-naa-random-effects-variance-parameters-"></a>
</h3>
<p>Here we will consider a 2d AR1 autoregressing model for the numbers
at age random effects to demonstrate setting the parameters. We will
suppose that we want to assume (or initialize) standard deviations of
0.6 for recruitment and 0.2 for older ages. When random effects are
assumed for both recruitment and survival transitions of older age
classes, wham now decouples these two types of random effects so they
are independent. We will assume correlation of 0.7 with age for age
greater than recruitment and correlations of 0.4 and 0.6, temporally,
for survival transitions and recruitment, respectively. There are two
parameter elements that we need to consider when using these random
effects: <code>log_NAA_sigma</code> as mentioned above and
<code>trans_NAA_rho</code> which defines the autocorrelation parameters
on a logit scale with the parameter bounds of (-1,1). These parameters
can be set using the <code>NAA_re</code> argument to
<code>prepare_wham_input</code>. See the help file for
<code>set_NAA</code>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">NAA_re_om</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  N1_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="va">M_om</span><span class="op">$</span><span class="va">initial_means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  sigma <span class="op">=</span> <span class="st">"rec+1"</span>, <span class="co">#random about mean</span></span>
<span>  cor<span class="op">=</span><span class="st">"2dar1"</span>, <span class="co">#random effects correlated among age classes and across time (separably)</span></span>
<span>  recruit_model <span class="op">=</span> <span class="fl">2</span>, <span class="co">#random effects with a constant mean</span></span>
<span>  decouple_recruitment <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">#default value</span></span>
<span>  recruit_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  sigma_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="co">#sigma_R and sigma_2+</span></span>
<span>  cor_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="co">#age, then year (2+, then recruitment)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">stock_om_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>  basic_info <span class="op">=</span> <span class="va">basic_info</span>, </span>
<span>  selectivity <span class="op">=</span> <span class="va">selectivity_om</span>, </span>
<span>  NAA_re <span class="op">=</span> <span class="va">NAA_re_om</span>, </span>
<span>  catch_info <span class="op">=</span> <span class="va">catch_info</span>,</span>
<span>  index_info <span class="op">=</span> <span class="va">index_info</span>,</span>
<span>  M <span class="op">=</span> <span class="va">M_om</span>,</span>
<span>    F <span class="op">=</span> <span class="va">F_info</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#or equivalently</span></span>
<span><span class="co">#stock_om_input &lt;- set_NAA(stock_om_input, NAA_re_om)</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#n_stock x n_regions x 3 array</span></span>
<span><span class="va">stock_om_input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">trans_NAA_rho</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 1.7346011 0.8472979 1.3862944</span></span>
<span><span class="fu">wham</span><span class="fu">:::</span><span class="fu">gen.logit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>,<span class="fl">0.4</span>,<span class="fl">0.6</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="co">#age first, year (2+) second, year (rec) third</span></span>
<span><span class="co">#&gt; [1] 1.7346011 0.8472979 1.3862944</span></span></code></pre></div>
<p>Note we made use of an unexported function from the wham package that
can do the transformation of parameters estimated on the logit scale.
Note also, that the correlation parameter for age is first and those for
time are second and third in the <code>trans_NAA_rho</code> vector. If
<code>cor = 'ar1_a'</code> only the first parameter in
<code>trans_NAA_rho</code> is used and if <code>cor = 'ar1_y'</code>
only the second and third parameters are used. Other values are set to
zero automatically so the random effects independent in the appropriate
way. Now if we built the operating model:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stock_om</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">stock_om_input</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>calling <code>stock_om$simulate()</code> will use the variance anc
correlation as we specified.</p>
</div>
<div class="section level3">
<h3 id="b--setting-m-random-effects-variance-parameters">4b. Setting M random effects variance parameters<a class="anchor" aria-label="anchor" href="#b--setting-m-random-effects-variance-parameters"></a>
</h3>
<p>M random effects assumptions are similar to the NAA random effects,
but the parameter names are different. For M there is an array (n_stocks
x n_regions x 3) <code>M_repars</code> of values that define the
transformed M variance and autoregressing parameters. for a given stock
and region, the three parameters are standard deviation, correlation
with age, correlation with year. Here we assume we have random effects
on recruitment and on natural mortality. As above, we define the general
model to have 2dAR1 for M random effects for the most general case with
variance of the (log) M random effects = 0.1 and correlations with age
and time of 0.7 and 0.4. However, we can use the <code>M</code> argument
to <code>prepare_wham_input</code> to specify many of these
configurations. See the help file for <code>set_M</code>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">M_om</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  re_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="st">"ar1_ay"</span>, <span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>    initial_means <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.2</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    sigma_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>    cor_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>,<span class="fl">0.4</span><span class="op">)</span>,dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span><span class="va">NAA_re_om</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  N1_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="va">M_om</span><span class="op">$</span><span class="va">initial_means</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  sigma <span class="op">=</span> <span class="st">"rec"</span>, <span class="co">#random about mean</span></span>
<span>  recruit_model <span class="op">=</span> <span class="fl">2</span>, <span class="co">#random effects with a constant mean</span></span>
<span>  sigma_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="co">#sigma_R</span></span>
<span>  recruit_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">stock_om_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>  basic_info <span class="op">=</span> <span class="va">basic_info</span>, </span>
<span>  selectivity <span class="op">=</span> <span class="va">selectivity_om</span>, </span>
<span>  NAA_re <span class="op">=</span> <span class="va">NAA_re_om</span>, </span>
<span>  catch_info <span class="op">=</span> <span class="va">catch_info</span>,</span>
<span>  index_info <span class="op">=</span> <span class="va">index_info</span>,</span>
<span>  M <span class="op">=</span> <span class="va">M_om</span>,</span>
<span>    F <span class="op">=</span> <span class="va">F_info</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#or equivalently</span></span>
<span><span class="co">#stock_om_input &lt;- set_NAA(stock_om_input, NAA_re_om)</span></span>
<span><span class="co">#stock_om_input &lt;- set_M(stock_om_input, M_om)</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#n_stock x n_regions x 3 array</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">stock_om_input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">log_NAA_sigma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="co">#Rsigma</span></span>
<span><span class="co">#&gt; [1] 0.6</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">stock_om_input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">M_repars</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="co">#</span></span>
<span><span class="co">#&gt; [1] 0.2</span></span>
<span></span>
<span><span class="va">stock_om_input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">M_repars</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 1.7346011 0.8472979</span></span>
<span><span class="fu">wham</span><span class="fu">:::</span><span class="fu">gen.logit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>,<span class="fl">0.4</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="co">#age first, year second</span></span>
<span><span class="co">#&gt; [1] 1.7346011 0.8472979</span></span>
<span></span>
<span><span class="co">#stock_om = fit_wham(stock_om_input, do.fit = FALSE, MakeADFun.silent = TRUE)</span></span></code></pre></div>
<p>Note that the initial values for the mean of the M autoregressing
random effects is defined by the <code>initial_means</code> component of
the <code>M</code> argument to <code>prepare_wham_input</code>. These
mean parameters are not estimated by default, and so therefore are fixed
at these initial values. To estimate the mean of the M random effects at
age, or just estimate a constant M without random effects, specify
<code>M$mean_model = "estimate-M"</code>. The default is to estimate a
single value for each stock, but to estimates different mean parameters
across age (and possibly stock and region) specify
<code>M$means_map</code> as an array (n_stock x n_regions x n_ages)
where shared parameters (e.g., all ages) should have the same value.
There is a difference from numbers at age in how random effects for M
are specified. If <code>M$re = "ar_a"</code>, then there are only
<code>n_ages</code> random effects that are constant over time.
Similarly for <code>M$re = "ar_y"</code>, there are
<code>n_years_model</code> random effects that are used for each age
class. Setting the variance and correlation parameters is similar to
that for numbers at age random effects. To get <code>ar_a</code> or
<code>ar_y</code> models analogous to numbers at age, one would have to
specify <code>M$re = "2dar1"</code> and set <code>M$cor_map</code> to
fix the appropriate parameter fixed at 0. To force random effects for
certain age classes to be the same, one can configure
<code>M$re_map</code> appropriately.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">M_om</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  mean_model <span class="op">=</span> <span class="st">"estimate-M"</span>,</span>
<span>  re_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="st">"ar1_ay"</span>, <span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>    initial_means <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.2</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="co">#means_map = array(1, dim(c(1,1,, length(basic_info$ages)))), #one parameters for all ages (the default)</span></span>
<span>    sigma_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>    cor_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>,<span class="fl">0.4</span><span class="op">)</span>,dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stock_om_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>  basic_info <span class="op">=</span> <span class="va">basic_info</span>, </span>
<span>  selectivity <span class="op">=</span> <span class="va">selectivity_om</span>, </span>
<span>  NAA_re <span class="op">=</span> <span class="va">NAA_re_om</span>, </span>
<span>  catch_info <span class="op">=</span> <span class="va">catch_info</span>,</span>
<span>  index_info <span class="op">=</span> <span class="va">index_info</span>,</span>
<span>  M <span class="op">=</span> <span class="va">M_om</span>,</span>
<span>    F <span class="op">=</span> <span class="va">F_info</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#or equivalently</span></span>
<span><span class="co">#stock_om_input &lt;- set_M(stock_om_input, M_om)</span></span>
<span><span class="va">stock_om_input</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">Mpars</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="c--setting-selectivity-random-effects-variance-parameters">4c. Setting selectivity random effects variance parameters<a class="anchor" aria-label="anchor" href="#c--setting-selectivity-random-effects-variance-parameters"></a>
</h3>
<p>Setting the variance parameters for selectivity random effects is
analogous to that for natural mortality random effects. The important
difference is that the parameter object defining the random effects
variance parameters (<code>sel_repars</code>) is a matrix with rows for
each selectivity block and the 3 columns as defined for
<code>M_repars</code>. Here we have two selectivity blocks: one for the
fleet and one for the index. We will assume that the variance parameter
for the fleet is 0.4 and that for the index is 0.1, but they both have
the same correlation parameters with age and time: 0.7 and 0.4. See the
help file for <code>set_selectivity</code>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selectivity_om</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  initial_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span> <span class="op">+</span> <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span>,</span>
<span>  re <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"2dar1"</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span> <span class="op">+</span> <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span>,</span>
<span>  sigma_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>,<span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  cor_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.7</span>,<span class="fl">2</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.4</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="co">#remove random effects on M</span></span>
<span><span class="va">M_om</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  initial_means <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.2</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">stock_om_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>  basic_info <span class="op">=</span> <span class="va">basic_info</span>, </span>
<span>  selectivity <span class="op">=</span> <span class="va">selectivity_om</span>, </span>
<span>  NAA_re <span class="op">=</span> <span class="va">NAA_re_om</span>, </span>
<span>  catch_info <span class="op">=</span> <span class="va">catch_info</span>,</span>
<span>  index_info <span class="op">=</span> <span class="va">index_info</span>,</span>
<span>  M <span class="op">=</span> <span class="va">M_om</span>,</span>
<span>    F <span class="op">=</span> <span class="va">F_info</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#or equivalently</span></span>
<span><span class="co">#stock_om_input &lt;- set_M(stock_om_input, M_om)</span></span>
<span><span class="co">#stock_om_input &lt;- set_selectivity(stock_om_input, selectivity_om)</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stock_om_input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">sel_repars</span></span>
<span><span class="co">#&gt;            [,1]     [,2]      [,3]</span></span>
<span><span class="co">#&gt; [1,] -0.9162907 1.734601 0.8472979</span></span>
<span><span class="co">#&gt; [2,] -2.3025851 1.734601 0.8472979</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.4</span><span class="op">)</span>, <span class="fu">wham</span><span class="fu">:::</span><span class="fu">gen.logit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>,<span class="fl">0.4</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>, <span class="fu">wham</span><span class="fu">:::</span><span class="fu">gen.logit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>,<span class="fl">0.4</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;            [,1]     [,2]      [,3]</span></span>
<span><span class="co">#&gt; [1,] -0.9162907 1.734601 0.8472979</span></span>
<span><span class="co">#&gt; [2,] -2.3025851 1.734601 0.8472979</span></span></code></pre></div>
<p>Note in this case where we assume logistic selectivity and 2D AR1
random effects, the correlation with â€œageâ€ is actually just the
correlation of the two logistic selectivity parameters on their
estimated/transformed scale. Also, differing from natural mortality the
mean parameters for the selectivity random effects
(<code>logit_selpars</code>) are estimated by default.</p>
</div>
<div class="section level3">
<h3 id="d--setting-catchability-random-effects-variance-parameters-">4d. Setting catchability random effects variance parameters.<a class="anchor" aria-label="anchor" href="#d--setting-catchability-random-effects-variance-parameters-"></a>
</h3>
<p>Setting the variance parameters for catchability is analogous to that
for natural mortality and selectivity random effects. The parameters
defining the variance and correlation of the annual catchability are
defined in <code>q_repars</code> which is a matrix with rows
corresponding to different indices and 2 columns for the standard
deviation and correlation. The mean of the process is defined and
estimated in the <code>logit_q</code> parameter which is defined in the
<code>make_basic_info</code> function. Here we will assume the
transformed catchability is an AR1 process with standard deviation 0.1
and autocorrelation = 0.5.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selectivity_om</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  initial_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="va">catch_info</span><span class="op">$</span><span class="va">n_fleets</span> <span class="op">+</span> <span class="va">index_info</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="va">catchability_om</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    re <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>    sigma_vals <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    cor_vals <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="co">#could also define the mean q parameter here.</span></span>
<span></span>
<span><span class="va">stock_om_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>  basic_info <span class="op">=</span> <span class="va">basic_info</span>, </span>
<span>  selectivity <span class="op">=</span> <span class="va">selectivity_om</span>, </span>
<span>  NAA_re <span class="op">=</span> <span class="va">NAA_re_om</span>, </span>
<span>  catch_info <span class="op">=</span> <span class="va">catch_info</span>,</span>
<span>  index_info <span class="op">=</span> <span class="va">index_info</span>,</span>
<span>  catchability <span class="op">=</span> <span class="va">catchability_om</span>,</span>
<span>  M <span class="op">=</span> <span class="va">M_om</span>,</span>
<span>    F <span class="op">=</span> <span class="va">F_info</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#or equivalently</span></span>
<span><span class="co">#stock_om_input &lt;- set_selectivity(stock_om_input, selectivity_om)</span></span>
<span><span class="co">#stock_om_input &lt;- set_q(stock_om_input, catchability_om)</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stock_om_input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">q_repars</span></span>
<span><span class="co">#&gt;           [,1]     [,2]</span></span>
<span><span class="co">#&gt; [1,] -2.302585 1.098612</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>, <span class="fu">wham</span><span class="fu">:::</span><span class="fu">gen.logit</span><span class="op">(</span><span class="fl">0.5</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -2.302585  1.098612</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stock_om</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">stock_om_input</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sim_q</span> <span class="op">=</span> <span class="va">stock_om</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span>complete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span>, <span class="va">sim_q</span><span class="op">$</span><span class="va">q</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"Catchability"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/sim_plot_4d.png" style="width:80.0%"></p>
</div>
<div class="section level3">
<h3 id="e--setting-effects-of-environmental-covariates-">4e. Setting effects of environmental covariates.<a class="anchor" aria-label="anchor" href="#e--setting-effects-of-environmental-covariates-"></a>
</h3>
<p>When environmental effects are considered, there are assumptions to
be made about the variance and any autocorrelation parameters for the
random effects for the latent environmental process and the variance of
the observation errors. The latter are specified in the the
<code>ecov$log_sigma</code> argument to <code>prepare_wham_input</code>
and those for the random effects (<code>Ecov_process_pars</code>) are
specified the <code>ecov$process_mean_vals</code>,
<code>ecov$process_sig_vals</code>, and
<code>ecov$process_cor_vals</code> arguments. The value for the effect
of the covariate on recruitment (<code>Ecov_beta_R</code>) are specified
in <code>ecov$beta_R_vals</code>. The columns of
<code>Ecov_process_pars</code> correspond to each environmental
covariate being modeled and the number of rows is 3. If
<code>ecov$process_model = "rw"</code> only the first two elements are
used and represent the value in the first year and the conditional
standard deviation parameter of the random walk. When
<code>ecov$process_model = "ar1"</code> the three elements correspond to
mean, variance, and correlation parameters.</p>
<p>The <code>Ecov_beta</code> parameter is a 4-dimensional array to be
able to use it across all possible types of effects in a wham model. The
first dimension indicates where the effect will be applied: recruitment,
natural mortality, index 1,â€¦ index n.Â The second dimension is the order
of the polynomial effect of the covariate. The third dimension indicates
which environmental covariate the effect is having on the population.
The fourth dimension indicates which age class the effect is on (for
natural mortality only).</p>
<p>As long as there is only a single environmental effect, we can change
the appropriate element of the <code>Ecov_beta</code> array by using the
<code>map$Ecov_beta</code> specification returned by
<code>prepare_wham_input</code>. The <code>map$Ecov_beta</code> will be
all <code>NA</code> except for the configured effects on the population
and when there is just one there is no ambiguity. Otherwise, the 4
correct indices of the <code>Ecov_beta</code> array must be referenced
appropriately for each effect.</p>
<p>We will assume that our errors on the observations of the
environmental covariate have a standard deviation = 0.2, the latent
process is AR1 with mean 0, standard deviation = 0.3 and correlation
parameter 0.5. We will also assume the effect is on (log) recruitment
(no stock-recruit function) and the size of the effect is
<code>Ecov_beta = 0.3</code>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">ecov_om</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"Climate variable 1"</span>,</span>
<span>    process_model <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>    process_mean_vals <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    process_sig_vals <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>    process_cor_vals <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co">#observations which will be simulated later</span></span>
<span>    logsigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span>, </span>
<span>    year <span class="op">=</span> <span class="va">basic_info</span><span class="op">$</span><span class="va">years</span>, </span>
<span>    use_obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span>,  </span>
<span>    recruitment_how <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="st">"controlling-lag-0-linear"</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>    beta_R_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.3</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="op">)</span></span>
<span></span>
<span><span class="va">stock_om_input</span> <span class="op">=</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>    basic_info <span class="op">=</span> <span class="va">basic_info</span>, </span>
<span>    selectivity <span class="op">=</span> <span class="va">selectivity_om</span>, </span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_re_om</span>, </span>
<span>    M <span class="op">=</span> <span class="va">M_om</span>, </span>
<span>  catch_info <span class="op">=</span> <span class="va">catch_info</span>,</span>
<span>  index_info <span class="op">=</span> <span class="va">index_info</span>,</span>
<span>    ecov <span class="op">=</span> <span class="va">ecov_om</span>,</span>
<span>    F <span class="op">=</span> <span class="va">F_info</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#or equivalently</span></span>
<span><span class="co">#stock_om_input &lt;- set_ecov(stock_om_input, ecov_om)</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#sd and rho of ecov processes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stock_om_input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">Ecov_process_pars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  0.000000 -1.203973  1.098612</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span>, <span class="fu">wham</span><span class="fu">:::</span><span class="fu">gen.logit</span><span class="op">(</span><span class="fl">0.5</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="co">#mean, log(sd), logit(0.5)</span></span>
<span><span class="co">#&gt; [1]  0.000000 -1.203973  1.098612</span></span>
<span><span class="co">#size of Ecov_beta</span></span>
<span><span class="va">stock_om_input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">Ecov_beta_R</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="co">#=0.3</span></span>
<span><span class="co">#&gt; [1] 0.3</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stock_om</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">stock_om_input</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sim_Ecov</span> <span class="op">=</span> <span class="va">stock_om</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span>complete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span>, <span class="va">sim_Ecov</span><span class="op">$</span><span class="va">Ecov_x</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"Covariate"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/sim_plot_4e_1.png" style="width:80.0%"></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span>, <span class="va">sim_Ecov</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,,<span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"Recruitment"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/sim_plot_4e_2.png" style="width:80.0%"></p>
<p>See the <a href="https://github.com/timjmiller/wham/devel/vignettes/ex11_catchability.Rmd" class="external-link">catchability
vignette</a> for an example of simulating effects of multiple covariates
on the population. Also see the <a href="https://timjmiller.github.io/wham/articles/ex2_CPI_recruitment.html">CPI
and recruitment vignette</a> for configuring effects on recruitment when
a stock-recruit function is assumed.</p>
</div>
<div class="section level3">
<h3 id="f--estimation-model-with-incorrect-m-assumption">4f. Estimation model with incorrect M assumption<a class="anchor" aria-label="anchor" href="#f--estimation-model-with-incorrect-m-assumption"></a>
</h3>
<p>Here we show how to set up an estimation model that assumes the wrong
natural mortality rate (M = 0.3), but other aspects of the estimation
model are consistent with the operating model. The <code>sim_fn</code>
function will return the simulated population and data and either the
input for the estimating model or the fitted estimation model.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">stock_om_input</span> <span class="op">=</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>    basic_info <span class="op">=</span> <span class="va">basic_info</span>, </span>
<span>    selectivity <span class="op">=</span> <span class="va">selectivity_om</span>, </span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_re_om</span>, </span>
<span>    M <span class="op">=</span> <span class="va">M_om</span>, </span>
<span>  catch_info <span class="op">=</span> <span class="va">catch_info</span>,</span>
<span>  index_info <span class="op">=</span> <span class="va">index_info</span>,</span>
<span>    F <span class="op">=</span> <span class="va">F_info</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">stock_om</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">stock_om_input</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">M_em</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  initial_means <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0.3</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">em_input</span> <span class="op">=</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>    basic_info <span class="op">=</span> <span class="va">basic_info</span>, </span>
<span>    selectivity <span class="op">=</span> <span class="va">selectivity_om</span>, </span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_re_om</span>, </span>
<span>    M <span class="op">=</span> <span class="va">M_em</span>, </span>
<span>  catch_info <span class="op">=</span> <span class="va">catch_info</span>,</span>
<span>  index_info <span class="op">=</span> <span class="va">index_info</span>,</span>
<span>    F <span class="op">=</span> <span class="va">F_info</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_fn</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">om</span>, <span class="va">em_input</span>, <span class="va">do.fit</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">obs_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agg_indices"</span>,<span class="st">"agg_catch"</span>,<span class="st">"catch_paa"</span>,<span class="st">"index_paa"</span>, <span class="st">"Ecov_obs"</span>, <span class="st">"obsvec"</span><span class="op">)</span></span>
<span>    <span class="va">om_sim</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span>complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">em_input</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="va">obs_names</span><span class="op">]</span> <span class="op">=</span> <span class="va">om_sim</span><span class="op">[</span><span class="va">obs_names</span><span class="op">]</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">do.fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">em_fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">em_input</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">em_fit</span>, <span class="va">om_sim</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">em_input</span>,<span class="va">om_sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">simfit</span> <span class="op">=</span> <span class="fu">sim_fn</span><span class="op">(</span><span class="va">stock_om</span>, <span class="va">em_input</span>, do.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">simfit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">SSB</span>,<span class="va">simfit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span>, <span class="va">res</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"SSB"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span>, <span class="va">res</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/sim_fit_4f_1.png" style="width:80.0%"></p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">simfit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">SSB</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">simfit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">log_SSB_FXSPR</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="va">simfit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">simfit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">log_SSB_FXSPR</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span>, <span class="va">res</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">'l'</span>, ylab <span class="op">=</span> <span class="st">"SSB/SSB(F40)"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span>, <span class="va">res</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/sim_fit_4f_2.png" style="width:80.0%"></p>
<p>Both SSB and stock status are biased high when M is specified too
large.</p>
</div>
</div>
<div class="section level2">
<h2 id="closed-loop-simulation">5. Closed-loop simulation<a class="anchor" aria-label="anchor" href="#closed-loop-simulation"></a>
</h2>
<p>Here we will use the same operating and estimating model assumptions
as above where the former is based on M = 0.2 and the latter assumes M =
0.3. To be applicable to a wider class of closed-loop simulations, it
will be useful to create an operating model that includes a base period
and a feedback period and an estimating model that uses data as it
becomes available as time progresses through the feedback period. The
operating model is also updated through the feedback period (redefining
F and population state).</p>
<p>Below, we define some functions for generating F from catch advice:
<code>get_F_from_catch</code>, <code>update_om_F</code>. The first, is
essentially just a solver for the F in the operating model for a catch
that would be provided as management advice using the estimation model,
but note that when the catch advice is not possible to actually take
from the population or implies F greater than 10, F is set at 10.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_F_from_catch</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">om</span>, <span class="va">year</span>, <span class="va">catch</span>, <span class="va">Finit</span> <span class="op">=</span> <span class="fl">0.1</span>, <span class="va">maxF</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">rep</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="va">rep</span></span>
<span>    <span class="va">naa</span> <span class="op">=</span> <span class="va">rep</span><span class="op">$</span><span class="va">NAA</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="va">year</span>,<span class="op">]</span></span>
<span>    <span class="va">Maa</span> <span class="op">=</span> <span class="va">rep</span><span class="op">$</span><span class="va">MAA</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="va">year</span>,<span class="op">]</span></span>
<span>    <span class="va">sel_tot</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">rep</span><span class="op">$</span><span class="va">FAA</span><span class="op">[</span>,<span class="va">year</span>,<span class="op">]</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">rep</span><span class="op">$</span><span class="va">log_FAA_tot</span><span class="op">[</span><span class="va">year</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co">#matrix nfleets x n_ages </span></span>
<span>    <span class="va">waa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">om</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">waa</span><span class="op">[</span><span class="va">om</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">waa_pointer_fleets</span>, <span class="va">year</span>,<span class="op">]</span><span class="op">)</span> <span class="co">#matrix nfleets x n_ages </span></span>
<span>    <span class="va">nfleets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">om</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">waa_pointer_fleets</span><span class="op">)</span></span>
<span>    <span class="va">get_catch</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">log_F</span>, <span class="va">naa</span>, <span class="va">sel</span>, <span class="va">waa</span>, <span class="va">Maa</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">Faa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_F</span><span class="op">)</span> <span class="op">*</span> <span class="va">sel_tot</span></span>
<span>        <span class="va">Zaa</span> <span class="op">=</span> <span class="va">Maa</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">Faa</span>,<span class="fl">2</span>,<span class="va">sum</span><span class="op">)</span></span>
<span>        <span class="va">Catch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>        <span class="kw">for</span><span class="op">(</span><span class="va">a</span>  <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">naa</span><span class="op">)</span><span class="op">)</span> <span class="kw">for</span><span class="op">(</span><span class="va">f</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nfleets</span><span class="op">)</span> <span class="va">Catch</span> <span class="op">=</span> <span class="va">Catch</span> <span class="op">+</span> <span class="va">waa</span><span class="op">[</span><span class="va">f</span>,<span class="va">a</span><span class="op">]</span> <span class="op">*</span> <span class="va">naa</span><span class="op">[</span><span class="va">a</span><span class="op">]</span> <span class="op">*</span> <span class="va">Faa</span><span class="op">[</span><span class="va">f</span>,<span class="va">a</span><span class="op">]</span> <span class="op">*</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">Zaa</span><span class="op">[</span><span class="va">a</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">Zaa</span><span class="op">[</span><span class="va">a</span><span class="op">]</span>;</span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">Catch</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">obj</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">log_F</span><span class="op">)</span> <span class="op">(</span><span class="va">catch</span> <span class="op">-</span> <span class="fu">get_catch</span><span class="op">(</span><span class="va">log_F</span>, <span class="va">naa</span>, <span class="va">sel_tot</span>, <span class="va">waa</span>, <span class="va">Maa</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>    <span class="va">opt</span> <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">Finit</span><span class="op">)</span>, <span class="va">obj</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">opt</span><span class="op">)</span><span class="op">)</span> <span class="va">Fsolve</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">opt</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="kw">else</span> <span class="va">Fsolve</span> <span class="op">=</span> <span class="va">maxF</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">Fsolve</span><span class="op">&gt;</span><span class="fl">10</span><span class="op">)</span> <span class="va">Fsolve</span> <span class="op">=</span> <span class="va">maxF</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Fsolve: "</span>, <span class="va">Fsolve</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">Fsolve</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The second function uses <code>get_F_from_catch</code> to get the F
and replace the F parameters in the operating model and update the
population and observations</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">update_om_F</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">om</span>, <span class="va">year</span>, <span class="va">catch</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">rep</span> <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="va">rep</span> <span class="co">#generate the reported values given the parameters</span></span>
<span>    <span class="va">year_ind</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">om</span><span class="op">$</span><span class="va">years</span> <span class="op">==</span> <span class="va">year</span><span class="op">)</span> <span class="co">#index corresponding to year</span></span>
<span>    <span class="va">Fsolve</span> <span class="op">=</span> <span class="fu">get_F_from_catch</span><span class="op">(</span><span class="va">om</span>, <span class="va">year_ind</span>, <span class="va">catch</span><span class="op">)</span> <span class="co">#find the F for the catch advice</span></span>
<span></span>
<span>    <span class="co">#have to be careful if more than one fleet</span></span>
<span>    <span class="va">FAA</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">rep</span><span class="op">$</span><span class="va">FAA</span><span class="op">[</span>,<span class="va">year_ind</span>,<span class="op">]</span><span class="op">)</span> <span class="co">#n_fleets x n_ages</span></span>
<span>    <span class="va">FAA_tot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">FAA</span>,<span class="fl">2</span>,<span class="va">sum</span><span class="op">)</span></span>
<span>    <span class="va">age_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">FAA_tot</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">FAA_tot</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">selAA</span> <span class="op">=</span> <span class="va">FAA</span><span class="op">/</span><span class="va">FAA_tot</span><span class="op">[</span><span class="va">age_ind</span><span class="op">]</span> <span class="co">#sum(sel_all[i,]) = 1</span></span>
<span>    <span class="va">FAA_catch</span> <span class="op">=</span> <span class="va">Fsolve</span> <span class="op">*</span> <span class="va">selAA</span></span>
<span>    <span class="va">F_fleet</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">FAA_catch</span>, <span class="fl">1</span>, <span class="va">max</span><span class="op">)</span> <span class="co">#full F for each fleet</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">om</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">F_config</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="va">year_ind</span><span class="op">&gt;</span><span class="fl">1</span><span class="op">)</span> <span class="va">om</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">F_pars</span><span class="op">[</span><span class="va">year_ind</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">F_fleet</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">rep</span><span class="op">$</span><span class="va">FAA</span><span class="op">[</span>,<span class="va">year_ind</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span>,<span class="fl">1</span>,<span class="va">max</span><span class="op">)</span><span class="op">)</span> <span class="co">#change the F_dev to produce the right full F</span></span>
<span>        <span class="kw">else</span> <span class="va">om</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">log_F1</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">F_fleet</span><span class="op">)</span> <span class="co">#if year is the first year of the model, change F in year 1</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span><span class="op">{</span> <span class="co">#alternative configuration of F_pars</span></span>
<span>        <span class="va">om</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">F_pars</span><span class="op">[</span><span class="va">year_ind</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">F_fleet</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">om</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">om</span><span class="op">$</span><span class="va">input</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">om</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We need a function for both creating a simulated population and
updating the simulations during the operating model during the feedback
period.</p>
<p>We now turn to defining the estimation model in a way such that the
terminal year can be updated appropriately through the feedback period.
Note that we will be using all of the same assumptions as the operating
model using the <code>make_info</code> function, but an alternative
function with incorrect assumptions could be created and used.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_em_input</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">M_em</span>, <span class="va">sel_em</span>, <span class="va">NAA_em</span>, <span class="va">om_data</span>, <span class="va">em_years</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">info</span> <span class="op">=</span> <span class="fu">make_info</span><span class="op">(</span>base_years <span class="op">=</span> <span class="va">em_years</span><span class="op">)</span> <span class="co">#update the terminal year for the estimation model</span></span>
<span>  <span class="va">ind_em</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">em_years</span><span class="op">)</span> <span class="co">#year indices</span></span>
<span>  <span class="co">#fill in the data from the operating model simulation</span></span>
<span>  <span class="va">info</span><span class="op">$</span><span class="va">catch_info</span><span class="op">$</span><span class="va">agg_catch</span> <span class="op">=</span> <span class="va">om_data</span><span class="op">$</span><span class="va">agg_catch</span><span class="op">[</span><span class="va">ind_em</span>,, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="va">info</span><span class="op">$</span><span class="va">index_info</span><span class="op">$</span><span class="va">agg_indices</span> <span class="op">=</span> <span class="va">om_data</span><span class="op">$</span><span class="va">agg_indices</span><span class="op">[</span><span class="va">ind_em</span>,, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="va">info</span><span class="op">$</span><span class="va">catch_info</span><span class="op">$</span><span class="va">catch_paa</span> <span class="op">=</span> <span class="va">om_data</span><span class="op">$</span><span class="va">catch_paa</span><span class="op">[</span>,<span class="va">ind_em</span>,, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="va">info</span><span class="op">$</span><span class="va">index_info</span><span class="op">$</span><span class="va">index_paa</span> <span class="op">=</span> <span class="va">om_data</span><span class="op">$</span><span class="va">index_paa</span><span class="op">[</span>,<span class="va">ind_em</span>,, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="va">em_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span></span>
<span>    basic_info <span class="op">=</span> <span class="va">info</span><span class="op">$</span><span class="va">basic_info</span>, </span>
<span>    selectivity <span class="op">=</span> <span class="va">sel_em</span>, </span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_em</span>, </span>
<span>    M <span class="op">=</span> <span class="va">M_em</span>, </span>
<span>    catch_info <span class="op">=</span> <span class="va">info</span><span class="op">$</span><span class="va">catch_info</span>,</span>
<span>    index_info <span class="op">=</span> <span class="va">info</span><span class="op">$</span><span class="va">index_info</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">em_input</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We also need a function that will take the estimated model and
generate catch advice from it.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">advice_fn</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">em</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#make 5 year projections using F40. Use average SSB/R and YPR inputs over most recent 5 years</span></span>
<span>  <span class="va">proj_opts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n.yrs<span class="op">=</span><span class="fl">5</span>, use.FXSPR<span class="op">=</span><span class="cn">TRUE</span>, avg.yrs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">em</span><span class="op">$</span><span class="va">years</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="va">em_proj</span> <span class="op">=</span> <span class="fu"><a href="../reference/project_wham.html">project_wham</a></span><span class="op">(</span><span class="va">em</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, proj.opts <span class="op">=</span> <span class="va">proj_opts</span>, MakeADFun.silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co">#projected version of the em</span></span>
<span>  <span class="va">advice</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">em_proj</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">pred_catch</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">em_proj</span><span class="op">$</span><span class="va">years</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,<span class="fl">1</span>,<span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="co">#mean of the projected catch over the next 5 years fishing at F40</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">advice</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">advice</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Finally, we make a function that uses all the other functions and
steps through the feedback period, updating the operating model,
refitting the estimation model, and generating the catch advice.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loop_through_fn</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">om</span>, <span class="va">M_em</span>, <span class="va">selectivity_em</span>, <span class="va">NAA_re_em</span>, <span class="va">assess_years</span>, <span class="va">assess_interval</span> <span class="op">=</span> <span class="va">assess.interval</span>, <span class="va">base_years</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">catches</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="co">#save the catch advice</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">assess_years</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="co">#make the input for the estimation model</span></span>
<span></span>
<span>    <span class="va">em_input</span> <span class="op">=</span> <span class="fu">make_em_input</span><span class="op">(</span><span class="va">M_em</span>, <span class="va">selectivity_em</span>, <span class="va">NAA_re_em</span>, om_data <span class="op">=</span> <span class="va">om</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">data</span>, em_years <span class="op">=</span> <span class="va">base_years</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">:</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="co">#fit the estimation model</span></span>
<span>    <span class="va">em</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">em_input</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, do.osa<span class="op">=</span><span class="cn">FALSE</span>, MakeADFun.silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#no feedback period yet</span></span>
<span>    <span class="co">#make the catch advice</span></span>
<span>    <span class="va">advice</span> <span class="op">=</span> <span class="fu">advice_fn</span><span class="op">(</span><span class="va">em</span><span class="op">)</span></span>
<span>    <span class="va">catches</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">catches</span>, <span class="va">advice</span><span class="op">)</span></span>
<span>    <span class="co">#set the catch for the next assess_interval years</span></span>
<span>    <span class="va">interval.info</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>catch <span class="op">=</span> <span class="va">advice</span>, years <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">assess_interval</span><span class="op">)</span></span>
<span>    <span class="co">#update the operating model with the right Fs and resimulate the data given those Fs</span></span>
<span>    <span class="va">om</span> <span class="op">=</span> <span class="fu">update_om_fn</span><span class="op">(</span><span class="va">om</span>, seed <span class="op">=</span> <span class="fl">123</span>, interval.info <span class="op">=</span> <span class="va">interval.info</span><span class="op">)</span>  </span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>om <span class="op">=</span> <span class="va">om</span>, em  <span class="op">=</span> <span class="va">em</span>, catches <span class="op">=</span> <span class="va">catches</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Create the stock operating model. We will specify a feedback period
of 40 years beyond the 40 year base period. The operating model,
<code>stock_om</code>, is a generic stock with biological inputs defined
in the <code>make_info</code> function. We also remove the
<code>random</code> element so that the inner optimization of random
effects is not performed when calling <code>fit_wham</code> so that any
random effects are kept at simulated values.</p>
<p>Now we define how often to perform an assessment
(<code>assess.interval</code>) and the years they occur
(<code>assess.years</code>). We also do a first call to
<code>update_om_fn</code> to create a simulated population for the
operating model using the default seed 123. This same seed is used
iteratively in the closed loop to keep the same simulated values
throughout the base period and up to each time catch advice is defined.
Running the <code>loop_through_fn</code> function will take a little
while.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">assess.interval</span> <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="va">base.years</span> <span class="op">=</span> <span class="fu">make_info</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">info</span><span class="op">$</span><span class="va">years</span> <span class="co">#no feedback period yet</span></span>
<span><span class="va">first.year</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">base.years</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">terminal.year</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">base.years</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">assess.years</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">terminal.year</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span>,<span class="fl">1</span><span class="op">)</span><span class="op">-</span><span class="va">assess.interval</span>,by <span class="op">=</span> <span class="va">assess.interval</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stock_om</span> <span class="op">=</span> <span class="fu">update_om_fn</span><span class="op">(</span><span class="va">stock_om</span><span class="op">)</span></span>
<span></span>
<span><span class="va">looped_res</span> <span class="op">=</span> <span class="fu">loop_through_fn</span><span class="op">(</span><span class="va">stock_om</span>, M_em <span class="op">=</span> <span class="va">M_em</span>, selectivity_em <span class="op">=</span> <span class="va">selectivity_om</span>, NAA_re_em <span class="op">=</span> <span class="va">NAA_re</span>, assess_years <span class="op">=</span> <span class="va">assess.years</span>, base_years <span class="op">=</span> <span class="va">base.years</span><span class="op">)</span></span>
<span><span class="va">looped_rep</span> <span class="op">&lt;-</span> <span class="va">looped_res</span><span class="op">$</span><span class="va">om</span><span class="op">$</span><span class="va">rep</span></span></code></pre></div>
<p>Once the closed loop simulation is done we can see how the population
size has been changed during the feedback period.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span>, <span class="va">looped_rep</span><span class="op">$</span><span class="va">SSB</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span>, <span class="va">res</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span>, ylab <span class="op">=</span> <span class="st">"SSB"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span>, <span class="va">res</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/looped_rep_5_1.png" style="width:80.0%"></p>
<p>And letâ€™s see what the perception of the population size is relative
to the true reference point (SSB(<span class="math inline">\(F_{40}\)</span>)) compared to the true status.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">looped_rep</span><span class="op">$</span><span class="va">SSB</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">76</span><span class="op">]</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">looped_rep</span><span class="op">$</span><span class="va">log_SSB_FXSPR</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">76</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="va">looped_res</span><span class="op">$</span><span class="va">em</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">SSB</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">76</span><span class="op">]</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">looped_res</span><span class="op">$</span><span class="va">em</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">log_SSB_FXSPR</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">76</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">76</span><span class="op">]</span>, <span class="va">res</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span>, ylab <span class="op">=</span> <span class="st">"SSB/SSB40"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">stock_om</span><span class="op">$</span><span class="va">years</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">76</span><span class="op">]</span>, <span class="va">res</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/devel/vignettes/ex10_plots/looped_rep_5_2.png" style="width:80.0%"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Tim Miller, Brian Stock.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
