<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ex 6: Numbers-at-age / survival deviations as random effects • wham</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Ex 6: Numbers-at-age / survival deviations as random effects">
<meta property="og:description" content="wham">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wham</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.9.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fas fa-book fa-lg"></span>
     
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/index.html">Overview</a>
    </li>
    <li>
      <a href="../articles/ex01_basics.html">Ex 1: The basics</a>
    </li>
    <li>
      <a href="../articles/ex02_CPI_recruitment.html">Ex 2: Recruitment linked to an environmental covariate (Cold Pool Index)</a>
    </li>
    <li>
      <a href="../articles/ex03_projections.html">Ex 3: Projecting / forecasting random effects</a>
    </li>
    <li>
      <a href="../articles/ex4_selectivity.html">Ex 4: Selectivity with time- and age-varying random effects</a>
    </li>
    <li>
      <a href="../articles/ex05_GSI_M.html">Ex 5: Time-varying natural mortality linked to the Gulf Stream Index</a>
    </li>
    <li>
      <a href="../articles/ex06_NAA.html">Ex 6: Numbers-at-age / survival deviations as random effects</a>
    </li>
    <li>
      <a href="../articles/ex07_debug.html">Ex 7: Debugging WHAM models</a>
    </li>
    <li>
      <a href="../articles/ex08_compare.html">Ex 8: Compare ASAP and WHAM model results</a>
    </li>
    <li>
      <a href="../articles/ex09_retro_pred.html">Ex 9: Retrospective predictions</a>
    </li>
    <li>
      <a href="../articles/ex10_simulation.html">Ex 10: Simulations</a>
    </li>
    <li>
      <a href="../articles/ex11_catchability.html">Ex 11: Catchability configurations</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="far fa-file-code fa-lg"></span>
     
    Functions
  </a>
</li>
<li>
  <a href="https://github.com/timjmiller/wham/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
    Source code
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fas fa-bullhorn fa-lg"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/timjmiller/wham/issues/" class="external-link">
    <span class="fas fa-question-circle fa-lg"></span>
     
    Issues
  </a>
</li>
<li>
  <a href="https://www.fisheries.noaa.gov/contact/timothy-miller-phd" class="external-link">
    <span class="fas fa-paper-plane fa-lg"></span>
     
    Contact
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="ex06_NAA_files/kePrint-0.0.1/kePrint.js"></script><link href="ex06_NAA_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ex 6: Numbers-at-age / survival deviations as
random effects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/timjmiller/wham/blob/HEAD/vignettes/ex06_NAA.Rmd" class="external-link"><code>vignettes/ex06_NAA.Rmd</code></a></small>
      <div class="hidden name"><code>ex06_NAA.Rmd</code></div>

    </div>

    
    
<p>In this vignette we walk through an example using the
<code>wham</code> (WHAM = Woods Hole Assessment Model) package to run a
state-space age-structured stock assessment model. WHAM is a
generalization of code written for <a href="https://doi.org/10.1139/cjfas-2015-0339" class="external-link">Miller et al. (2016)</a>
and <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/fog.12236" class="external-link">Xu et
al. (2018)</a>, and in this example we apply WHAM to the same stock,
Southern New England / Mid-Atlantic Yellowtail Flounder.</p>
<p>This is the 6th WHAM example, which blends aspects from <a href="https://timjmiller.github.io/wham/articles/ex1_basics.html">Ex
1</a>, <a href="https://timjmiller.github.io/wham/articles/ex2_CPI_recruitment.html">Ex
2</a>, and <a href="https://timjmiller.github.io/wham/articles/ex5_GSI_M.html">Ex
5</a>. We assume you already have <code>wham</code> installed. If not,
see the <a href="https://timjmiller.github.io/wham/">Introduction</a>.
The simpler 1st example is available as a <a href="https://github.com/timjmiller/wham/blob/master/inst/example_scripts/ex1_basics.R" class="external-link">R
script</a> and <a href="https://timjmiller.github.io/wham/articles/ex1_basics.html">vignette</a>.</p>
<p>As in <a href="https://timjmiller.github.io/wham/articles/ex1_basics.html">example
1</a>:</p>
<ul>
<li>Stock: Southern New England-Mid Atlantic (SNEMA) yellowtail
flounder</li>
<li>Data: 1973-2011, 1 fishery and 2 indices</li>
<li>Age compositions: logistic normal, treating observations of zero as
missing (<code>age_comp = "logistic-normal-miss0"</code>)</li>
<li>Selectivity: age-specific</li>
</ul>
<p>As in <a href="https://timjmiller.github.io/wham/articles/ex2_CPI_recruitment.html">example
2</a>:</p>
<ul>
<li>Beverton-Holt recruitment (<code>recruit_model = 3</code>)</li>
<li>Environmental covariate (ecov) modeled as an AR1 process
(<code>ecov$process_model = 'ar1'</code>)</li>
<li>Compare with and w/o ecov having a “limiting” (carrying capacity)
effect on recruitment (<code>ecov$how = 2</code>)</li>
</ul>
<p>As in <a href="https://timjmiller.github.io/wham/articles/ex4_selectivity.html">example
4</a>:</p>
<ul>
<li>Age-specific selectivity with some ages fixed at 1 (fishery: 4-5,
index1: 4, index2: 2-4)</li>
</ul>
<p>As in <a href="https://timjmiller.github.io/wham/articles/ex5_GSI_M.html">example
5</a>:</p>
<ul>
<li>Environmental covariate: Gulf Stream Index (GSI)</li>
<li>2D AR1 deviations by age and year (random effects)</li>
</ul>
<p>Example 6 highlights WHAM’s options for treating the yearly
transitions in numbers-at-age (i.e. survival):</p>
<ol style="list-style-type: decimal">
<li>Deterministic (as in statistical catch-at-age models, recruitment in
each year estimated as independent fixed effect parameters)</li>
<li>Recruitment deviations (from Bev-Holt expectation) are random
effects
<ul>
<li>independent</li>
<li>AR1 deviations by year (autocorrelated)</li>
</ul>
</li>
<li>“Full state-space model” (survival of all ages are random effects)
<ul>
<li>independent</li>
<li>AR1 deviations by age</li>
<li>AR1 deviations by year</li>
<li>2D AR1 deviations by age and year</li>
</ul>
</li>
</ol>
<div class="section level2">
<h2 id="load-data">1. Load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h2>
<p>Open R and load <code>wham</code> and other useful packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://timjmiller.github.io/wham/">wham</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'tidyr' was built under R version 4.2.3</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'dplyr' was built under R version 4.2.3</span></span></code></pre></div>
<p>For a clean, runnable <code>.R</code> script, look at
<code>ex6_NAA.R</code> in the <code>example_scripts</code> folder of the
<code>wham</code> package. You can run this entire example script
with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wham.dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">find.package</a></span><span class="op">(</span><span class="st">"wham"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wham.dir</span>, <span class="st">"example_scripts"</span>, <span class="st">"ex6_NAA.R"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let’s create a directory for this analysis:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># choose a location to save output, otherwise will be saved in working directory</span></span>
<span><span class="va">write.dir</span> <span class="op">&lt;-</span> <span class="st">"choose/where/to/save/output"</span> <span class="co"># need to change e.g., tempdir(check=TRUE)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">write.dir</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">write.dir</span><span class="op">)</span></span></code></pre></div>
<p>We need the same ASAP data file as in <a href="https://timjmiller.github.io/wham/articles/ex1_basics.html">example
1</a>, and the environmental covariate (Gulf Stream Index, GSI). Read in
<code>ex1_SNEMAYT.dat</code> and <code>GSI.csv</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asap3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_asap3_dat.html">read_asap3_dat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wham.dir</span>,<span class="st">"extdata"</span>,<span class="st">"ex2_SNEMAYT.dat"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">env.dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wham.dir</span>,<span class="st">"extdata"</span>,<span class="st">"GSI.csv"</span><span class="op">)</span>, header<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">env.dat</span><span class="op">)</span></span></code></pre></div>
<p>As in <a href="https://timjmiller.github.io/wham/articles/ex5_GSI_M.html">example
5</a>, the GSI data file does not have a standard error estimate, either
for each yearly observation or one overall value. In such a case, WHAM
can estimate the observation error for the environmental covariate,
either as one overall value, <span class="math inline">\(\sigma_{GSI}\)</span>, or yearly values as random
effects, <span class="math inline">\(\mathrm{log}\sigma_{{GSI}_y} \sim
\mathcal{N}(\mathrm{log}\sigma_{GSI}, \sigma^2_{\sigma_{GSI}})\)</span>.
In this example we choose the simpler option and estimate one
observation error parameter, shared across years.</p>
</div>
<div class="section level2">
<h2 id="specify-models">2. Specify models<a class="anchor" aria-label="anchor" href="#specify-models"></a>
</h2>
<p>Now we specify several models with different options for the
numbers-at-age (NAA) transitions, i.e. survival:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df.mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>NAA_cor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'---'</span>,<span class="st">'iid'</span>,<span class="st">'ar1_y'</span>,<span class="st">'iid'</span>,<span class="st">'ar1_a'</span>,<span class="st">'ar1_y'</span>,<span class="st">'2dar1'</span>,<span class="st">'iid'</span>,<span class="st">'ar1_y'</span>,<span class="st">'iid'</span>,<span class="st">'ar1_a'</span>,<span class="st">'ar1_y'</span>,<span class="st">'2dar1'</span><span class="op">)</span>,</span>
<span>                      NAA_sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'---'</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"rec"</span>,<span class="fl">2</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"rec+1"</span>,<span class="fl">4</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"rec"</span>,<span class="fl">2</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"rec+1"</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      R_how <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"none"</span>,<span class="fl">7</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"limiting-lag-1-linear"</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, stringsAsFactors<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">n.mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">df.mods</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">df.mods</span><span class="op">$</span><span class="va">Model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n.mods</span><span class="op">)</span></span>
<span><span class="va">df.mods</span> <span class="op">&lt;-</span> <span class="va">df.mods</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Model</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># moves Model to first col</span></span></code></pre></div>
<p>Look at the model table:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df.mods</span></span>
<span><span class="co">#&gt;    Model NAA_cor NAA_sigma                 R_how</span></span>
<span><span class="co">#&gt; 1     m1     ---       ---                  none</span></span>
<span><span class="co">#&gt; 2     m2     iid       rec                  none</span></span>
<span><span class="co">#&gt; 3     m3   ar1_y       rec                  none</span></span>
<span><span class="co">#&gt; 4     m4     iid     rec+1                  none</span></span>
<span><span class="co">#&gt; 5     m5   ar1_a     rec+1                  none</span></span>
<span><span class="co">#&gt; 6     m6   ar1_y     rec+1                  none</span></span>
<span><span class="co">#&gt; 7     m7   2dar1     rec+1                  none</span></span>
<span><span class="co">#&gt; 8     m8     iid       rec limiting-lag-1-linear</span></span>
<span><span class="co">#&gt; 9     m9   ar1_y       rec limiting-lag-1-linear</span></span>
<span><span class="co">#&gt; 10   m10     iid     rec+1 limiting-lag-1-linear</span></span>
<span><span class="co">#&gt; 11   m11   ar1_a     rec+1 limiting-lag-1-linear</span></span>
<span><span class="co">#&gt; 12   m12   ar1_y     rec+1 limiting-lag-1-linear</span></span>
<span><span class="co">#&gt; 13   m13   2dar1     rec+1 limiting-lag-1-linear</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="numbers-at-age-options">3. Numbers-at-age options<a class="anchor" aria-label="anchor" href="#numbers-at-age-options"></a>
</h2>
<p>To specify the options for modeling NAA transitions, include an
optional list argument, <code>NAA_re</code>, to the
<code>prepare_wham_input</code> function (see the
<code>prepare_wham_input</code> help page). ASAP3 does not estimate
random effects, and therefore these options are not specified in the
ASAP data file. By default (<code>NAA_re</code> is <code>NULL</code> or
not included), WHAM fits a traditional statistical catch-at-age model
(NAA = predicted NAA for all ages, i.e. survival is deterministic). To
fit a state-space model, we must specify <code>NAA_re</code>.</p>
<p><code>NAA_re</code> is a list with the following entries:</p>
<ul>
<li>
<code>$sigma</code>: Which ages allow deviations from pred_NAA?
Common options are specified with strings.
<ul>
<li>
<code>"rec"</code>: Recruitment deviations are random effects,
survival of all other ages is deterministic</li>
<li>
<code>"rec+1"</code>: Survival of all ages is stochastic (“full
state space model”), with 2 estimated <span class="math inline">\(\sigma_a\)</span>, one for recruitment and one
shared among other ages</li>
</ul>
</li>
<li>
<code>$cor</code>: Correlation structure for the NAA deviations.
Options are:
<ul>
<li>
<code>"iid"</code>: NAA deviations vary by year and age, but
uncorrelated.</li>
<li>
<code>"ar1_a"</code>: NAA deviations correlated by age (AR1).</li>
<li>
<code>"ar1_y"</code>: NAA deviations correlated by year (AR1).</li>
<li>
<code>"2dar1"</code>: NAA deviations correlated by year and age (2D
AR1, as for <span class="math inline">\(M\)</span> in example 5).</li>
</ul>
</li>
</ul>
<p>Alternatively, you can specify a more complex configuration of sigma
parameter estimation via <code>NAA_re$sigma_map</code> as an array
(n_stocks x n_regions x n_ages) of integers (and NAs to fix parameters).
For example (with 1 stock and 1 region here),
<code>NAA_re$sigma = array(c(1,2,2,3,3,3), dim = c(1,1,6))</code> will
estimate three <span class="math inline">\(\sigma\)</span> parameters,
with recruitment (age-1) deviations having their own <span class="math inline">\(\sigma_R\)</span>, ages 2-3 sharing <span class="math inline">\(\sigma_2\)</span>, and ages 4-6 sharing <span class="math inline">\(\sigma_3\)</span>.</p>
<p>To fit model <code>m1</code> (SCAA) we do not have to supply
anything:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NAA_re</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co"># or simply leave out of call to prepare_wham_input</span></span></code></pre></div>
<p>To fit model <code>m3</code>, recruitment deviations are correlated
random effects:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NAA_re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sigma<span class="op">=</span><span class="st">"rec"</span>, cor<span class="op">=</span><span class="st">"ar1_y"</span><span class="op">)</span></span></code></pre></div>
<p>And to fit model <code>m7</code>, numbers at all ages are random
effects correlated by year AND age:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NAA_re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sigma<span class="op">=</span><span class="st">"rec+1"</span>, cor<span class="op">=</span><span class="st">"2dar1"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="linking-recruitment-to-an-environmental-covariate-gsi">4. Linking recruitment to an environmental covariate (GSI)<a class="anchor" aria-label="anchor" href="#linking-recruitment-to-an-environmental-covariate-gsi"></a>
</h2>
<p>As described in <a href="https://timjmiller.github.io/wham/articles/ex2_CPI_recruitment.html">example
2</a>, the environmental covariate options are fed to
<code>prepare_wham_input</code> as a list, <code>ecov</code>. This
example differs from example 2 in that:</p>
<ul>
<li>
<code>ecov$logsigma = "est_1"</code> estimates the GSI observation
error (<span class="math inline">\(\sigma_{GSI}\)</span>, one overall
value for all years like in example 5). The other option is
<code>"est_re"</code> to allow the GSI observation error to have yearly
fluctuations (random effects). The Cold Pool Index in example 2 had
yearly observation errors given, so this was not necessary.</li>
<li>
<code>ecov$R_how = matrix("none",1,1)</code> or
<code>ecov$R_how = NULL</code> estimates the GSI time-series model (AR1)
for models without a GSI-Recruitment effect, in order to compare AIC
with models that do include the effect. Setting
<code>ecov$R_how = matrix("limiting-lag-1-linear,1,1)</code> specifies
that the GSI iyear <span class="math inline">\(t\)</span> affects the
Beverton-Holt <span class="math inline">\(\beta\)</span> parameter
(“limiting” / carrying capacity effect) in year <span class="math inline">\(t+1\)</span> linearly (on log scale).</li>
</ul>
<p>For example, the <code>ecov</code> list for models
<code>m8</code>-<code>m13</code> with the linear GSI-<span class="math inline">\(\beta\)</span> effect:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">ecov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"GSI"</span>,</span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">env.dat</span><span class="op">$</span><span class="va">GSI</span><span class="op">)</span>,</span>
<span>    logsigma <span class="op">=</span> <span class="st">'est_1'</span>, <span class="co"># estimate obs sigma, 1 value shared across years</span></span>
<span>    year <span class="op">=</span> <span class="va">env.dat</span><span class="op">$</span><span class="va">year</span>,</span>
<span>    use_obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, ncol<span class="op">=</span><span class="fl">1</span>, nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">env.dat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="co"># use all obs (=1)</span></span>
<span>    process_model <span class="op">=</span> <span class="st">'ar1'</span>, <span class="co"># "rw" or "ar1"</span></span>
<span>    R_how <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="st">"limiting-lag-1-linear"</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="co"># n_Ecov x n_stocks x n_ages x n_regions</span></span></code></pre></div>
<p>Note that you can set <code>ecov = NULL</code> to fit the model
without environmental covariate data, but here we fit the
<code>ecov</code> data even for models without the GSI effect on
recruitment (<code>m1</code>-<code>m7</code>) so that we can compare
them via AIC (need to have the same data in the likelihood). We
accomplish this by setting <code>ecov$R_how = matrix("none",1,1)</code>
and <code>ecov$process_model = "ar1"</code>.</p>
</div>
<div class="section level2">
<h2 id="run-all-models">5. Run all models<a class="anchor" aria-label="anchor" href="#run-all-models"></a>
</h2>
<p>All models use the same options for expected recruitment
(Beverton-Holt stock-recruit function) and selectivity (age-specific,
with one or two ages fixed at 1). We specify recruitment decoupling only
for consistency with the original implicit assumption in WHAM.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>,<span class="va">n.mods</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n.mods</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">NAA_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cor<span class="op">=</span><span class="va">df.mods</span><span class="op">[</span><span class="va">m</span>,<span class="st">"NAA_cor"</span><span class="op">]</span>, sigma<span class="op">=</span><span class="va">df.mods</span><span class="op">[</span><span class="va">m</span>,<span class="st">"NAA_sigma"</span><span class="op">]</span>, decouple_recruitment <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">NAA_list</span><span class="op">$</span><span class="va">sigma</span> <span class="op">==</span> <span class="st">'---'</span><span class="op">)</span> <span class="va">NAA_list</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span></span>
<span>  <span class="va">ecov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="st">"GSI"</span>,</span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">env.dat</span><span class="op">$</span><span class="va">GSI</span><span class="op">)</span>,</span>
<span>    logsigma <span class="op">=</span> <span class="st">'est_1'</span>, <span class="co"># estimate obs sigma, 1 value shared across years</span></span>
<span>    year <span class="op">=</span> <span class="va">env.dat</span><span class="op">$</span><span class="va">year</span>,</span>
<span>    use_obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, ncol<span class="op">=</span><span class="fl">1</span>, nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">env.dat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="co"># use all obs (=1)</span></span>
<span>    process_model <span class="op">=</span> <span class="st">'ar1'</span>, <span class="co"># "rw" or "ar1"</span></span>
<span>    recruitment_how <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">df.mods</span><span class="op">$</span><span class="va">R_how</span><span class="op">[</span><span class="va">m</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># n_Ecov x n_stocks</span></span>
<span></span>
<span>  <span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span><span class="va">asap3</span>, recruit_model <span class="op">=</span> <span class="fl">3</span>, <span class="co"># Bev Holt recruitment</span></span>
<span>                              model_name <span class="op">=</span> <span class="st">"Ex 6: Numbers-at-age"</span>,</span>
<span>                              selectivity<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"age-specific"</span>,<span class="fl">3</span><span class="op">)</span>, re<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>,<span class="st">"none"</span>,<span class="st">"none"</span><span class="op">)</span>, </span>
<span>                                initial_pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                                fix_pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">6</span>,<span class="fl">4</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                              NAA_re <span class="op">=</span> <span class="va">NAA_list</span>,</span>
<span>                              ecov<span class="op">=</span><span class="va">ecov</span>,</span>
<span>                              age_comp <span class="op">=</span> <span class="st">"logistic-normal-miss0"</span><span class="op">)</span><span class="op">)</span> <span class="co"># logistic normal, treat 0 obs as missing</span></span>
<span></span>
<span>  <span class="co"># Fit model</span></span>
<span>  <span class="va">mods</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input</span>, do.retro<span class="op">=</span><span class="cn">T</span>, do.osa<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Save model</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">mods</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">df.mods</span><span class="op">$</span><span class="va">Model</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,<span class="st">".rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># If desired, do projections</span></span>
<span>  <span class="co"># mod_proj &lt;- project_wham(mod)</span></span>
<span>  <span class="co"># saveRDS(mod_proj, file=paste0(df.mods$Model[m],"_proj.rds"))</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="compare-models">6. Compare models<a class="anchor" aria-label="anchor" href="#compare-models"></a>
</h2>
<p>Get model convergence and stats.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt_conv</span> <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span>
<span><span class="va">ok_sdrep</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">if</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">na_sdrep</span><span class="op">==</span><span class="cn">FALSE</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">na_sdrep</span><span class="op">)</span><span class="op">)</span> <span class="fl">1</span> <span class="kw">else</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">df.mods</span><span class="op">$</span><span class="va">conv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">opt_conv</span><span class="op">)</span></span>
<span><span class="va">df.mods</span><span class="op">$</span><span class="va">pdHess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">ok_sdrep</span><span class="op">)</span></span></code></pre></div>
<p>Only calculate AIC and Mohn’s rho for converged models.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df.mods</span><span class="op">$</span><span class="va">runtime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">runtime</span><span class="op">)</span></span>
<span><span class="va">df.mods</span><span class="op">$</span><span class="va">NLL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">objective</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">not_conv</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="va">df.mods</span><span class="op">$</span><span class="va">conv</span> <span class="op">|</span> <span class="op">!</span><span class="va">df.mods</span><span class="op">$</span><span class="va">pdHess</span></span>
<span><span class="va">mods2</span> <span class="op">&lt;-</span> <span class="va">mods</span></span>
<span><span class="va">mods2</span><span class="op">[</span><span class="va">not_conv</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">df.aic.tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="../reference/compare_wham_models.html">compare_wham_models</a></span><span class="op">(</span><span class="va">mods2</span>, table.opts<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sort<span class="op">=</span><span class="cn">FALSE</span>, calc.rho<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">tab</span><span class="op">)</span></span>
<span><span class="va">df.aic</span> <span class="op">&lt;-</span> <span class="va">df.aic.tmp</span><span class="op">[</span><span class="cn">FALSE</span>,<span class="op">]</span></span>
<span><span class="va">ct</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n.mods</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">not_conv</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">df.aic</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">df.aic</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">df.aic.tmp</span><span class="op">[</span><span class="va">ct</span>,<span class="op">]</span></span>
<span>    <span class="va">ct</span> <span class="op">&lt;-</span> <span class="va">ct</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">df.aic</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">df.aic</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">df.aic</span><span class="op">[</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">df.aic</span><span class="op">[</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, nsmall<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">df.aic</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"NA"</span>,<span class="va">df.aic</span><span class="op">$</span><span class="va">dAIC</span><span class="op">)</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"---"</span></span>
<span><span class="va">df.mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">df.mods</span>, <span class="va">df.aic</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">df.mods</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>Look at results table.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df.mods</span></span></code></pre></div>
<p>Save results table.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">df.mods</span>, file<span class="op">=</span><span class="st">"ex6_table.csv"</span>,quote<span class="op">=</span><span class="cn">F</span>, row.names<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p>Plot output for models that converged.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mods</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">recruit_model</span> <span class="op">=</span> <span class="fl">2</span> <span class="co"># m1 (SCAA) didn't actually fit a Bev-Holt</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="va">not_conv</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/plot_wham_output.html">plot_wham_output</a></span><span class="op">(</span>mod<span class="op">=</span><span class="va">mods</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span>, dir.main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m"</span>,<span class="va">m</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co">#html by default</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="results">7. Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h2>
<p>Two models had very similar AIC and were overwhelmingly supported
relative to the other models (<strong>bold</strong> in table below):
<code>m11</code> (all NAA are random effects with correlation by age,
GSI-Recruitment effect) and <code>m13</code> (all NAA are random effects
with correlation by age and year, GSI-Recruitment effect).</p>
<p>The SCAA and state-space models with independent NAA deviations had
the lowest runtime. Estimating NAA deviations only for age-1,
i.e. recruitment as random effects, broke the Hessian sparseness, making
models <code>m2</code>, <code>m3</code>, <code>m8</code>, and
<code>m9</code> the slowest. Adding correlation structure to the NAA
deviations increased runtime roughly 50% (comparing models
<code>m4</code> with <code>m5</code>-<code>m7</code> and
<code>m10</code> with <code>m11</code>-<code>m13</code>).</p>
<p>All models except for <code>m3</code> converged and successfully
inverted the Hessian to produce SE estimates for (fixed effect)
parameters. Inspection of the fixed effects parameter estimates shows
that 2 of the logit transformed selectivity parameters are large
implying selectivity of 1 for those ages. Fixing those parameters at 1
probably would correct this issue. WHAM stores information about hessian
invertibility in <code>mod$na_sdrep</code> (should be
<code>FALSE</code>), <code>mod$sdrep$pdHess</code> (should be
<code>TRUE</code>). Also, <code>mod$opt$convergence</code> should
generally be <code>0</code>. See <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">stats::nlminb()</a></code> and
<code><a href="https://rdrr.io/pkg/TMB/man/sdreport.html" class="external-link">TMB::sdreport()</a></code> for details.</p>
<p>AIC for model <code>m1</code> is not comparable with other models
because comparing models in which parameters (here, recruitment
deviations) are estimated as fixed effects versus random effects is
messy and marginal AIC is not appropriate. Still, we include
<code>m1</code> to show 1) that WHAM can fit this NAA option, and 2) the
poor retrospective pattern in the status quo assessment. Note that
<code>m2</code> is identical to <code>m1</code> except that recruitment
deviations are random effects instead of fixed effects. The
retrospective patterns are very similar, but <code>m2</code> takes about
3x longer to run.</p>
<table class="table table table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;">
Model
</th>
<th style="text-align:left;">
NAA_cor
</th>
<th style="text-align:left;">
NAA_sigma
</th>
<th style="text-align:left;">
R_how
</th>
<th style="text-align:left;">
Converged
</th>
<th style="text-align:left;">
Pos def Hessian
</th>
<th style="text-align:right;">
Runtime (min)
</th>
<th style="text-align:right;">
NLL
</th>
<th style="text-align:left;">
<span class="math inline">\(\Delta AIC\)</span>
</th>
<th style="text-align:left;">
AIC
</th>
<th style="text-align:left;">
<span class="math inline">\(\rho_{R}\)</span>
</th>
<th style="text-align:left;">
<span class="math inline">\(\rho_{SSB}\)</span>
</th>
<th style="text-align:left;">
<span class="math inline">\(\rho_{\overline{F}}\)</span>
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
m1
</td>
<td style="text-align:left;">
—
</td>
<td style="text-align:left;">
—
</td>
<td style="text-align:left;">
none
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
0.32
</td>
<td style="text-align:right;">
-623.530
</td>
<td style="text-align:left;">
—
</td>
<td style="text-align:left;">
—
</td>
<td style="text-align:left;">
8.818
</td>
<td style="text-align:left;">
0.951
</td>
<td style="text-align:left;">
-0.433
</td>
</tr>
<tr>
<td style="text-align:left;">
m2
</td>
<td style="text-align:left;">
iid
</td>
<td style="text-align:left;">
rec
</td>
<td style="text-align:left;">
none
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
0.92
</td>
<td style="text-align:right;">
-509.511
</td>
<td style="text-align:left;">
512.2
</td>
<td style="text-align:left;">
-875.0
</td>
<td style="text-align:left;">
5.054
</td>
<td style="text-align:left;">
1.023
</td>
<td style="text-align:left;">
-0.437
</td>
</tr>
<tr>
<td style="text-align:left;">
m3
</td>
<td style="text-align:left;">
ar1_y
</td>
<td style="text-align:left;">
rec
</td>
<td style="text-align:left;">
none
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
0.96
</td>
<td style="text-align:right;">
-527.116
</td>
<td style="text-align:left;">
—
</td>
<td style="text-align:left;">
—
</td>
<td style="text-align:left;">
—
</td>
<td style="text-align:left;">
—
</td>
<td style="text-align:left;">
—
</td>
</tr>
<tr>
<td style="text-align:left;">
m4
</td>
<td style="text-align:left;">
iid
</td>
<td style="text-align:left;">
rec+1
</td>
<td style="text-align:left;">
none
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
0.59
</td>
<td style="text-align:right;">
-745.447
</td>
<td style="text-align:left;">
42.3
</td>
<td style="text-align:left;">
-1344.9
</td>
<td style="text-align:left;">
0.423
</td>
<td style="text-align:left;">
0.068
</td>
<td style="text-align:left;">
-0.058
</td>
</tr>
<tr>
<td style="text-align:left;">
m5
</td>
<td style="text-align:left;">
ar1_a
</td>
<td style="text-align:left;">
rec+1
</td>
<td style="text-align:left;">
none
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
0.61
</td>
<td style="text-align:right;">
-759.028
</td>
<td style="text-align:left;">
17.1
</td>
<td style="text-align:left;">
-1370.1
</td>
<td style="text-align:left;">
0.240
</td>
<td style="text-align:left;">
0.030
</td>
<td style="text-align:left;">
-0.039
</td>
</tr>
<tr>
<td style="text-align:left;">
m6
</td>
<td style="text-align:left;">
ar1_y
</td>
<td style="text-align:left;">
rec+1
</td>
<td style="text-align:left;">
none
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
0.73
</td>
<td style="text-align:right;">
-753.699
</td>
<td style="text-align:left;">
27.8
</td>
<td style="text-align:left;">
-1359.4
</td>
<td style="text-align:left;">
0.437
</td>
<td style="text-align:left;">
0.036
</td>
<td style="text-align:left;">
-0.017
</td>
</tr>
<tr>
<td style="text-align:left;">
m7
</td>
<td style="text-align:left;">
2dar1
</td>
<td style="text-align:left;">
rec+1
</td>
<td style="text-align:left;">
none
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
0.73
</td>
<td style="text-align:right;">
-763.264
</td>
<td style="text-align:left;">
10.7
</td>
<td style="text-align:left;">
-1376.5
</td>
<td style="text-align:left;">
0.249
</td>
<td style="text-align:left;">
0.015
</td>
<td style="text-align:left;">
-0.020
</td>
</tr>
<tr>
<td style="text-align:left;">
m8
</td>
<td style="text-align:left;">
iid
</td>
<td style="text-align:left;">
rec
</td>
<td style="text-align:left;">
limiting-lag-1-linear
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
1.02
</td>
<td style="text-align:right;">
-520.571
</td>
<td style="text-align:left;">
492.1
</td>
<td style="text-align:left;">
-895.1
</td>
<td style="text-align:left;">
1.867
</td>
<td style="text-align:left;">
1.026
</td>
<td style="text-align:left;">
-0.426
</td>
</tr>
<tr>
<td style="text-align:left;">
m9
</td>
<td style="text-align:left;">
ar1_y
</td>
<td style="text-align:left;">
rec
</td>
<td style="text-align:left;">
limiting-lag-1-linear
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
1.01
</td>
<td style="text-align:right;">
-531.190
</td>
<td style="text-align:left;">
472.8
</td>
<td style="text-align:left;">
-914.4
</td>
<td style="text-align:left;">
2.293
</td>
<td style="text-align:left;">
1.008
</td>
<td style="text-align:left;">
-0.439
</td>
</tr>
<tr>
<td style="text-align:left;">
m10
</td>
<td style="text-align:left;">
iid
</td>
<td style="text-align:left;">
rec+1
</td>
<td style="text-align:left;">
limiting-lag-1-linear
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
0.59
</td>
<td style="text-align:right;">
-754.897
</td>
<td style="text-align:left;">
25.4
</td>
<td style="text-align:left;">
-1361.8
</td>
<td style="text-align:left;">
0.299
</td>
<td style="text-align:left;">
0.052
</td>
<td style="text-align:left;">
-0.042
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
m11
</td>
<td style="text-align:left;font-weight: bold;">
ar1_a
</td>
<td style="text-align:left;font-weight: bold;">
rec+1
</td>
<td style="text-align:left;font-weight: bold;">
limiting-lag-1-linear
</td>
<td style="text-align:left;font-weight: bold;">
TRUE
</td>
<td style="text-align:left;font-weight: bold;">
TRUE
</td>
<td style="text-align:right;font-weight: bold;">
0.80
</td>
<td style="text-align:right;font-weight: bold;">
-767.876
</td>
<td style="text-align:left;font-weight: bold;">
1.4
</td>
<td style="text-align:left;font-weight: bold;">
-1385.8
</td>
<td style="text-align:left;font-weight: bold;">
0.166
</td>
<td style="text-align:left;font-weight: bold;">
0.021
</td>
<td style="text-align:left;font-weight: bold;">
-0.027
</td>
</tr>
<tr>
<td style="text-align:left;">
m12
</td>
<td style="text-align:left;">
ar1_y
</td>
<td style="text-align:left;">
rec+1
</td>
<td style="text-align:left;">
limiting-lag-1-linear
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
0.67
</td>
<td style="text-align:right;">
-759.243
</td>
<td style="text-align:left;">
18.7
</td>
<td style="text-align:left;">
-1368.5
</td>
<td style="text-align:left;">
0.277
</td>
<td style="text-align:left;">
0.031
</td>
<td style="text-align:left;">
-0.014
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
m13
</td>
<td style="text-align:left;font-weight: bold;">
2dar1
</td>
<td style="text-align:left;font-weight: bold;">
rec+1
</td>
<td style="text-align:left;font-weight: bold;">
limiting-lag-1-linear
</td>
<td style="text-align:left;font-weight: bold;">
TRUE
</td>
<td style="text-align:left;font-weight: bold;">
TRUE
</td>
<td style="text-align:right;font-weight: bold;">
0.86
</td>
<td style="text-align:right;font-weight: bold;">
-769.605
</td>
<td style="text-align:left;font-weight: bold;">
0.0
</td>
<td style="text-align:left;font-weight: bold;">
-1387.2
</td>
<td style="text-align:left;font-weight: bold;">
0.142
</td>
<td style="text-align:left;font-weight: bold;">
0.011
</td>
<td style="text-align:left;font-weight: bold;">
-0.016
</td>
</tr>
</tbody>
</table>
<div class="section level4">
<h4 id="estimated-naa-deviations">Estimated NAA deviations<a class="anchor" aria-label="anchor" href="#estimated-naa-deviations"></a>
</h4>
<ul>
<li>All models estimated positive recruitment (age-1) deviations in the
1970s and 80s (red), and more negative deviations since 1990
(blue).</li>
<li>Models with all numbers-at-age as random effects estimated less
extreme recruitment deviations (lighter red and blue for age 1).</li>
<li>Models with a GSI-Recruitment link also had less extreme recruitment
deviations, because the GSI effect on expected recruitment accounted for
some of this variability.</li>
</ul>
<p>Estimated survival deviations by age (y-axis) and year (x-axis) for
all converged models:</p>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/NAA_devs.png" style="width:95.0%"></p>
</div>
<div class="section level4">
<h4 id="retrospective-patterns">Retrospective patterns<a class="anchor" aria-label="anchor" href="#retrospective-patterns"></a>
</h4>
<p>The base model, <code>m1</code> and all
<code>NAA_re$sigma = "rec"</code> models (<code>m2-m3</code> and
<code>m8-m9</code>) had a severe retrospective pattern for recruitment,
SSB, and <span class="math inline">\(F\)</span> (very high <span class="math inline">\(\rho_R\)</span>). The full state-space model
effectively alleviated this. Adding a GSI-Recruitment link to the
state-space models further reduced <span class="math inline">\(\rho_R\)</span>, but had negligible effects on
<span class="math inline">\(\rho_{SSB}\)</span> and <span class="math inline">\(\rho_{\overline{F}}\)</span>.</p>
<p>The AIC and Mohn’s <span class="math inline">\(\rho\)</span> values
were similar for <code>m11</code> and <code>m13</code>, the models with
lowest AIC.</p>
<p>The plots below compare retrospective patterns from the base model
(<code>m1</code>, left) to those from the full model (<code>m13</code>,
right).</p>
<div class="section level6">
<h6 id="numbers-at-age-naa">Numbers-at-age, NAA<a class="anchor" aria-label="anchor" href="#numbers-at-age-naa"></a>
</h6>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m1_NAA_retro_relative.png" style="width:45.0%"><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m13_NAA_retro_relative.png" style="width:45.0%"></p>
</div>
<div class="section level6">
<h6 id="spawning-stock-biomass-ssb">Spawning stock biomass, SSB<a class="anchor" aria-label="anchor" href="#spawning-stock-biomass-ssb"></a>
</h6>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m1_SSB_retro_relative.png" style="width:45.0%"><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m13_SSB_retro_relative.png" style="width:45.0%"></p>
</div>
<div class="section level6">
<h6 id="fishing-mortality-f">Fishing mortality, F<a class="anchor" aria-label="anchor" href="#fishing-mortality-f"></a>
</h6>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m1_Fbar_retro_relative.png" style="width:45.0%"><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m13_Fbar_retro_relative.png" style="width:45.0%"></p>
</div>
</div>
<div class="section level4">
<h4 id="estimated-gsi">Estimated GSI<a class="anchor" aria-label="anchor" href="#estimated-gsi"></a>
</h4>
<p>Models with a GSI-Recruitment link estimated higher observation error
and more smoothing of the GSI than those without. Compare the confidence
intervals for <code>m7</code> (left, no GSI-Recruitment link), to those
for <code>m13</code> (right, with GSI-Recruitment link).</p>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m7_Ecov_1.png" style="width:45.0%" alt="Gulf Stream Index (GSI) time-series model, m7."><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m13_Ecov_1.png" style="width:45.0%" alt="Gulf Stream Index (GSI) time-series model, m13."></p>
</div>
<div class="section level4">
<h4 id="stock-status">Stock status<a class="anchor" aria-label="anchor" href="#stock-status"></a>
</h4>
<p>The state-space models, with or without the GSI-Recruitment link,
estimated similar but slightly exaggerated trends in <span class="math inline">\(SSB\)</span> and <span class="math inline">\(F\)</span> compared to the base model. Left: <span class="math inline">\(SSB\)</span> and <span class="math inline">\(F\)</span> trends from the base model,
<code>m1</code>. Right: <span class="math inline">\(SSB\)</span> and
<span class="math inline">\(F\)</span> trends from the state-space model
without GSI effect, <code>m7</code>.</p>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m1_SSB_F_trend.png" style="width:45.0%"><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m7_SSB_F_trend.png" style="width:45.0%"></p>
<p>Adding the GSI-Recruitment link to the state-space model did not
impact the probability that the stock was overfished or experiencing
overfishing in the final year, 2016 (<code>m7</code> w/o GSI, left;
<code>m13</code> w/ GSI, right).</p>
<p><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m7_Kobe_status.png" style="width:45.0%" alt="Kobe status plot, m7."><img src="https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex6_plots/m13_Kobe_status.png" style="width:45.0%" alt="Kobe status plot, m13."></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Tim Miller, Brian Stock.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
