<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ex 12: Multiple stocks and region and movement • wham</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Ex 12: Multiple stocks and region and movement">
<meta property="og:description" content="wham">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wham</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.1.0.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fas fa-book fa-lg"></span>
     
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/index.html">Overview</a>
    </li>
    <li>
      <a href="../articles/ex01_basics.html">Ex 1: The basics</a>
    </li>
    <li>
      <a href="../articles/ex02_CPI_recruitment.html">Ex 2: Recruitment linked to an environmental covariate (Cold Pool Index)</a>
    </li>
    <li>
      <a href="../articles/ex03_projections.html">Ex 3: Projecting / forecasting random effects</a>
    </li>
    <li>
      <a href="../articles/ex4_selectivity.html">Ex 4: Selectivity with time- and age-varying random effects</a>
    </li>
    <li>
      <a href="../articles/ex05_GSI_M.html">Ex 5: Time-varying natural mortality linked to the Gulf Stream Index</a>
    </li>
    <li>
      <a href="../articles/ex06_NAA.html">Ex 6: Numbers-at-age / survival deviations as random effects</a>
    </li>
    <li>
      <a href="../articles/ex07_debug.html">Ex 7: Debugging WHAM models</a>
    </li>
    <li>
      <a href="../articles/ex08_compare.html">Ex 8: Compare ASAP and WHAM model results</a>
    </li>
    <li>
      <a href="../articles/ex09_retro_pred.html">Ex 9: Retrospective predictions</a>
    </li>
    <li>
      <a href="../articles/ex10_simulation.html">Ex 10: Simulations</a>
    </li>
    <li>
      <a href="../articles/ex11_catchability.html">Ex 11: Catchability configurations</a>
    </li>
    <li>
      <a href="../articles/ex12_multistock.html">Ex 12: Multiple stocks, regions</a>
    </li>
    <li>
      <a href="../articles/ex13_no_ASAP.html">Ex 13: WHAM without ASAP</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="far fa-file-code fa-lg"></span>
     
    Functions
  </a>
</li>
<li>
  <a href="https://github.com/timjmiller/wham/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
    Source code
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fas fa-bullhorn fa-lg"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/timjmiller/wham/issues/" class="external-link">
    <span class="fas fa-question-circle fa-lg"></span>
     
    Issues
  </a>
</li>
<li>
  <a href="https://www.fisheries.noaa.gov/contact/timothy-miller-phd" class="external-link">
    <span class="fas fa-paper-plane fa-lg"></span>
     
    Contact
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ex 12: Multiple stocks and region and
movement</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/timjmiller/wham/blob/HEAD/vignettes/ex12_multistock.Rmd" class="external-link"><code>vignettes/ex12_multistock.Rmd</code></a></small>
      <div class="hidden name"><code>ex12_multistock.Rmd</code></div>

    </div>

    
    
<p>In this vignette we show how to create inputs for 2 stocks and 2
regions with 5 seasons within the year and configure movement that is
constant or with age or annual random effects.</p>
<ol style="list-style-type: decimal">
<li><p>Load wham library and set up a directory for work</p></li>
<li>
<p>Create inputs and fitting model for a two stock model without
movement</p>
<ul>
<li>Load asap files</li>
<li>create arguments to <code>prepare_wham_input</code> and model
component functions (e.g., <code>set_move</code>)</li>
<li>examine components of unfitted and fitted model</li>
</ul>
</li>
<li>
<p>Create inputs and fitting model with movement of 1 stock</p>
<ul>
<li>Load asap files</li>
<li>create arguments to <code>prepare_wham_input</code> and model
component functions</li>
<li>examine components of unfitted and fitted model</li>
</ul>
</li>
<li>
<p>Create inputs and fitting model with age-varying movement</p>
<ul>
<li>Load asap files</li>
<li>create arguments to <code>prepare_wham_input</code> and model
component functions</li>
<li>examine components of unfitted and fitted model</li>
</ul>
</li>
<li>
<p>Create inputs and fitting model with time-varying movement</p>
<ul>
<li>Load asap files</li>
<li>create arguments to <code>prepare_wham_input</code> and model
component functions</li>
<li>examine components of unfitted and fitted model</li>
</ul>
</li>
<li>
<p>Create inputs and fitting model with a prior distribution on
movement</p>
<ul>
<li>create arguments to <code>prepare_wham_input</code> and model
component functions</li>
<li>examine components of input and fitted model</li>
</ul>
</li>
</ol>
<div class="section level2">
<h2 id="getting-started">1. Getting started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h2>
<p>If you have not already installed <code>wham</code>, see the <a href="https://timjmiller.github.io/wham/">Introduction</a> for
instructions.</p>
<p>Open R and load the <code>wham</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://timjmiller.github.io/wham/">wham</a></span><span class="op">)</span></span></code></pre></div>
<p>Create a directory for this analysis:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># choose a location to save output, otherwise will be saved in working directory</span></span>
<span><span class="va">write.dir</span> <span class="op">&lt;-</span> <span class="st">"choose/where/to/save/output"</span> <span class="co">#e.g., tempdir(check=TRUE)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">write.dir</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">write.dir</span><span class="op">)</span></span></code></pre></div>
<p>For a clean, runnable <code>.R</code> script, look at
<code>ex12_multistock.R</code> in the <code>example_scripts</code>
folder of the <code>wham</code> package. You can run this entire example
script with:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wham.dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">find.package</a></span><span class="op">(</span><span class="st">"wham"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wham.dir</span>, <span class="st">"example_scripts"</span>, <span class="st">"ex12_multistock.R"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-inputs-to-fit-a-two-stock-model-without-movement">2. Creating inputs to fit a two stock model without movement<a class="anchor" aria-label="anchor" href="#creating-inputs-to-fit-a-two-stock-model-without-movement"></a>
</h2>
<p>Read the ASAP3 .dat files into R and create an input. Note any number
of asap dat files can be read in and by default a model will be created
with a stock and its own region for each .dat file and no connectivity.
So, one could fit the same single stock model a number times
simultaneously by reading in the same dat file multiple times.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path_to_examples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package<span class="op">=</span><span class="st">"wham"</span><span class="op">)</span></span>
<span><span class="va">diff_stocks_asap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_asap3_dat.html">read_asap3_dat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">path_to_examples</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"north.dat"</span>,<span class="st">"south.dat"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">selectivity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"age-specific"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span>, n_selblocks <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    fix_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span>,<span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">8</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">8</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">8</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    initial_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.2</span><span class="op">)</span><span class="op">)</span>,<span class="fl">8</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">7</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">diff_stocks_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span><span class="va">diff_stocks_asap</span>, selectivity <span class="op">=</span> <span class="va">selectivity</span><span class="op">)</span></span>
<span><span class="va">fit_diff_stocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">diff_stocks_input</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro<span class="op">=</span> <span class="cn">FALSE</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We will use <code>diff_stocks_asap</code> throughout this vignette,
but changing movement and parameter assumptions along the way.</p>
</div>
<div class="section level2">
<h2 id="creating-inputs-to-fit-a-two-stock-model-with-movement-for-1-stock">3. Creating inputs to fit a two stock model with movement for 1
stock<a class="anchor" aria-label="anchor" href="#creating-inputs-to-fit-a-two-stock-model-with-movement-for-1-stock"></a>
</h2>
<p>We will use the asap inputs, but we will also specify some elements
of the <code>basic_info</code> argument to
<code>prepare_wham_input</code> that provides a list of various “basic”
model structure information:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input</span> <span class="op">&lt;-</span> <span class="va">diff_stocks_input</span></span>
<span><span class="va">basic_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n_stocks <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_stocks</span>,</span>
<span>    n_regions <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_regions</span>,</span>
<span>    <span class="va">region_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"North_r"</span>, <span class="st">"South_r"</span><span class="op">)</span>, <span class="co">#n_regions</span></span>
<span>    <span class="va">stock_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"North_s"</span>, <span class="st">"South_s"</span><span class="op">)</span>, <span class="co">#n_stocks</span></span>
<span>    ages <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_ages</span>,</span>
<span>    n_fleets <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fleets</span>,</span>
<span>    maturity <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">mature</span>, <span class="co">#n_stocks x n_years x n_ages</span></span>
<span>    years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>,</span>
<span>    waa <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">waa</span>, <span class="co">#any no. x n_years x n_ages</span></span>
<span>    waa_pointer_ssb <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">waa_pointer_ssb</span>, <span class="co">#n_stocks</span></span>
<span>    spawn_regions <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">spawn_regions</span> <span class="co">#n_stocks</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We define the first stock to be a northern stock and stock 2 to be a
southern stock. The spatial regions have the same name and order. Note
we can supply names for regions, stocks, fleets (in
<code>catch_info$fleet_names</code>), and indices (in
<code>index_info$index_names</code>) that are used in generating more
descriptive model output.</p>
<p>Below we specify the seasonal information: number, what fraction of
the year for each season, which season spawning occurs, and the fraction
of the year where spawning occurs.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basic_info</span><span class="op">$</span><span class="va">n_seasons</span> <span class="op">&lt;-</span> <span class="fl">5L</span></span>
<span><span class="va">basic_info</span><span class="op">$</span><span class="va">fracyr_seasons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">5</span>,<span class="fl">5</span><span class="op">)</span> <span class="co">#does not have to be equal lengths.</span></span>
<span><span class="va">basic_info</span><span class="op">$</span><span class="va">spawn_seasons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">basic_info</span><span class="op">$</span><span class="va">fracyr_SSB</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">fracyr_SSB</span><span class="co">#-2/5 # this should be fixed in prepare_wham_input</span></span></code></pre></div>
<p>Below we specify which ages can be where on January 1 of each year.
Currently, WHAM only models spawning and recruitment for each stock in
only 1 region (natal homing). So that the northern stock only spawns in
the northern region. Spawning age fish may occur in other regions during
the spawning season, but are assumed to not be part of the spawning
population. We are going to assume movement only for the northern
stock.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_ages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span></span>
<span><span class="co">#each age other than 1 (recruitment) for north stock can be in either region on Jan 1 </span></span>
<span><span class="va">basic_info</span><span class="op">$</span><span class="va">NAA_where</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="va">n_ages</span><span class="op">)</span><span class="op">)</span> <span class="co">#n_stocks x n_regions x n_ages</span></span>
<span><span class="va">basic_info</span><span class="op">$</span><span class="va">NAA_where</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co">#stock 1, age 1 can't be in region 2 on Jan 1</span></span>
<span><span class="va">basic_info</span><span class="op">$</span><span class="va">NAA_where</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co">#stock 2, any age can't be in region 1 2 on Jan 1 (stock 2 doesn't move) </span></span></code></pre></div>
<p>Next, we configure 5 equal length seasons and define movement only
for the northern stock (<code>stock_move</code>) to be separable (and
sequential to) from mortality (<code>separable = TRUE</code>). We use
<code>must_move</code> and <code>can_move</code> (0s and 1s) to
constrain movement between regions each season. When values of
<code>must_move = 1</code> fish must move from the region, so
must_move[1,3,2] = 1 would mean that the northern stock must move from
the south at the end of the 3rd season. <code>can_move=1</code> defines
that movement is possible to a particular region from another, so
can_move[1,4,2]=0 would mean that the northern stock cannot move to the
south at the end of the 4th season. Note that the when the last two
indices are the same e.g., <code>can_move[1,2,r,r]</code> where
<code>r</code> is any region is not used because the probability of
staying in each region is calculated as 1 - the sum of the probabilities
of movement out of the region.</p>
<p>We will define that north stock fish must move back to region 1 at
the end of the second season before spawning in the third season and
that fish can only move out of the north in the other seasons.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_seasons</span> <span class="op">&lt;-</span> <span class="va">basic_info</span><span class="op">$</span><span class="va">n_seasons</span></span>
<span><span class="va">move</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>stock_move <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>,<span class="cn">FALSE</span><span class="op">)</span>, <span class="co">#n_stocks</span></span>
<span>    separable <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#north moves, south doesn't</span></span>
<span><span class="va">move</span><span class="op">$</span><span class="va">must_move</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>,dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="va">n_seasons</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>   <span class="co">#n_stocks x n_seasons x n_regions</span></span>
<span><span class="co">#if north stock in region 2 (south) must move back to region 1 (north) at the end of interval 2 before spawning</span></span>
<span><span class="va">move</span><span class="op">$</span><span class="va">must_move</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co">#stock 1 must move at the end of season 2 from region 2</span></span>
<span><span class="va">move</span><span class="op">$</span><span class="va">can_move</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="va">n_seasons</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">move</span><span class="op">$</span><span class="va">can_move</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co">#only north stock can move in seasons outside of spawning and only from north to south (except at the end of season 2)</span></span>
<span><span class="va">move</span><span class="op">$</span><span class="va">can_move</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co">#north stock can (and must) move in second/last season prior to spawning back to north</span></span></code></pre></div>
<p>We also can provide initial (or fixed) values for movement
parameters. Below we initialize the mean or constant movement
probabilities/proportions to all be 0.3 and
<code>mean_model = "stock_constant"</code> defines constant movement
parameters between each region, but that they differ by stock. This
difference between stocks is necessary here because we want to define no
movement at all for the southern stock.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="va">n_seasons</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mus</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n_seasons</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.3</span> <span class="co">#initial value proportion moving to south = 0.3 (mean of prior)</span></span>
<span><span class="va">mus</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n_seasons</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.3</span> <span class="co">#initial value proportion north to south = 0.3 (will not be used)</span></span>
<span><span class="va">move</span><span class="op">$</span><span class="va">mean_vals</span> <span class="op">&lt;-</span> <span class="va">mus</span> </span>
<span><span class="va">move</span><span class="op">$</span><span class="va">mean_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="st">"stock_constant"</span>, <span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Although not necessary because we are using
<code>diff_stocks_asap</code>, below we define the fixed natural
mortality for each stock and intiial values for fully selected fishing
mortality for the fleets and catchability for the indices. We define
process errrors on both recruitment and annual transitions of older ages
and we specify an equilibrium assumption for the initial numbers at age.
This simplyfing equilibrium assumption (rather than estimating each
initial abundance at age as a separate parameter) may often be necessary
because of the lack of information on abundance of individuals in each
region for each stock.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MAA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">M_re</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="va">MAA</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">MAA</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,,<span class="op">]</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">Mpars</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">ages</span><span class="op">)</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">M_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial_MAA <span class="op">=</span> <span class="va">MAA</span><span class="op">)</span></span>
<span></span>
<span><span class="va">F_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>F <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">basic_info</span><span class="op">$</span><span class="va">years</span><span class="op">)</span>, <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_fleets</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">q_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial_q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1e-6</span>, <span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">n_indices</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">NAA_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="st">"rec+1"</span>, N1_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"equilibrium"</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">input_move</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span><span class="va">diff_stocks_asap</span>,</span>
<span>    basic_info <span class="op">=</span> <span class="va">basic_info</span>,</span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_list</span>,</span>
<span>    selectivity <span class="op">=</span> <span class="va">selectivity</span>, </span>
<span>    M <span class="op">=</span> <span class="va">M_in</span>, </span>
<span>    F <span class="op">=</span> <span class="va">F_in</span>, </span>
<span>    catchability <span class="op">=</span> <span class="va">q_in</span>,</span>
<span>    move <span class="op">=</span> <span class="va">move</span><span class="op">)</span></span></code></pre></div>
<p>Now we create an unfit model just to examine how the individuals for
the northern stock are moving and surviving each season.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nofit_move</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input_move</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span>, do.brps <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>WHAM calculates and reports various items in the <code>$rep</code>
element of the model, including the probability transition matrices for
each season in the terminal year
(<code>$rep$seasonal_Ps_terminal</code>, an array with dimensions:
n_stocks x n_seasons x n_ages x n_states x n_states). When there are two
stocks, 2 regions and 4 fleets, there will be 7 possible states in this
order: - alive in each region (2) - dead due to fishing by each fleet
(4) - dead due to natural mortality (1) The rows correspond to the state
at the beginning of the season and the columns correspond to the state
at the end of the season. So for the first season for the northern stock
(stock 1):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#first season</span></span>
<span><span class="va">nofit_move</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">seasonal_Ps_terminal</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">8</span>,,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;           [,1]      [,2]       [,3]       [,4]       [,5]       [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] 0.5731115 0.2456192 0.05438077 0.05438077 0.00000000 0.00000000 0.0725077</span></span>
<span><span class="co">#&gt; [2,] 0.0000000 0.8187308 0.00000000 0.00000000 0.05438077 0.05438077 0.0725077</span></span>
<span><span class="co">#&gt; [3,] 0.0000000 0.0000000 1.00000000 0.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [4,] 0.0000000 0.0000000 0.00000000 1.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [5,] 0.0000000 0.0000000 0.00000000 0.00000000 1.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [6,] 0.0000000 0.0000000 0.00000000 0.00000000 0.00000000 1.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [7,] 0.0000000 0.0000000 0.00000000 0.00000000 0.00000000 0.00000000 1.0000000</span></span></code></pre>
<p>Note we have specifed the PTM for first season and age 8, but the
PTMs are the same across ages because as we configured in the input.
There is a probability of surviving and occuring in the same region at
the end of the season = 0.573 and a probability of being in the south =
0.246. There are only non-zero probabilities of capture in the northern
fleets (row 1) because movement is sequential to survival and occurs at
the end of the season. Starting the season in the south, there is no
probabilty of surviving and being in the north because movement to the
north is not allowed.</p>
<p>For season 2 we can see that all fish in the south must move back to
the north as we specified.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#second season</span></span>
<span><span class="va">nofit_move</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">seasonal_Ps_terminal</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">8</span>,,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;           [,1] [,2]       [,3]       [,4]       [,5]       [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] 0.8187308    0 0.05438077 0.05438077 0.00000000 0.00000000 0.0725077</span></span>
<span><span class="co">#&gt; [2,] 0.8187308    0 0.00000000 0.00000000 0.05438077 0.05438077 0.0725077</span></span>
<span><span class="co">#&gt; [3,] 0.0000000    0 1.00000000 0.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [4,] 0.0000000    0 0.00000000 1.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [5,] 0.0000000    0 0.00000000 0.00000000 1.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [6,] 0.0000000    0 0.00000000 0.00000000 0.00000000 1.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [7,] 0.0000000    0 0.00000000 0.00000000 0.00000000 0.00000000 1.0000000</span></span></code></pre>
<p>We can also see that there is no movement for the southern stock.
They probabilities proportions in each state are always defined by the
second row of the matrix because they never move from the south:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#1st season, southern stock</span></span>
<span><span class="va">nofit_move</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">seasonal_Ps_terminal</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">8</span>,,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;           [,1]      [,2]       [,3]       [,4]       [,5]       [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] 0.8187308 0.0000000 0.05438077 0.05438077 0.00000000 0.00000000 0.0725077</span></span>
<span><span class="co">#&gt; [2,] 0.0000000 0.8187308 0.00000000 0.00000000 0.05438077 0.05438077 0.0725077</span></span>
<span><span class="co">#&gt; [3,] 0.0000000 0.0000000 1.00000000 0.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [4,] 0.0000000 0.0000000 0.00000000 1.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [5,] 0.0000000 0.0000000 0.00000000 0.00000000 1.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [6,] 0.0000000 0.0000000 0.00000000 0.00000000 0.00000000 1.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [7,] 0.0000000 0.0000000 0.00000000 0.00000000 0.00000000 0.00000000 1.0000000</span></span></code></pre>
<p>WHAM also calculates and reports the annual probability transition
matrices (<code>$rep$annual_Ps</code>, an array with dimensions:
n_stocks x n_years x n_ages x n_states x n_states) that are used to
define the numbers at age on January 1 each year and we can see that
indeed they are equal to the product of the seasonal matrices:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">7</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="va">P</span> <span class="op">&lt;-</span> <span class="va">P</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">nofit_move</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">seasonal_Ps_terminal</span><span class="op">[</span><span class="fl">1</span>,<span class="va">i</span>,<span class="fl">8</span>,,<span class="op">]</span></span>
<span><span class="va">P</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;           [,1]      [,2]       [,3]       [,4]       [,5]       [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] 0.1802609 0.1876185 0.16894875 0.16894875 0.02068742 0.02068742 0.2528482</span></span>
<span><span class="co">#&gt; [2,] 0.1802609 0.1876185 0.08340172 0.08340172 0.10623444 0.10623444 0.2528482</span></span>
<span><span class="co">#&gt; [3,] 0.0000000 0.0000000 1.00000000 0.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [4,] 0.0000000 0.0000000 0.00000000 1.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [5,] 0.0000000 0.0000000 0.00000000 0.00000000 1.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [6,] 0.0000000 0.0000000 0.00000000 0.00000000 0.00000000 1.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [7,] 0.0000000 0.0000000 0.00000000 0.00000000 0.00000000 0.00000000 1.0000000</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nofit_move</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">annual_Ps</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">33</span>,<span class="fl">8</span>,,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;           [,1]      [,2]       [,3]       [,4]       [,5]       [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] 0.1802609 0.1876185 0.16894875 0.16894875 0.02068742 0.02068742 0.2528482</span></span>
<span><span class="co">#&gt; [2,] 0.1802609 0.1876185 0.08340172 0.08340172 0.10623444 0.10623444 0.2528482</span></span>
<span><span class="co">#&gt; [3,] 0.0000000 0.0000000 1.00000000 0.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [4,] 0.0000000 0.0000000 0.00000000 1.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [5,] 0.0000000 0.0000000 0.00000000 0.00000000 1.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [6,] 0.0000000 0.0000000 0.00000000 0.00000000 0.00000000 1.00000000 0.0000000</span></span>
<span><span class="co">#&gt; [7,] 0.0000000 0.0000000 0.00000000 0.00000000 0.00000000 0.00000000 1.0000000</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#for the southern stock</span></span>
<span><span class="va">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">7</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="va">P</span> <span class="op">&lt;-</span> <span class="va">P</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">nofit_move</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">seasonal_Ps_terminal</span><span class="op">[</span><span class="fl">2</span>,<span class="va">i</span>,<span class="fl">8</span>,,<span class="op">]</span></span>
<span><span class="va">P</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] 0.3678794 0.0000000 0.1896362 0.1896362 0.0000000 0.0000000 0.2528482</span></span>
<span><span class="co">#&gt; [2,] 0.0000000 0.3678794 0.0000000 0.0000000 0.1896362 0.1896362 0.2528482</span></span>
<span><span class="co">#&gt; [3,] 0.0000000 0.0000000 1.0000000 0.0000000 0.0000000 0.0000000 0.0000000</span></span>
<span><span class="co">#&gt; [4,] 0.0000000 0.0000000 0.0000000 1.0000000 0.0000000 0.0000000 0.0000000</span></span>
<span><span class="co">#&gt; [5,] 0.0000000 0.0000000 0.0000000 0.0000000 1.0000000 0.0000000 0.0000000</span></span>
<span><span class="co">#&gt; [6,] 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 1.0000000 0.0000000</span></span>
<span><span class="co">#&gt; [7,] 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 1.0000000</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nofit_move</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">annual_Ps</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">33</span>,<span class="fl">8</span>,,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] 0.3678794 0.0000000 0.1896362 0.1896362 0.0000000 0.0000000 0.2528482</span></span>
<span><span class="co">#&gt; [2,] 0.0000000 0.3678794 0.0000000 0.0000000 0.1896362 0.1896362 0.2528482</span></span>
<span><span class="co">#&gt; [3,] 0.0000000 0.0000000 1.0000000 0.0000000 0.0000000 0.0000000 0.0000000</span></span>
<span><span class="co">#&gt; [4,] 0.0000000 0.0000000 0.0000000 1.0000000 0.0000000 0.0000000 0.0000000</span></span>
<span><span class="co">#&gt; [5,] 0.0000000 0.0000000 0.0000000 0.0000000 1.0000000 0.0000000 0.0000000</span></span>
<span><span class="co">#&gt; [6,] 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 1.0000000 0.0000000</span></span>
<span><span class="co">#&gt; [7,] 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 1.0000000</span></span></code></pre>
<p>To fit the model, first we will fix the movement parameter from south
to north for the northern stock because it is never used. No movement is
allowed by <code>$can_move</code> except the complete movement of any
fish in the south back to the north at the end of the second season is
forced by <code>$must_move</code>. Unfortunately,
<code>prepare_wham_input</code> and <code>set_move</code> are not clever
enough to figure this out yet so, we must manually edit the
<code>$map</code> that is used for the <code>map</code> argument to
<code><a href="https://rdrr.io/pkg/TMB/man/MakeADFun.html" class="external-link">TMB::MakeADFun</a></code> (see help file for
<code><a href="https://rdrr.io/pkg/TMB/man/MakeADFun.html" class="external-link">TMB::MakeADFun</a></code> for more details of the map argument).
<code>input$par$trans_mu</code> is the array (n_stocks x n_seasons x
n_regions x n_regions-1) of movement parameters estimated on a
transformed (dependent on the whether movement is sequential or
simultaneous to mortality) scale that does not require bounds. So
<code>trans_mu[1,,2,1]</code> is the movement parameters for stock 1
(northern) across all seasons (blank index is equal to specifying all
seasons 1:5) moving from region 2 (south) to region 1 (north).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">input_move</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">trans_mu</span> <span class="co">#n_stocks x n_seasons x n_regions x n_regions - 1</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">input_move</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">trans_mu</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">input_move</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">trans_mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p>There are only n_regions - 1 estimated parameters for movement for
each stock, season, and starting region because the probabity of being
in a given region is 1 - the sum of the probabilities of being in each
of the other regions.</p>
<p>Now, we can fit the model and WHAM reports the movement rates
estimates as probabilities/proportions (conditional on surviving the
seasonal interval) in <code>$rep$mu</code>, an array (n_stocks x n_ages
x n_seasons x n_years x n_regions x n_regions). The single estimated
seasonal movement parameter is from north to south for the northern
stock and is the estimate is very small (0.0093).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_move</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input_move</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, do.brps <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#estimated movement</span></span>
<span><span class="va">fit_move</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">8</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.009262632</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="fitting-a-model-with-age-varying-movement">4. Fitting a model with age-varying movement<a class="anchor" aria-label="anchor" href="#fitting-a-model-with-age-varying-movement"></a>
</h2>
<p>Next we will demonstrate estimation of age-varying movement as random
effects. We configure random effects across age using the
<code>age_re</code> element of the <code>move</code> argument to
<code>prepare_wham_input</code> and <code>set_move</code>.
<code>age_re</code> is a character matrix (n_regions x n_regions - 1)
defining whether to model age-varying random effects for each movement
parameter. There is an interaction with <code>$can_move</code> and
<code>$mean_model</code> to define whether random effects (like the mean
fixed effects) are common across stocks, seasons, etc, and are excluded
for regions where movement is not allowed. We will specify uncorrelated
randome effects (<code>iid</code>) for the movement from north to
south:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#age-specific RE</span></span>
<span><span class="va">move_age</span> <span class="op">&lt;-</span> <span class="va">move</span></span>
<span><span class="va">move_age</span><span class="op">$</span><span class="va">age_re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="st">"none"</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">move_age</span><span class="op">$</span><span class="va">age_re</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"iid"</span></span>
<span></span>
<span><span class="va">input_move_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span><span class="va">diff_stocks_asap</span>,</span>
<span>    basic_info <span class="op">=</span> <span class="va">basic_info</span>,</span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_list</span>,</span>
<span>    selectivity <span class="op">=</span> <span class="va">selectivity</span>, </span>
<span>    M <span class="op">=</span> <span class="va">M_in</span>, </span>
<span>    F <span class="op">=</span> <span class="va">F_in</span>, </span>
<span>    catchability <span class="op">=</span> <span class="va">q_in</span>,</span>
<span>    move <span class="op">=</span> <span class="va">move_age</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">input_move_age</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">mu_re</span><span class="op">)</span><span class="op">)</span> <span class="co">#+1 for NAs</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 9</span></span></code></pre>
<p>In our model only movement from the north to the south for the
northern stock is allowed and it is constant across seasons so there
will only be 8 random effects estimated and applied to all seasons
(other map values are NA hence 9 unique values).</p>
<p>Creating the unfit model still performs the inner optimization of the
random effects given the initial values of the fixed effects, so we can
see that in fact there are different movement rates by age</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nofit_move_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input_move_age</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span>, do.brps <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#age-specific movement rates assuming initial values for fixed effects</span></span>
<span><span class="va">nofit_move_age</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.95778313 0.04871062 0.07582687 0.14948953 0.04344924 0.04013569 0.06542450</span></span>
<span><span class="co">#&gt; [8] 0.71981107</span></span></code></pre>
<p>Fitting the model, again we must fix the movement rate parameters
from south to north, and we can see that the minimized negative
log-likelihood is lower allowing the age-varying random effects:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">input_move_age</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">trans_mu</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">input_move_age</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">trans_mu</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">input_move_age</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">trans_mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">input_move_age</span><span class="op">$</span><span class="va">par</span> <span class="op">&lt;-</span> <span class="va">fit_move</span><span class="op">$</span><span class="va">parList</span></span>
<span><span class="va">fit_move_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input_move_age</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, do.brps <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_move</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">obj</span>,<span class="va">fit_move_age</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">obj</span><span class="op">)</span></span>
<span><span class="co">#different</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 3000.896 2998.567</span></span></code></pre>
<p>And the estimated movement rates for each age are all very small like
the mean in the constant model except that age 8+ jumps up to almost
0.02:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#age-specific movement rates</span></span>
<span><span class="va">fit_move_age</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.001615753 0.002705349 0.004283258 0.004370262 0.004373432 0.003817055</span></span>
<span><span class="co">#&gt; [7] 0.003568121 0.019743605</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="fitting-a-model-with-time-varying-movement">5. Fitting a model with time-varying movement<a class="anchor" aria-label="anchor" href="#fitting-a-model-with-time-varying-movement"></a>
</h2>
<p>Next we will demonstrate estimation of year-varying movement as
random effects. Configuring random effects across year is similar to
age. Like <code>$age_re</code>, <code>$year_re</code> is a character
matrix (n_regions x n_regions - 1) defining whether to model
year-varying random effects for each movement parameter. There is an
interaction with <code>$can_move</code> and <code>$mean_model</code> to
define whether random effects (like the mean fixed effects) are common
across stocks, seasons, etc, and are excluded for regions where movement
is not allowed. We will specify uncorrelated randome effects
(<code>iid</code>) for the movement from north to south:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#year-specific RE</span></span>
<span><span class="va">move_year</span> <span class="op">&lt;-</span> <span class="va">move</span></span>
<span><span class="va">move_year</span><span class="op">$</span><span class="va">year_re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="st">"none"</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">move_year</span><span class="op">$</span><span class="va">year_re</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"iid"</span></span>
<span></span>
<span><span class="va">input_move_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span><span class="va">diff_stocks_asap</span>,</span>
<span>    basic_info <span class="op">=</span> <span class="va">basic_info</span>,</span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_list</span>,</span>
<span>    selectivity <span class="op">=</span> <span class="va">selectivity</span>, </span>
<span>    M <span class="op">=</span> <span class="va">M_in</span>, </span>
<span>    F <span class="op">=</span> <span class="va">F_in</span>, </span>
<span>    catchability <span class="op">=</span> <span class="va">q_in</span>,</span>
<span>    move <span class="op">=</span> <span class="va">move_year</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">input_move_year</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">mu_re</span><span class="op">)</span><span class="op">)</span> <span class="co">#+1 for NAs</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 34</span></span></code></pre>
<p>There will be n_years = 33 random effects estimated and applied to
all seasons (other map values are NA hence 34 unique values).</p>
<p>Creating the unfit model still performs the inner optimization of the
random effects given the initial values of the fixed effects, so we can
see that in fact there are different movement rates by year</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nofit_move_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input_move_year</span>, do.fit <span class="op">=</span> <span class="cn">FALSE</span>, do.brps <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#year-specific movement rates assuming initial values for fixed effects</span></span>
<span><span class="va">nofit_move_year</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">8</span>,<span class="fl">1</span>,,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;  [1] 0.977658316 0.916290634 0.935465907 0.947032457 0.942886244 0.952737096</span></span>
<span><span class="co">#&gt;  [7] 0.955271979 0.941363997 0.944740880 0.916477535 0.913576456 0.833965222</span></span>
<span><span class="co">#&gt; [13] 0.015695348 0.574161417 0.678061883 0.648547566 0.023100255 0.019701635</span></span>
<span><span class="co">#&gt; [19] 0.016110491 0.930937979 0.011090300 0.574918902 0.011525765 0.007294352</span></span>
<span><span class="co">#&gt; [25] 0.006467400 0.003884297 0.004724370 0.004253718 0.002759932 0.003336883</span></span>
<span><span class="co">#&gt; [31] 0.004775211 0.005615943 0.025153004</span></span></code></pre>
<p>Fitting the model (again we must fix the movement rate parameters
from south to north), we can see that the minimized negative
log-likelihood allowing the year-varying random effects is the same as
that when movement is constant:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">input_move_year</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">trans_mu</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">input_move_year</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">trans_mu</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">input_move_year</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">trans_mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">input_move_year</span><span class="op">$</span><span class="va">par</span> <span class="op">&lt;-</span> <span class="va">fit_move</span><span class="op">$</span><span class="va">parList</span></span>
<span><span class="va">fit_move_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input_move_year</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, do.brps <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_move</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">obj</span>, <span class="va">fit_move_year</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">obj</span><span class="op">)</span></span>
<span><span class="co">#the same</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 3000.896 3000.896</span></span></code></pre>
<p>The random effects collapse to annual movement rates to the constant
value and there estimated variance approaches 0 (<code>mu_repars</code>
is an array holding variance and correlation parameters for movement
random effects):</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_move_year</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">8</span>,<span class="fl">1</span>,,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;  [1] 0.009262631 0.009262632 0.009262632 0.009262632 0.009262632 0.009262631</span></span>
<span><span class="co">#&gt;  [7] 0.009262632 0.009262632 0.009262631 0.009262632 0.009262631 0.009262631</span></span>
<span><span class="co">#&gt; [13] 0.009262632 0.009262631 0.009262632 0.009262632 0.009262631 0.009262632</span></span>
<span><span class="co">#&gt; [19] 0.009262632 0.009262632 0.009262632 0.009262632 0.009262631 0.009262631</span></span>
<span><span class="co">#&gt; [25] 0.009262631 0.009262631 0.009262631 0.009262632 0.009262632 0.009262631</span></span>
<span><span class="co">#&gt; [31] 0.009262632 0.009262632 0.009262632</span></span></code></pre>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#the log(sd) of the RE</span></span>
<span><span class="va">fit_move_year</span><span class="op">$</span><span class="va">parList</span><span class="op">$</span><span class="va">mu_repars</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] -7.520988</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="fitting-a-model-with-prior-distribution-for-movement">6. Fitting a model with prior distribution for movement<a class="anchor" aria-label="anchor" href="#fitting-a-model-with-prior-distribution-for-movement"></a>
</h2>
<p>Because WHAM currently has no ability to include tagging data to
inform movement and mortality rates, options to configure prior
distributions for mean movement rates are provided. The prior
distributions ideally would be based on results from external analyses
of tagging data, but here we just assume a distribution to demonstrate
the option. Prior distributions are all normal distributions on the
transformed scale of the movement paramters We specify the central
tendency using the <code>$mean_vals</code> of the <code>move</code>
argument and <code>$prior_sigma</code> is the standard devation. The
<code>mean_vals</code> are not transformed but the normal distribution
will have a mean assumed with the appropriate transformation. For
example, here with the sequential assumption for movement the parameters
are all additive logit transformed so the movement rates have a logistic
normal distribution (like the age composition likelihood option) where
the same logit transformation is applied to the mean for the expectation
of the normal distribution. The estimated movement rate will be a random
effect with this distribution and used to define the estimated mean
(transformed) movement.</p>
<p>Different prior distributions could be used for each stock, season
and region to region parameter (<code>$use_prior</code> is a n_stocks x
n_seasons x n_regions x n_regions-1 array). Because our model assumed
movement is constant across seasons, we need to make sure there is only
one random effect applied to all seasons. We wil assume the prior mean
is defined by the starting value already provided above (0.3) and
standard deviation of the normal prior is 0.2.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#just use prior once because it is constant over all seasons.</span></span>
<span><span class="va">move_prior</span> <span class="op">&lt;-</span> <span class="va">move</span></span>
<span><span class="va">move_prior</span><span class="op">$</span><span class="va">use_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="va">n_seasons</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#movement is not used in first season, but the parameter is constant across seasons. Could use it in any (single) season</span></span>
<span><span class="va">move_prior</span><span class="op">$</span><span class="va">use_prior</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># sd on logit scale</span></span>
<span><span class="va">move_prior</span><span class="op">$</span><span class="va">prior_sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="va">n_seasons</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">move_prior</span><span class="op">$</span><span class="va">prior_sigma</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">move_prior</span><span class="op">$</span><span class="va">mean_vals</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="co">#transform (inverse logit here) of mean of the prior distribution </span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.3</span></span></code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_move_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_wham_input.html">prepare_wham_input</a></span><span class="op">(</span><span class="va">diff_stocks_asap</span>,</span>
<span>    basic_info <span class="op">=</span> <span class="va">basic_info</span>,</span>
<span>    NAA_re <span class="op">=</span> <span class="va">NAA_list</span>,</span>
<span>    selectivity <span class="op">=</span> <span class="va">selectivity</span>, </span>
<span>    M <span class="op">=</span> <span class="va">M_in</span>, </span>
<span>    F <span class="op">=</span> <span class="va">F_in</span>, </span>
<span>    catchability <span class="op">=</span> <span class="va">q_in</span>,</span>
<span>    move <span class="op">=</span> <span class="va">move_prior</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">input_move_prior</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">mu_re</span><span class="op">)</span><span class="op">)</span>, <span class="co">#+1 for NAs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">input_move_prior</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">mu_prior_re</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co">#+1 for NAs</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 1 2</span></span></code></pre>
<p>We can see there are no age- or time-varying random effects for
movement and there is a single random effect for mean movement
(<code>mu_prior_re</code>)</p>
<p>Again we must fix the movement rate parameters from south to
north:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">input_move_prior</span><span class="op">$</span><span class="va">par</span><span class="op">$</span><span class="va">trans_mu</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">input_move_prior</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">trans_mu</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">input_move_prior</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">trans_mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p>To expedite the fit, we can start at the parameters estimated by the
model with movement estimated without the prior.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#fixed effect estimated in fit_move, use all estimates except the estimated mean movement parameter.</span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fit_move</span><span class="op">$</span><span class="va">parList</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fit_move</span><span class="op">$</span><span class="va">parList</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="st">"trans_mu"</span><span class="op">]</span></span>
<span><span class="va">input_move_prior</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fit_move</span><span class="op">$</span><span class="va">parList</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span></span>
<span><span class="va">fit_move_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_wham.html">fit_wham</a></span><span class="op">(</span><span class="va">input_move_prior</span>, do.osa <span class="op">=</span> <span class="cn">FALSE</span>, do.retro <span class="op">=</span> <span class="cn">FALSE</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span>, do.brps <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#estimated movement</span></span>
<span><span class="va">fit_move</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.009262632</span></span></code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_move_prior</span><span class="op">$</span><span class="va">rep</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.1848194</span></span></code></pre>
<p>When using the prior, the estimated movement rate is much greater
because of the 0.3 used to parameterize the mean of the prior and the
small standard deviation assumed.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Tim Miller, Brian Stock.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
